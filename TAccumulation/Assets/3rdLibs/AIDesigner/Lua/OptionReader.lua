---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by chaoguan.
--- DateTime: 2021/7/20 12:52
---

local CustomSettings = CS.AIDesigner.Define.CustomSettings
local AIDesignerLogicUtility = CS.AIDesigner.AIDesignerLogicUtility
local DefineTables = {}
local VarTypeCache = {}
local SpTag = "."
---@return table
local function Split(str, reps)
    local tab = {}
    string.gsub(str, '[^' .. reps .. ']+', function(w)
        table.insert(tab, w)
    end)
    return tab
end

local function IsTable(tab)
    return tab and type(tab) == 'table'
end

require(AIDesignerLogicUtility.LuaFilePathLegalization(CustomSettings.AIDefinePath))
for index = 0, CustomSettings.DefinePath.Length - 1 do
    local path = AIDesignerLogicUtility.LuaFilePathLegalization(CustomSettings.DefinePath[index])
    local ok, tab = pcall(require, path)
    if ok then
        if IsTable(tab) then
            table.insert(DefineTables, tab)
        end
    else
        print(string.format("[OptionReader]Task文件路径不存在或加载失败，请检查！文件路径=%s", path))
    end
end

local function LoadOptions(varType, callBack)
    if not varType or '' == varType then
        callBack(nil, nil)
        return
    end

    if VarTypeCache[varType] then
        callBack(VarTypeCache[varType][1], VarTypeCache[varType][2])
        return
    end
    
    

    local keys = nil
    local values = nil
    local tab = _G[varType]
    if tab == nil and type(varType)=="string" then
        if string.find(varType,SpTag,1,true) then
            local varTypes = Split(varType,SpTag)
            local _t = table.remove(varTypes,1)
            tab = _G[_t]
            if tab then
                for k,v in ipairs(varTypes) do
                    if tab~=nil then
                        tab = tab[v]
                    end
                end
            end
        end
    end
    
    if not IsTable(tab) then
        local varTypes = Split(varType,SpTag)
        for _, sub in ipairs(DefineTables) do
            tab = sub[table.remove(varTypes,1)]
            if tab then
                for k ,v in ipairs(varTypes) do
                    if not tab then
                        break
                    end
                    tab = tab[v]
                end
                if IsTable(tab) then
                    break
                end
            end
        end
    end
    if IsTable(tab) then
        keys = {}
        values = {}
        local keyType = nil
        local valueType = nil
        for _key, _value in pairs(tab) do
            if not keyType then
                keyType = type(_key)
            end
            if not valueType then
                valueType = type(_value)
            end
            if keyType ~= 'string' or (valueType ~= 'number' and valueType ~= 'string') or keyType ~= type(_key) or valueType ~= type(_value) then
                callBack(nil, nil)
            else
                if valueType == 'number' then
                    local index = #values
                    while true do
                        if index < 1 or _value > values[index] then
                            table.insert(keys, index + 1, _key .. ' (' .. _value .. ')')
                            table.insert(values, index + 1, _value)
                            break
                        end
                        index = index - 1
                    end
                else
                    table.insert(keys, _key)
                    table.insert(values, _value)
                end
            end
        end
    end

    VarTypeCache[varType] = { keys, values }
    callBack(keys, values)
end

return LoadOptions