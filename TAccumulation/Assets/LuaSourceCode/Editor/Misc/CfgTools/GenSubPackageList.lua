---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jianxin.
--- DateTime: 2021/4/8 11:43
---


---分包表结构处理
local GenSubPackageList = class("GenSubPackageList", BaseCfgHandler)

function GenSubPackageList:Execute()
    Define = require("Runtime.System.X3Game.GameConst.Define")
    local file_path = LUA_CFG_PATH .. "SubModule.lua"
    local subPackage_source_list = self:GetSubModuleMap()
    local module_path = LUA_CFG_PATH .. "Module.lua"
    local module_source_list = self:GetModuleMap(subPackage_source_list)
    self:WriteFile(file_path, subPackage_source_list)
    self:WriteFile(module_path, module_source_list)
end

function GenSubPackageList:GetModuleMap(subPackageTab)
    local moduleMap = LuaCfgMgr.GetAll("Module")
    for k, v in pairs(subPackageTab) do
        if moduleMap[v.ModuleID] ~= nil then
            if moduleMap[v.ModuleID].SubModule == nil then
                moduleMap[v.ModuleID].SubModule = {}
            end
            if not table.indexof(moduleMap[v.ModuleID].SubModule, v.ID) then
                local tab = moduleMap[v.ModuleID].SubModule
                tab[#tab + 1] = v.ID
            end
        end

    end
    for k, v in pairs(moduleMap) do
        table.sort(v.SubModule, function(a, b)
            return a < b
        end)
    end
    return moduleMap
end

function GenSubPackageList:GetSubModuleMap()
    local subModelMap = LuaCfgMgr.GetAll("SubModule")
    local subModelTab = {}
    for k, v in pairs(subModelMap) do
        local data = v
        if data.KeyArray == nil then
            local dataTab = self:GetSubModule(data)
            for k1, v1 in pairs(dataTab) do
                subModelTab[k1] = v1
            end
        else
            subModelTab[k] = v
        end
    end
    return subModelTab
end

-----
---@param id  int 功能类型
---@param data cfg.SubModule 功能细分
---@param Key string 关键值
---@return
function GenSubPackageList:GetSubModleData(id, data, Key)
    local tab = {}
    tab.Type = data.Type
    tab.SubType = data.SubType
    tab.TableName = data.TableName
    tab.KeyArray = {}
    tab.KeyArray[#tab.KeyArray + 1] = tostring(Key)
    tab.ModuleID = data.ModuleID
    tab.ID = id
    return tab.ID, tab
end

---@param data cfg.SubModule 功能细分
function GenSubPackageList:GetSubModule(data)
    local strTab = string.split(data.TableName, "|")
    local tableStr = strTab[1]
    local tableStrTab = string.split(tableStr, ".")
    local tableName = tableStrTab[2]
    local keyName = tableStrTab[3]
    local subModelTab = {}
    local datas = LuaCfgMgr.GetAll(tableName)
    local count = 0
    local tab = {}
    for k, v in pairs(datas) do
        tab[#tab + 1] = v
    end
    table.sort(tab, function(a, b)
        return a[keyName] > b[keyName]
    end)
    for i, v in ipairs(tab) do
        if v.IsBasePackage == 0 then
            count = count + 1
            local packageID = data.ID + count
            local key, tab = self:GetSubModleData(packageID, data, v[keyName])
            subModelTab[key] = tab
        end
    end
    return subModelTab
end

return GenSubPackageList