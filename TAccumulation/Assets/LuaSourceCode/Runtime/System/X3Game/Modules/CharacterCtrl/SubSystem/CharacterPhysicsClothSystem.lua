---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2023/10/20 11:27
---

---@class CharacterPhysicsClothSystem : CharacterSubSystem
local CharacterPhysicsClothSystem = class("CharacterPhysicsClothSystem", require("Runtime.System.X3Game.Modules.CharacterCtrl.SubSystem.CharacterSubSystem"))
---@type CharacterCtrlEnum
local CharacterCtrlEnum = require("Runtime.System.X3Game.Modules.CharacterCtrl.CharacterCtrlEnum")

function CharacterPhysicsClothSystem:ctor()
    self.super.ctor(self)
    ---@type CharacterCtrlEnum.SystemType
    self.systemType = CharacterCtrlEnum.SystemType.BoneChainRope
    ---@type string 部件名
    self.partName = nil
    ---@type string 骨骼名
    self.boneName = nil
    ---@type float
    self.rangeX = 0
    ---@type float
    self.rangeY = 0
    ---@type float 抖动力度
    self.force = 1
    ---@type InputComponent
    self.inputComponent = nil
    ---@type Transform
    self.boneTransform = nil
    ---@type CS.X3.Character.X3PhysicsCloth C#段用来处理骨骼抖动的Mono脚本
    self.physicsCloth = nil
end

---初始化逻辑
function CharacterPhysicsClothSystem:OnInit()
    self.super.OnInit(self)
end

---
---@param partName string 部件名
---@param boneName string 骨骼名
---@param rangeX float 点击范围X
---@param rangeY float 点击范围Y
function CharacterPhysicsClothSystem:Start(partName, boneName, rangeX, rangeY)
    self.partName = partName
    self.boneName = boneName
    self.rangeX = rangeX
    self.rangeY = rangeY
    self.boneTransform = CharacterMgr.GetBoneByName(self.gameObject, self.boneName, true)

    self.inputComponent = GameObjClickUtil.Get(self.gameObject)
    self.inputComponent:SetCtrlType(GameObjClickUtil.CtrlType.CLICK)
    self.inputComponent:SetClickType(GameObjClickUtil.ClickType.POS)
    self.inputComponent:SetDelegate(self)

    self.physicsCloth = CharacterMgr.EnsureSubSystem(self.gameObject, CS.X3.Character.ISubsystem.Type.PhysicsCloth)
end

---
function CharacterPhysicsClothSystem:Stop()
    if self.inputComponent then
        self.inputComponent:SetTouchEnable(false)
    end
end

---ClickBg点击
function CharacterPhysicsClothSystem:OnTouchClick(pos)
    if self.physicsCloth and GameObjectUtil.IsNull(self.boneTransform) == false then
        local initWorldPos = GameObjectUtil.GetPosition(self.boneTransform.gameObject)
        local initScreenPos = GlobalCameraMgr.WorldToScreenPoint(initWorldPos)
        if Mathf.Abs(pos.x - initScreenPos.x) <= self.rangeX
                and Mathf.Abs(pos.y - initScreenPos.y) <= self.rangeY then
            local clickWorldPos = CameraUtil.GetSceneCamera():ScreenToWorldPoint(Vector3.Temp(pos.x, pos.y, 0))
            local direction = Vector3.Temp(clickWorldPos.x - initWorldPos.x, clickWorldPos.y - initWorldPos.y, clickWorldPos.z - initWorldPos.z)
            direction = direction.normalized
            --TODO YG让橘猫改下接口
            pcall(self.ApplyForce, self, self.partName, self.boneName, direction * self.force)
        end
    end
end

---@param partName string
---@param boneName string
---@param force
function CharacterPhysicsClothSystem:ApplyForce(partName, boneName, force)
    self.physicsCloth:ApplyForce(partName, boneName, force)
end

---
function CharacterPhysicsClothSystem:OnClear()
    GameObjClickUtil.Remove(self.gameObject)
    self.physicsCloth = nil
    self.super.OnClear(self)
end

return CharacterPhysicsClothSystem