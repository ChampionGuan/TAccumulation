---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by kan.
--- DateTime: 2021/11/10 15:48
---用于播放聊天中的语音
---


local MobileChatVoiceHandle = class("MobileChatVoiceHandle", UICtrl)

function MobileChatVoiceHandle:Init()

    self.curGUID = nil        --当前播放的唯一ID
    self.curChatID = nil      --当前播放的对话ID
    self.curVoiceName = nil   --当前播放的声音名称
    self.curPlayProgress = 0  --当前播放声音的进度
end

---播放语音
function MobileChatVoiceHandle:_PlayVoice()
    WwiseMgr.LoadBank(WwiseMgr.GetBankNameWithEventName(self.curVoiceName))

    local progressCB = function(name,time)
        print("========================",time)
        self.curPlayProgress = time
        EventMgr.Dispatch("Mobile_Msg_VoiceProgress",self.curGUID,self.curChatID,self.curPlayProgress)
    end

    local completeCB = function(strEventName,param1)
        --需要param1给一个回调判断是正常执行还是中断执行的回调
        if strEventName ~= self.curVoiceName then return end
        EventMgr.Dispatch("Mobile_Msg_VoiceFinish",self.curGUID,self.curChatID)
        self:_ClearData()
    end

    WwiseMgr.PlaySound2D(self.curVoiceName, completeCB, progressCB)
end

---播放语音
---@param guiID int 消息唯一ID
---@param chatID int 对话ID
---@param strVoiceName string 语音名称
function MobileChatVoiceHandle:Play(guiID,chatID,strVoiceName)
    self:Stop()
    if guiID == self.curGUID and chatID == self.curChatID then --播放相同的节点认为是停止
        self:_ClearData()
        return
    end

    self.curGUID = guiID
    self.curChatID = chatID

    if self.curVoiceName ~= strVoiceName then
        self.curVoiceName = strVoiceName
        self:_PlayVoice()
    end
end

---停止播放语音
function MobileChatVoiceHandle:Stop()
    if self.curVoiceName == nil then return end

    EventMgr.Dispatch("Mobile_Msg_VoiceCancel",self.curGUID,self.curChatID)
    WwiseMgr.StopSound2D(self.curVoiceName)
end

---清除当前数据
function MobileChatVoiceHandle:_ClearData()
    self.curGUID = nil
    self.curChatID = nil
    self.curVoiceName = nil
    self.curPlayProgress = 0
end

---清除当前内容，在退出时使用
function MobileChatVoiceHandle:Clear()
    self:Stop()
    self:_ClearData()
end

return MobileChatVoiceHandle