---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by deling.
--- DateTime: 2022/12/17 10:48
---

local localPhotoDB = require "Runtime.System.X3Game.Modules.Photo.LocalPhotoDB"

----用于记录图片md5值及文件名对照 --本质功能是防止图片被替换

local UrlImageDBUtil = {}
local this = UrlImageDBUtil
local FieldType = X3DataConst.X3DataField.UrlImageData
local DownloadUtil = CS.X3Game.Download.DownloadUtils


---初始化数据库
--function UrlImageDBUtil.Init()
--    this.dbCtrl = DBMgr.GetCtrl(DB_NAME)
--end


function UrlImageDBUtil.Test()
    local source = {
        [FieldType.originName] = "O",
        [FieldType.fakeName] = "F",
        [FieldType.checkString] = "11D2FF"

    }
    local data = X3DataMgr.Add(X3DataConst.X3Data.UrlImageData, source)
end

function UrlImageDBUtil.Log()
    local condition = {
        [X3DataConst.X3DataField.UrlImageData.originName] = "O",
    }
    local data = X3DataMgr.GetByCondition(X3DataConst.X3Data.UrlImageData,
            condition)

    Debug.LogError("UrlImageDBUtil LOG ", data:GetCheckString())
end


---这里需要过滤掉Bin，不然可能会走两遍 --或者想个更好的办法，避免两遍
---@param originName string 原本的名称
---@param biz UrlImgMgr.BizType 业务类别
function UrlImageDBUtil.GetFakeName(originName, biz)
    ---这里可以再做下后缀替换 ---各个业务可以再拼下前缀，免得数据库中冲突
    if(string.endswith(originName, ".bin") or string.endswith(originName, ".bins")) then
        return originName
    end
    originName = string.split(originName, ".")[1]--string.replace(originName, ".jpg", "")

    return string.format("%s%s", originName, ".bin")
end

---@param originName string 原本的名称
---@param filePath string 伪装名称的文件路径
---@param biz UrlImgMgr.BizType 业务类型
function UrlImageDBUtil.CheckFile(originName, filePath, biz)
    originName = UrlImgMgr.GetBaseName(originName)

    if(UrlImgMgr.CheckProcessFile(filePath)) then
        Debug.LogWarning("UrlImageDBUtil.CheckFile Wait ", filePath, " file in process!")
        return false
    end
    ---@clase UrlImageData
    local data = nil
    data = X3DataMgr.Get(X3DataConst.X3Data.UrlImageData, originName)
    ---不在数据库中的视为检测失败。否则不应触发检测
    if(not data) then
        Debug.LogWarning("UrlImageDBUtil.CheckFile ERROR(本地数据库没有记录却存在本地文件) ", originName, " path ", filePath, " biz ", biz)
        ---为了防止数据库丢失的情况，增加相册业务的保底
        if(biz == UrlImgMgr.BizType.PhotoAlbum) then
            local photoData = localPhotoDB.SelectPhotoByName(originName)
            if(photoData) then
                local md5String = photoData.Md5String
                local curValue = DownloadUtil.GetFileMD5(filePath)
                local result = md5String == curValue
                Debug.LogWarning("UrlImageDBUtil.CheckFile 触发保底 保底值为: ", md5String, " 文件值为： ", curValue)
                return result
            end
        end
        return false
    else
        local saveValue = data:GetCheckString()
        local curValue = DownloadUtil.GetFileMD5(filePath)
        local result = saveValue == curValue
        if(not result) then
            Debug.LogWarning("UrlImageDBUtil.CheckFile False ", originName, " path ", filePath, " saveValue ", saveValue, " curValue ", curValue)
        end
        return result
    end
end

---更新数据库中本地图片的信息
---@param originName string 原本的名称
---@param fakeName string 伪装后的名字
---@param fakeFilePath string 伪装名称的文件路径
---@return string Md5值
function UrlImageDBUtil.UpdateData(originName, fakeName, fakeFilePath)
    if(UrlImgMgr.CheckProcessFile(fakeFilePath)) then
        Debug.LogWarning("UrlImageDBUtil.CheckFile Wait ", fakeFilePath, " file in process!")
        return false
    end
    originName = UrlImgMgr.GetBaseName(originName)
    local data = X3DataMgr.Get(X3DataConst.X3Data.UrlImageData, originName)
    local md5String = DownloadUtil.GetFileMD5(fakeFilePath)
    Debug.LogWarning("UrlImageDBUtil.UpdateData ", originName, " fakeName ", fakeName, " fakeFilePath ", fakeFilePath, " data ", data, " md5String ", md5String, "- ", string.len(originName))
    if(string.isnilorempty(md5String)) then
        Debug.LogWarning("UrlImageDBUtil.UpdateData ERROR(获取文件md5失败) ", originName, " fakeName ", fakeName, " fakeFilePath ", fakeFilePath)
        return false
    end
    if (not data) then
        local source = {
            originName = originName,
            fakeName = fakeName,
            checkString = md5String
        }
        local data = X3DataMgr.AddByPrimary(X3DataConst.X3Data.UrlImageData, source, originName)
    else
        data:SetCheckString(md5String)
    end
    return md5String
end

---可以优化下，condition固定或者复用table
function UrlImageDBUtil.DelData(originName)
    originName = UrlImgMgr.GetBaseName(originName)
    --local condition = {
    --    [X3DataConst.X3DataField.UrlImageData.originName] = originName,
    --}
    Debug.LogWarning("UrlImageDBUtil.DelData ", originName)
    X3DataMgr.Remove(X3DataConst.X3Data.UrlImageData, originName)
end

return UrlImageDBUtil