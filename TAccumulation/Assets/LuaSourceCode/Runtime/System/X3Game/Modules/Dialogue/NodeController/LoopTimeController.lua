---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2022/2/17 14:45
---

local NodeController = require("Runtime.System.X3Game.Modules.Dialogue.NodeController.NodeController")
---@class LoopTimeController:NodeController
local LoopTimeController = class("LoopTimeController", NodeController, nil ,true)

---初始化数据
function LoopTimeController:OnInit()
    self.super.OnInit(self)
    self.nodeControllerType = DialogueEnum.DialogueConditionType.LoopTime
end

---分析Link，判断节点结束后需要去哪个节点
function LoopTimeController:AnalyzeLink()
    local loopStartTime = self.pipeline:GetLoopStartTime(self.dialogueEntry.uniqueID)
    if loopStartTime == nil then
        self.pipeline:SetLoopStartTime(self.dialogueEntry.uniqueID, self.pipeline:GetPipelineRunningTime())
        if self.dialogueEntry.outgoingLinks then
            self:AddWaitNode(self.dialogueEntry.outgoingLinks[1])
            self:ProcessSave(self.dialogueEntry.outgoingLinks[1])
        else
            self:ProcessSave()
        end
    else
        if self.pipeline:GetPipelineRunningTime() - loopStartTime < self.dialogueEntry.loopTime then
            if self.dialogueEntry.outgoingLinks then
                self:AddWaitNode(self.dialogueEntry.outgoingLinks[1])
                self:ProcessSave(self.dialogueEntry.outgoingLinks[1])
            else
                self:ProcessSave()
            end
        else
            self.pipeline:SetLoopStartTime(self.dialogueEntry.uniqueID, nil)
            if self.dialogueEntry.outgoingLinks then
                self:AddWaitNode(self.dialogueEntry.outgoingLinks[2])
                self:ProcessSave(self.dialogueEntry.outgoingLinks[2])
            else
                self:ProcessSave()
            end
        end
    end
    self:ResumeUpdate()
end

return LoopTimeController