---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2023/7/4 14:29
---

---@type CharacterCtrlEnum
local CharacterCtrlEnum = require("Runtime.System.X3Game.Modules.CharacterCtrl.CharacterCtrlEnum")

---@class DialogueBlushAction : DialogueBaseAction
local DialogueBlushAction = class("DialogueBlushAction", require("Runtime.System.X3Game.Modules.Dialogue.Action.DialogueBaseAction"), nil ,true)

---ActionInit
---@param cfg DialogueActionCfg
function DialogueBlushAction:OnInit(cfg)
    self.super.OnInit(self, cfg)
    ---@type DynamicTarget
    self.target = cfg.target
    ---@type boolean
    self.isStart = cfg.isStart
    ---@type int
    self.blushId = cfg.blushId
    ---@type boolean
    self.isPlayCpl = false
    ---@type int
    self.blushType = (cfg.blushType == 0 or cfg.blushType == nil) and CharacterCtrlEnum.BodySystemType.Blush or cfg.blushType
end

---ActionEnter
function DialogueBlushAction:OnEnter()
    local go = self.system:GetDynamicTarget(self.target)
    if GameObjectUtil.IsNull(go) == false then
        ---@type CharacterCtrl
        local ctrl = CharacterCtrlMgr.GetCtrl(go)
        if self.isStart then
            local blushCfg = LuaCfgMgr.Get("Blush", self.blushId)
            if blushCfg then
                if blushCfg.Type == CharacterCtrlEnum.BodySystemType.Blush then
                    ctrl:StartBlush(self.blushId, handler(self, self.IsPlayCpl))
                elseif blushCfg.Type == CharacterCtrlEnum.BodySystemType.Sweat then
                    ctrl:StartSweat(self.blushId, handler(self, self.IsPlayCpl))
                end
            else
                Debug.LogError("BlushConfig Not Has ID:", self.blushId)
            end
        else
            if self.blushType == CharacterCtrlEnum.BodySystemType.Blush then
                ctrl:StopBlush(handler(self, self.IsPlayCpl))
            elseif self.blushType == CharacterCtrlEnum.BodySystemType.Sweat then
                ctrl:StopSweat(handler(self, self.IsPlayCpl))
            end
        end
    end
end

---
function DialogueBlushAction:IsPlayCpl()
   self.isPlayCpl = true
end

---@param progress float
function DialogueBlushAction:OnProcess(progress)
    if self.duration ~= -1 then
        return self.super.OnProcess(self, progress)
    else
        if self.isPlayCpl then
            return DialogueEnum.UpdateActionState.Complete
        else
            return DialogueEnum.UpdateActionState.Running
        end
    end
end

return DialogueBlushAction