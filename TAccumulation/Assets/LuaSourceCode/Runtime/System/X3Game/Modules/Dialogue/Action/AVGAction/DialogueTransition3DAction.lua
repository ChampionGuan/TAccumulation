---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2023/1/31 20:46
---

---@class DialogueTransition3DAction:DialogueBaseAction
local DialogueTransition3DAction = class("DialogueTransition3DAction", require("Runtime.System.X3Game.Modules.Dialogue.Action.DialogueBaseAction"), nil ,true)

local State = {
    None = 0,
    Movein = 1, --渐入
    Wait = 2, --等待
    Moveout = 3 --渐出
}

local DirectorWrapMode = CS.UnityEngine.Playables.DirectorWrapMode
local DirectorUpdateMode = CS.UnityEngine.Playables.DirectorUpdateMode

---ActionInit
---@param cfg DialogueActionCfg
function DialogueTransition3DAction:OnInit(cfg)
    self.super.OnInit(self, cfg)
    ---@type int
    self.AVGActionId = cfg.AVGActionId
    self.transitionState = State.None

    --region PPV配置
    ---@type bool PPV使用默认配置
    self.useDefault = cfg.useDefault
    ---@type float 渐入时长
    self.moveinTime = cfg.moveinTime
    ---@type float 停留时长
    self.waitTime = cfg.waitTime
    ---@type float 渐出时长
    self.moveoutTime = cfg.moveoutTime
    ---@type AnimationClip
    self.moveinAsset = nil
    ---@type AnimationClip
    self.moveoutAsset = nil
    --endregion
    --region 角色显隐
    ---@type bool 角色显隐
    self.changeActorActive = cfg.changeActorActive
    ---@type DynamicTarget 显隐目标
    self.actor = cfg.actor
    ---@type bool 显隐操作
    self.isActorActive = cfg.isActorActive
    --endregion
    --region 场景切换
    ---@type DialogueEnum.ChangeSceneType 切换场景类型2D/3D
    self.changeSceneType = cfg.changeSceneType
    ---@type string 资产路径
    self.assetPath = cfg.assetPath
    ---@type int Scene2DInfo表主Key
    self.scene2DInfoId = cfg.scene2DInfoId
    ---@type string 3D场景名
    self.sceneName = cfg.sceneName
    --endregion
end

---ActionEnter
function DialogueTransition3DAction:OnEnter()
    self.dialogueAvgAction = LuaCfgMgr.Get("DialogueAvgAction", self.AVGActionId)
    if self.useDefault then
        self.moveinTime = tonumber(self.dialogueAvgAction.Para2) or 0
        self.waitTime = tonumber(self.dialogueAvgAction.Para3) or 0
        self.moveoutTime = tonumber(self.dialogueAvgAction.Para5) or 0
    end
    self.duration = self.moveinTime + self.waitTime + self.moveoutTime
end

---Process函数
---@param progress float
---@return DialogueEnum.UpdateActionState
function DialogueTransition3DAction:OnProcess(progress)
    if self.transitionState == State.None then
        self:EnterMovein()
        self.transitionState = State.Movein
    end
    if self.transitionState == State.Movein then
        self:ProcessMovein()
        if self.curTime >= self.moveinTime then
            self:EnterWait()
            self.transitionState = State.Wait
        end
    end
    if self.transitionState == State.Wait then
        if self.curTime >= self.moveinTime + self.waitTime then
            self.transitionState = State.Moveout
            self:EnterMoveout()
        end
    end
    if self.transitionState == State.Moveout then
        self:ProcessMoveout()
    end
    return self.super.OnProcess(self, progress)
end

---播放渐入
function DialogueTransition3DAction:EnterMovein()
    self.moveinAsset = Res.LoadWithAssetPath(string.concat(DialogueConst.PPVAnimPath,
            self.dialogueAvgAction.Para1, ".anim"))
    PostProcessVolumeMgr.PlayAnimState("TransitionMovein", self.moveinAsset, DirectorWrapMode.None,
            DirectorUpdateMode.Manual)
end

---
function DialogueTransition3DAction:ProcessMovein()
    PostProcessVolumeMgr.EvaluateAnim("TransitionMovein", self.curTime / self.moveinTime)
end

---停留过程，角色显隐和切换场景
function DialogueTransition3DAction:EnterWait()
    PostProcessVolumeMgr.EvaluateAnim("TransitionMovein", 1)
    if self.changeActorActive then
--[[        local go = self.system:GetDynamicTarget(self.actor)
        local animator = GameObjectUtil.EnsureCSComponent(go, typeof(CS.X3Game.X3Animator))
        if animator and self.isActorActive == false then
            animator:Stop()
        end
        GameObjectUtil.SetActive(self.actor, self.isActorActive)]]
        self.system:SetDynamicTargetActive(self.actor, self.isActorActive)
    end
    if self.changeSceneType == DialogueEnum.ChangeSceneType.Scene2D then
        if self.scene2DInfoId and self.scene2DInfoId > 0 then
            SceneMgr.Change2DScene(self.scene2DInfoId)
        else
            SceneMgr.Change2DSceneByPath(self.assetPath)
        end
    elseif self.changeSceneType == DialogueEnum.ChangeSceneType.Scene3D then
        self.pipeline:ChangeScene(self.sceneName)
    end
end

---播放渐出
function DialogueTransition3DAction:EnterMoveout()
    PostProcessVolumeMgr.RemoveAnimState("TransitionMovein")
    self.moveoutAsset = Res.LoadWithAssetPath(string.concat(DialogueConst.PPVAnimPath,
            self.dialogueAvgAction.Para4, ".anim"))
    if self.moveoutAsset then
        PostProcessVolumeMgr.PlayAnimState("TransitionMoveout", self.moveoutAsset, DirectorWrapMode.None,
                DirectorUpdateMode.Manual)
    end
end

---
function DialogueTransition3DAction:ProcessMoveout()
    PostProcessVolumeMgr.EvaluateAnim("TransitionMoveout", (self.curTime - self.moveinTime - self.waitTime) / self.moveoutTime)
end

---ActionExit
function DialogueTransition3DAction:OnExit()
    PostProcessVolumeMgr.EvaluateAnim("TransitionMoveout", 1)
    PostProcessVolumeMgr.RemoveAnimState("TransitionMoveout")
    PostProcessVolumeMgr.RemoveAnimState("TransitionMovein")
    if self.moveinAsset then
        Res.Unload(self.moveinAsset)
        self.moveinAsset = nil
    end
    if self.moveoutAsset then
        Res.Unload(self.moveoutAsset)
        self.moveoutAsset = nil
    end
end

return DialogueTransition3DAction