---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2023/3/16 17:50
---

local NodeController = require("Runtime.System.X3Game.Modules.Dialogue.NodeController.NodeController")
---@class ParellelController : NodeController
local ParellelController = class("ParellelController", NodeController, nil ,true)

---初始化数据
function ParellelController:OnInit()
    self.super.OnInit(self)
    self.nodeControllerType = DialogueEnum.DialogueConditionType.Parallel
end

---分析Link，判断节点结束后需要去哪个节点
function ParellelController:AnalyzeLink()
    self.system:SetIgnoreProcessSave(true)
    if self.dialogueEntry.outgoingLinks then
        for i = 1, #self.dialogueEntry.outgoingLinks do
            if self.dialogueEntry.outgoingLinks[i].conditionData.isFallback then
                self:AddWaitNode(self.dialogueEntry.outgoingLinks[i])
                self:ProcessSave(self.dialogueEntry.outgoingLinks[i])
            else
                if DialogueManager.IsMutedLink(self.database.name, self.dialogueEntry.outgoingLinks[i]) == false then
                    local result, firstFailedCondition = ConditionCheckUtil.CheckConditionCheckData(self.dialogueEntry.outgoingLinks[i].conditionData.conditionCheckDatas,
                            self.system:GetDataProvider())
                    if result then
                        self.pipeline:StartSubPlayer(self.nodePlayer, self.dialogueEntry.outgoingLinks[i])
                    else
                        Debug.LogFormat("[DialogueSystem]ConditionCheck失败-%s-%s-%s-%s-%s", firstFailedCondition.id, firstFailedCondition.paramList[1], firstFailedCondition.paramList[2], firstFailedCondition.paramList[3], firstFailedCondition.paramList[4])
                    end
                end
            end
        end
    end
    self.system:SetIgnoreProcessSave(false)
    self:ResumeUpdate()
end

return ParellelController