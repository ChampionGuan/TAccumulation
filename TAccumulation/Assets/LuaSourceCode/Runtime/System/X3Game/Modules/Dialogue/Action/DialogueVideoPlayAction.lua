---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2022/11/14 19:35
---

---@class DialogueVideoPlayAction:DialogueBaseAction
local DialogueVideoPlayAction = class("DialogueVideoPlayAction", require("Runtime.System.X3Game.Modules.Dialogue.Action.DialogueBaseAction"), nil ,true)

---ActionInit
---@param cfg DialogueActionCfg
function DialogueVideoPlayAction:OnInit(cfg)
    self.super.OnInit(self, cfg)
    ---@type string video名字
    self.videoName = cfg.videoName
    ---@type boolean 是否播放指定段落
    self.isPlayPart = cfg.isPlayPart
    ---@type int 开始帧数
    self.startFrame = cfg.startFrame
    ---@type int 结束帧数
    self.endFrame = cfg.endFrame
    ---@type false
    self.playCpl = false
end

---
function DialogueVideoPlayAction:OnEnter()
    EventMgr.Dispatch("DialogueVideoPlay",
                self.videoName,
                handler(self, self.OnCpl),
                1,
                self.isPlayPart and self.startFrame or 0,
                self.isPlayPart and self.endFrame or 0,
                self.system:GetDialogueSpeed())
    EventMgr.Dispatch("CameraTimelinePlayed", self.pipeline:GetUniqueId())
end

---播放完成回调
function DialogueVideoPlayAction:OnCpl()
    self.playCpl = true
end

---ActionUpdate
---@param progress float
---@return DialogueEnum.UpdateActionState
function DialogueVideoPlayAction:OnProcess(progress)
    if self.playCpl then
        return DialogueEnum.UpdateActionState.Complete
    else
        if self.duration > 0 and self.curTime >= self.duration then
            return DialogueEnum.UpdateActionState.Complete
        else
            return DialogueEnum.UpdateActionState.Running
        end
    end
end

return DialogueVideoPlayAction