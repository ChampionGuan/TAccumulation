---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2022/5/12 20:01
---

---@class DialogueLookAtCameraActiveAction:DialogueBaseAction
local DialogueLookAtCameraActiveAction = class("DialogueLookAtCameraActiveAction", require("Runtime.System.X3Game.Modules.Dialogue.Action.DialogueBaseAction"), nil ,true)

---@param cfg
function DialogueLookAtCameraActiveAction:OnInit(cfg)
    self.super.OnInit(self, cfg)
    ---@type string 摄像机路径
    self.cameraPath = cfg.cameraPath
    ---@type DynamicTarget 跟随目标
    self.target = cfg.target
    ---@type string 骨骼名
    self.boneName = cfg.boneName
    ---@type float
    self.deadZone = cfg.deadZone
    ---@type int 由于Cinemachine的机制，相机行为必须下一帧销毁
    self.endFrame = 0
end

---ActionEnter
function DialogueLookAtCameraActiveAction:OnEnter()
    GlobalCameraMgr.SetDefaultBlend(CameraDefaultBlendStyle.EaseInOut, 1)
    local camera = self.system:ActiveLookAtCamera(self.cameraPath)
    local cameraMode = camera:GetMode()
    camera:SetPriority(0)
    cameraMode:SetDeathWidth(self.deadZone)
    local target = self.system:GetDynamicTarget(self.target)
    cameraMode:SyncVirtualCamera()
    cameraMode:LookAtActor(target, self.boneName)
    camera:SetPriority(40)
end

---Process函数
---@param progress float
function DialogueLookAtCameraActiveAction:OnProcess(progress)
    if self.endFrame ~= 0 and self.endFrame < TimerMgr.GetFrameCount() then
        return DialogueEnum.UpdateActionState.Complete
    end
    if self.super.OnProcess(self, progress) == DialogueEnum.UpdateActionState.Complete then
        self.endFrame = TimerMgr.GetFrameCount()
    end
    return DialogueEnum.UpdateActionState.Running
end

return DialogueLookAtCameraActiveAction