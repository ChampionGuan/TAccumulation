---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2022/1/17 16:01
---

---@class DialogueInstantiateGOAction:DialogueBaseAction
local DialogueInstantiateGOAction = class("DialogueInstantiateGOAction", require("Runtime.System.X3Game.Modules.Dialogue.Action.DialogueBaseAction"), nil ,true)

---ActionInit
---@param cfg DialogueActionCfg
function DialogueInstantiateGOAction:OnInit(cfg)
    self.super.OnInit(self, cfg)
    ---@type DialogueEnum.DynamicTargetType
    self.instantiateType = cfg.instantiateType
    ---@type int
    self.targetId = cfg.targetId
    ---@type DynamicTarget
    self.parent = cfg.parent
    ---@type Vector3
    self.localPosition = cfg.localPosition
    ---@type Vector3
    self.localEulerAngles = cfg.localEulerAngles
    ---@type float
    self.destroyWhenExit = false
    ---@type GameObject
    self.createdGO = nil
end

---ActionEnter
function DialogueInstantiateGOAction:OnEnter()
    if self.instantiateType == DialogueEnum.DynamicTargetType.Actor then
        self.createdGO = self.system:InitActorById(self.targetId)
        if GameObjectUtil.IsNull(self.createdGO) == false then
            GameObjectUtil.SetLocalPosition(self.createdGO, self.localPosition)
            GameObjectUtil.SetLocalEulerAngles(self.createdGO, self.localEulerAngles)
            local parentGO = self.system:GetDynamicTarget(self.parent)
            if GameObjectUtil.IsNull(parentGO) == false then
                GameObjectUtil.SetParent(self.createdGO.transform, parentGO.transform)
            end
        end
    elseif self.instantiateType == DialogueEnum.DynamicTargetType.TempObject then
        if self.parent.targetType == DialogueEnum.DynamicTargetType.UI then
            self.system:InstantiateGameObjectToUI(self.targetId, self.parent.childTransformPath, self.localPosition, self.localEulerAngles)
        else
            local parentGO = self.system:GetDynamicTarget(self.parent)
            self.createdGO = self.system:InstantiateGameObject(self.targetId, parentGO and parentGO.transform or nil)
            if GameObjectUtil.IsNull(self.createdGO) == false then
                GameObjectUtil.SetLocalPosition(self.createdGO, self.localPosition)
                GameObjectUtil.SetLocalEulerAngles(self.createdGO, self.localEulerAngles)
            end
        end
    end
    if self.duration > 0 then
        self.destroyWhenExit = true
    end
end

---Action退出，会在退出时执行一次
function DialogueInstantiateGOAction:OnExit()
    if self.destroyWhenExit then
        self.system:DestroyAssignedGameObject(self.targetId, self.createdGO)
    end
    self.createdGO = nil
end

return DialogueInstantiateGOAction