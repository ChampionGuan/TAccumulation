---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2023/2/8 15:43
---

---
---@class DialogueActionHelper
local DialogueActionHelper = class("DialogueActionHelper")
---@type table<int, table<int, any>>
local holdonActionList = {}
---@type table<int, any>
local holdonPPVAction = {}

---添加一个动画状态并播放
---@param subType int PPV子类型，同一子类型只能存在一个
---@param name string
---@param clip AnimationClip
---@param wrapMode
---@param updateMode
function DialogueActionHelper:PlayPPVAnim(subType, name, clip, wrapMode, updateMode)
    if holdonPPVAction[subType] then
        self:InternalDestroyAction(holdonPPVAction[subType])
    end
    PostProcessVolumeMgr.PlayAnimState(name, clip, wrapMode, updateMode)
end

---移除一个动画状态
---@param name string
function DialogueActionHelper:RemoveAnimState(name)
    PostProcessVolumeMgr.RemoveAnimState(name)
end

---添加暂时挂起循环这的效果，等待关闭命令
---@param uniqueId int
---@param ownerGroup DialogueActionGroup
---@param actionId int
---@param data
function DialogueActionHelper:AddHoldonAction(uniqueId, ownerGroup, actionId, data)
    if holdonActionList[uniqueId] == nil then
        holdonActionList[uniqueId] = {}
    end
    data.uniqueId = uniqueId
    if ownerGroup.id and ownerGroup.id ~= 0 then
        data.actionId = ownerGroup.id * 10000 + actionId
    else
        data.actionId = actionId
    end
    holdonActionList[data.uniqueId][data.actionId] = data
    local dialogueAvgAction = LuaCfgMgr.Get("DialogueAvgAction", data.AVGActionId)
    if dialogueAvgAction.Type == DialogueEnum.DialogueActionType.PPV then
        holdonPPVAction[dialogueAvgAction.SubType] = data
    end
end

---关闭某个效果
---@param uniqueId int
---@param actionId int
function DialogueActionHelper:CloseHoldonAction(uniqueId, actionId)
    local actionData = nil
    if holdonActionList[uniqueId] then
        actionData = holdonActionList[uniqueId][actionId]
    end
    if actionData then
        self:InternalCloseAction(actionData)
    end
end

---关闭效果
---@param actionData
function DialogueActionHelper:InternalCloseAction(actionData)
    local dialogueAvgAction = LuaCfgMgr.Get("DialogueAvgAction", actionData.AVGActionId)
    if dialogueAvgAction.Type == DialogueEnum.DialogueActionType.SpecialImageText then
        local uiCtrl = UICtrl.GetOrAddCtrl(actionData.asset, "Runtime.System.X3Game.UI.UIView.Dialog.DialogueAVGImageTextController", self)
        uiCtrl:PlayMoveout(function() self:InternalDestroyAction(actionData) end)
    else
        self:InternalDestroyAction(actionData)
    end
end

---销毁效果，不执行关闭逻辑
---@param actionData
function DialogueActionHelper:InternalDestroyAction(actionData)
    local avgActionId = actionData.AVGActionId
    local dialogueAvgAction = LuaCfgMgr.Get("DialogueAvgAction", avgActionId)
    if dialogueAvgAction.Type == DialogueEnum.DialogueActionType.SpecialImageText then
        if GameObjectUtil.IsNull(actionData.asset) == false then
            Res.DiscardGameObject(actionData.asset)
            GameObjectCtrl.RemoveCtrlByGameObject(actionData.asset)
        end
    elseif dialogueAvgAction.Type == DialogueEnum.DialogueActionType.PPV then
        PostProcessVolumeMgr.RemoveAnimState(actionData.stateName)
        Res.Unload(actionData.asset)
        holdonPPVAction[dialogueAvgAction.SubType] = nil
    elseif dialogueAvgAction.Type == DialogueEnum.DialogueActionType.CameraAnim then
        if GameObjectUtil.IsNull(actionData.asset) == false then
            GlobalCameraMgr.StopShake(actionData.asset)
            Res.DiscardGameObject(actionData.asset)
        end
    end
    if holdonActionList[actionData.uniqueId] then
        holdonActionList[actionData.uniqueId][actionData.actionId] = nil
        PoolUtil.ReleaseTable(actionData)
    end
end

---关闭所有效果
function DialogueActionHelper:DestroyAll()
    for _, actionList in pairs(holdonActionList) do
        for _, actionData in pairs(actionList) do
            self:InternalDestroyAction(actionData)
            table.clear(actionData)
            PoolUtil.ReleaseTable(actionData)
        end
    end
    PostProcessVolumeMgr.DeactiveAllAnimPPV()
    table.clear(holdonActionList)
end

return DialogueActionHelper