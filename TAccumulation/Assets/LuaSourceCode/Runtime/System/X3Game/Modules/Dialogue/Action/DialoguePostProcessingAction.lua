---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2022/1/17 15:01
---

---@class DialoguePostProcessingAction:DialogueBaseAction
local DialoguePostProcessingAction = class("DialoguePostProcessingAction", require("Runtime.System.X3Game.Modules.Dialogue.Action.DialogueBaseAction"), nil, true)

---ActionInit
---@param cfg DialogueActionCfg
function DialoguePostProcessingAction:OnInit(cfg)
    self.super.OnInit(self, cfg)
    ---@type DialogueEnum.TransitionType
    self.transitionType = cfg.transitionType
    ---@type CS.PapeGames.Rendering.PostProcessVolume ppv组件
    self.ppv = nil
    ---@type CS.PapeGames.Rendering.VignetteBfg 暗角
    self.vignetteBfg = nil
    ---@type float 起始强度
    self.startStrength = 0
    ---@type float 目标强度
    self.targetStrength = 1
    ---@type boolean 由于PPV的特殊性，行为必须下一帧销毁
    self.endFrame = 0
end

---ActionEnter
function DialoguePostProcessingAction:OnEnter()
    self.ppv = PostProcessVolumeMgr.GetPPV2()
    if self.ppv ~= nil then
        self.vignetteBfg = self.ppv:GetFeature(CS.PapeGames.Rendering.BlendableFeatureGroup.FeatureType.BFG_Vignette)
        self.vignetteBfg.vignetteRange = 0
        if self.transitionType == DialogueEnum.TransitionType.DarkScreenFadeIn then
            self.startStrength = self.vignetteBfg.vignetteStrength
            self.targetStrength = 0
        elseif self.transitionType == DialogueEnum.TransitionType.DarkScreenFadeOut then
            self.startStrength = 0
            self.targetStrength = 1
        elseif self.transitionType == DialogueEnum.TransitionType.WhiteScreenFadeIn then
            self.startStrength = self.vignetteBfg.vignetteStrength
            self.targetStrength = 2
        elseif self.transitionType == DialogueEnum.TransitionType.WhiteScreenFadeOut then
            self.startStrength = 2
            self.targetStrength = 1
        end
        self.vignetteBfg.state = CS.PapeGames.Rendering.FeatureState.ActiveEnabled
        self.ppv.manualWeightForGlobal = 1
    end
end

---Process函数
---@param progress float
---@return DialogueEnum.UpdateActionState
function DialoguePostProcessingAction:OnProcess(progress)
    if self.endFrame ~= 0 and self.endFrame < TimerMgr.GetFrameCount() then
        return DialogueEnum.UpdateActionState.Complete
    end
    if self.ppv ~= nil then
        self.vignetteBfg.vignetteStrength = Mathf.Lerp(self.startStrength, self.targetStrength, progress)
        self.vignetteRange = 0
    end
    if self.super.OnProcess(self, progress) == DialogueEnum.UpdateActionState.Complete then
        self.endFrame = TimerMgr.GetFrameCount()
        if self.ppv ~= nil then
            self.vignetteBfg.vignetteStrength = self.targetStrength
            if self.transitionType == DialogueEnum.TransitionType.DarkScreenFadeOut or
                    self.transitionType == DialogueEnum.TransitionType.WhiteScreenFadeOut then
                self.ppv:DeactivateFeature(CS.PapeGames.Rendering.BlendableFeatureGroup.FeatureType.BFG_Vignette)
            end
        end
    end
    return DialogueEnum.UpdateActionState.Running
end

---Action退出，会在退出时执行一次
function DialoguePostProcessingAction:OnExit()
    if self.ppv ~= nil then
        self.vignetteBfg.vignetteStrength = self.targetStrength
        if self.transitionType == DialogueEnum.TransitionType.DarkScreenFadeOut or
                self.transitionType == DialogueEnum.TransitionType.WhiteScreenFadeOut then
            self.ppv:DeactivateFeature(CS.PapeGames.Rendering.BlendableFeatureGroup.FeatureType.BFG_Vignette)
        end
    end
end

return DialoguePostProcessingAction