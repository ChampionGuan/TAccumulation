---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2022/6/13 15:55
---

local AIAction = require("Runtime.Plugins.AIDesigner.Base.AITask").AIAction

---Category:Date/CoupleUFOCatcher
---@class CoupleUFOCatcherMoveClawZ:AIAction
---@field min Float
---@field max Float
local CoupleUFOCatcherMoveClawZ = class("CoupleUFOCatcherMoveClawZ", AIAction)

function CoupleUFOCatcherMoveClawZ:OnEnter()
    ---@type GameObject
    self.body = self.tree:GetVariable("clawBody")
    ---@type GameObject
    self.target = self.tree:GetVariable("catchTarget")
    ---@type ClawController
    self.clawController = self.tree:GetVariable("UFOCatcherController").clawController
    ---@type GameObject
    self.ufoCatcher = self.tree:GetVariable("UFOCatcher")
    ---@type float
    self.lastPositionZ = 0
    ---@type float
    self.checkStartTime = 0
    ---@type float
    self.directionZ = 0
    ---@type float
    self.needMoveZ = 0
    ---@type float
    self.startPositionZ = 0

    local collider = self.target:GetComponent("DollCollider")
    local minZ = collider:GetBorderPosition(0, -1).z
    local maxZ = collider:GetBorderPosition(0, 1).z
    local randomRange = Mathf.RandomFloat(self.min, self.max)
    local targetPositionZ = minZ * (1 - randomRange) + maxZ * randomRange
    local bodyPositionZ = GameObjectUtil.GetPosition(self.body).z
    self.startPositionZ = bodyPositionZ
    self.needMoveZ = math.abs(bodyPositionZ - targetPositionZ)
    self.directionZ = targetPositionZ - bodyPositionZ
end

---@return AITaskState
function CoupleUFOCatcherMoveClawZ:OnUpdate()
    local direction = Vector2.Temp(0, 0)
    local bodyPosition = GameObjectUtil.GetPosition(self.body)
    if math.abs(bodyPosition.z - self.startPositionZ) < self.needMoveZ then
        direction.y = self.directionZ
    end
    if TimerMgr.RealtimeSinceStartup() - self.checkStartTime > 2 then
        self.checkStartTime = TimerMgr.RealtimeSinceStartup()
        if math.abs(self.lastPositionZ - bodyPosition.z) <= 0.005 then
            return AITaskState.Success
        else
            self.lastPositionZ = bodyPosition.z
        end
    end

    if direction:SqrMagnitude() >= 0.0001 then
        local worldDirection = self.ufoCatcher.transform:TransformDirection(direction.x, direction.y, 0).normalized
        self.clawController:MoveClawByWorldDirection(worldDirection.x, worldDirection.y)
        return AITaskState.Running
    end
    return AITaskState.Success
end

function CoupleUFOCatcherMoveClawZ:OnExit()
    self.clawController:OnUpBtnUp()
end


return CoupleUFOCatcherMoveClawZ