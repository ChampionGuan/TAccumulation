---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2022/7/11 19:15
---
local ChooseBlockBaseAction = require("Runtime.System.X3Game.Modules.AIDesigner.Task.Date.BlockTower.Action.ChooseBlockBaseAction")

---Category:Date/BlockTower
---安全块组寻找（保底）
---@class ChooseBlockLastPlanAction:ChooseBlockBaseAction
local ChooseBlockLastPlanAction = class("ChooseBlockLastPlanAction", ChooseBlockBaseAction)
---@type BlockTowerConst
local Const = require("Runtime.System.X3Game.Modules.BlockTower.BlockTowerConst")

---@return AITaskState
function ChooseBlockLastPlanAction:OnUpdate()
    local layer = self:RandomLayer()
    if layer == -1 then
        return AITaskState.Failure
    else
        if self:IsEffectiveLayer(layer) then
            return AITaskState.Success
        else
            return AITaskState.Running
        end
    end
end

---判断是否是有效层
---@param layer int
---@return boolean
function ChooseBlockLastPlanAction:IsEffectiveLayer(layer)
    local blockDataList = self.gameData:GetPhysicsLayer(layer)
    local safeBlockList = {}
    for _, blockData in ipairs(blockDataList) do
        local blockType = self.gameController:ColliderHitTestLastPlan(blockData.blockGO)
        if blockType ~= Const.BlockType.None then
            blockData.blockType = blockType
            table.insert(safeBlockList, #safeBlockList + 1, blockData)
        end
    end
    if #safeBlockList <= 0 then
        return false
    else
        self.gameData:ChangeAIChoosed(layer, safeBlockList)
        return true
    end
end

return ChooseBlockLastPlanAction