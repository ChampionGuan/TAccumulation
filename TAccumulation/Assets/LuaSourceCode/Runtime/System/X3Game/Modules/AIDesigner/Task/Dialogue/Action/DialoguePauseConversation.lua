---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2021/12/16 11:44
---

local DialogueAction = require("Runtime.System.X3Game.Modules.AIDesigner.Task.Dialogue.Action.DialogueAction")

---Category:Dialogue
---@class DialoguePauseConversation:DialogueAction
---@field exitKey string|AIVar 退出方式指定
---@field pipelineKey string|AIVar 可以给播放的Pipeline指定Key，用来定向暂停，继续，停止等操作
local DialoguePauseConversation = class("DialoguePauseConversation", DialogueAction)

function DialoguePauseConversation:OnEnter()
    self.super.OnEnter(self)
    ---@type boolean 是否暂停完毕
    self.pauseCpl = false
    ---共享数据防止Update时被改变，需要在OnEnter时记录本地值
    self._pipelineKey = self.pipelineKey:GetValue()
    self._exitKey = self.exitKey and self.exitKey:GetValue() or nil

    Debug.LogFormat("[DialogueSystem]AI开始-%s-%s", self.tree:GetName(), self:_GetPath())
    if self.dialogueController ~= nil then
        self.dialogueController:PausePipeline(self._pipelineKey, self._exitKey, handler(self, self.OnPauseCpl))
    end
end

---@return AITaskState
function DialoguePauseConversation:OnUpdate()
    if self.pauseCpl or self.dialogueController:PipelineExisted(self._pipelineKey) == false then
        Debug.LogFormat("[DialogueSystem]AI结束-%s-%s", self.tree:GetName(), self:_GetPath())
        return AITaskState.Success
    end
    if self.dialogueController ~= nil then
        if string.isnilorempty(self._exitKey) then
            self.pauseCpl = true
            Debug.LogFormat("[DialogueSystem]AI结束-%s-%s", self.tree:GetName(), self:_GetPath())
            return AITaskState.Success
        else
            return AITaskState.Running
        end
    else
        self.pauseCpl = true
        Debug.LogError("没有为AI注入DialogueController，请检查。")
        return AITaskState.Failure
    end
end

---暂停完成回调
function DialoguePauseConversation:OnPauseCpl()
    self.pauseCpl = true
end

function DialoguePauseConversation:OnExit()
    Debug.LogFormat("[DialogueSystem]AI退出-%s-%s-%s", self.pauseCpl, self.tree:GetName(), self:_GetPath())
end

return DialoguePauseConversation