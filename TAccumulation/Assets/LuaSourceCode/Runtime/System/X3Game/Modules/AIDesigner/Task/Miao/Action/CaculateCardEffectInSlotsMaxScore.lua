---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by baozhatou.
--- DateTime: 2023/2/11 14:18
---

---@type MiaoBaseAIAction
local BaseAIAction = require("PureLogic.AI.Task.Miao.MiaoBaseAIAction")
--- 计算使用目标卡牌后，能获得的最大分差
---Category:Miao
---@class CaculateCardEffectInSlotsMaxScore:MiaoBaseAIAction
---@field playerSeat Miao.MiaoPlayerPos | Int 玩家类型
---@field cardID Int 所使用的卡的id
---@field maxTarget AIVar | Int 作用目标对象的索引
---@field maxScore AIVar | Float 作用目标对象的索引
local CaculateCardEffectInSlotsMaxScore = class("CaculateCardEffectInSlotsMaxScore",BaseAIAction)

function CaculateCardEffectInSlotsMaxScore:OnEnter()
    local cardID = self.cardID
    local maxScore = 0
    local maxTarget = 0
    local aiComp = self.entity:GetComponent(Miao.Component.Debug.PlayerAIComp)
    local bbComp = self.entity:GetComponent(Miao.Component.Debug.BlackboardComp)
    local player = bbComp:GetPlayer(self.playerSeat)
    local targetMap, _ = aiComp:FindReserveFuncCards(player)
    local targets = targetMap[cardID]

    if targets ~= nil then
        local calComp = self.entity:GetComponent(Miao.Component.Debug.PlayerCalculatorComp)
        for k,slotIndex in pairs(targets) do
            local diffScore = calComp:CalCardPlayValue(cardID,self.playerSeat,slotIndex)
            if diffScore > maxScore then
                maxScore = diffScore
                maxTarget = slotIndex
                LogicUtil.Log("CaculateCardEffectInSlotsMaxScore "..maxScore.. " , "..maxTarget)
            end
        end
    end

    self.maxTarget:SetValue(maxTarget)
    self.maxScore:SetValue(maxScore)
end

function CaculateCardEffectInSlotsMaxScore:OnUpdate()
    return AITaskState.Success
end

return CaculateCardEffectInSlotsMaxScore