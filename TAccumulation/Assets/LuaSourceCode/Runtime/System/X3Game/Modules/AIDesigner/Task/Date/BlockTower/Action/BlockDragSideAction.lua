---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2022/7/12 17:52
---

local AIAction = require("Runtime.Plugins.AIDesigner.Base.AITask").AIAction
---@type BlockTowerConst
local Const = require("Runtime.System.X3Game.Modules.BlockTower.BlockTowerConst")
---@type BlockTowerUtil
local BlockTowerUtil = require("Runtime.System.X3Game.Modules.BlockTower.BlockTowerUtil")

---Category:Date/BlockTower
---两侧块的拿行为
---@class BlockDragSideAction:AIAction
---@field minRange float 最小幅度(离块中心的距离）
---@field maxRange float 最大幅度(离块中心的距离）
---@field minDeltaAngle float 手抖最小幅度
---@field maxDeltaAngle float 手抖最大幅度
---@field minTime float 最小拖拽时长
---@field maxTime float 最大拖拽时长
local BlockDragSideAction = class("BlockDragSideAction", AIAction)

---
function BlockDragSideAction:OnEnter()
    ---@type BlockTowerGameController
    self.gameController = self.tree:GetVariable("GameController")
    ---@type BlockTowerGameData
    self.gameData = self.gameController:GetGameData()

    local tablePosition = self.gameController:GetRootPosition()
    local blockPosition = GameObjectUtil.GetPosition(self.gameData.selectedBlock)
    local moveDirection = blockPosition - tablePosition
    moveDirection.y = 0
    local deltaAngle = Mathf.RandomFloat(self.minDeltaAngle, self.maxDeltaAngle)
    moveDirection = Quaternion.Euler(0, deltaAngle, 0) * moveDirection
    local range = Mathf.RandomFloat(self.minRange, self.maxRange)
    moveDirection = moveDirection.normalized

    ---@type Vector3 模拟拖拽的块内的本地坐标
    self.localMousePoint = moveDirection * range
    ---@type float 需要拖拽的时间
    self.dragTime = Mathf.RandomFloat(self.minTime, self.maxTime)
    ---@type float 已经拖拽的时间
    self.runningTime = 0
end

---@return AITaskState
function BlockDragSideAction:OnUpdate()
    if self.gameData.selectedBlock == nil then
        return AITaskState.Failure
    end

    if self.gameData.blockTowerControlMode == Const.ControlMode.SelectedSide and self.runningTime < self.dragTime then
        if self.gameData.blockIsolated == false then
            local worldPosition = BlockTowerUtil.LocalToWorld(self.gameData.selectedBlock.transform,
                    self.localMousePoint.x, self.localMousePoint.y, self.localMousePoint.z)
            self.gameController:DragByWorldPosition(worldPosition)
            self.runningTime = self.runningTime + TimerMgr.GetCurTickDelta()
            return AITaskState.Running
        else
            return AITaskState.Success
        end
    end
    return AITaskState.Success
end

return BlockDragSideAction