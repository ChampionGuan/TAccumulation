---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2021/12/16 11:44
---

local DialogueAction = require("Runtime.System.X3Game.Modules.AIDesigner.Task.Dialogue.Action.DialogueAction")

---Category:Dialogue
---@class DialogueStopConversation:DialogueAction
---@field exitKey string|AIVar 退出方式指定
---@field pipelineKey string|AIVar 可以给播放的Pipeline指定Key，用来定向暂停，继续，停止等操作
local DialogueStopConversation = class("DialogueStopConversation", DialogueAction)

function DialogueStopConversation:OnEnter()
    self.super.OnEnter(self)
    ---@type boolean 是否停止完毕
    self.stopCpl = false
    ---共享数据防止Update时被改变，需要在OnEnter时记录本地值
    self._pipelineKey = self.pipelineKey:GetValue()
    self._exitKey = self.exitKey and self.exitKey:GetValue() or nil
    Debug.LogFormat("[DialogueSystem]AI开始-%s-%s", self.tree:GetName(), self:_GetPath())
    if self.dialogueController ~= nil then
        self.dialogueController:StopPipeline(self._pipelineKey, self._exitKey, handler(self, self.OnStopCpl))
    end
end

function DialogueStopConversation:OnUpdate()
    if self.stopCpl or self.dialogueController:PipelineExisted(self._pipelineKey) == false then
        Debug.LogFormat("[DialogueSystem]AI结束-%s-%s", self.tree:GetName(), self:_GetPath())
        return AITaskState.Success
    end
    if self.dialogueController ~= nil then
        if string.isnilorempty(self._exitKey) then
            self.stopCpl = true
            Debug.LogFormat("[DialogueSystem]AI结束-%s-%s", self.tree:GetName(), self:_GetPath())
            return AITaskState.Success
        else
            return AITaskState.Running
        end
    else
        self.stopCpl = true
        Debug.LogError("没有为AI注入DialogueController，请检查。")
        return AITaskState.Failure
    end
end

---停止完成回调
function DialogueStopConversation:OnStopCpl()
    self.stopCpl = true
end

function DialogueStopConversation:OnExit()
    Debug.LogFormat("[DialogueSystem]AI退出-%s-%s-%s", self.stopCpl, self.tree:GetName(), self:_GetPath())
end

return DialogueStopConversation