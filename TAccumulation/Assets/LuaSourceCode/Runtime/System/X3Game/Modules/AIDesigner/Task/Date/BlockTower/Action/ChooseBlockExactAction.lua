---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2022/7/11 16:51
---

local ChooseBlockBaseAction = require("Runtime.System.X3Game.Modules.AIDesigner.Task.Date.BlockTower.Action.ChooseBlockBaseAction")

---Category:Date/BlockTower
---安全块组寻找（精确）
---@class ChooseBlockExactAction:ChooseBlockBaseAction
local ChooseBlockExactAction = class("ChooseBlockCursoryAction", ChooseBlockBaseAction)
---@type BlockTowerConst
local Const = require("Runtime.System.X3Game.Modules.BlockTower.BlockTowerConst")

---@return AITaskState
function ChooseBlockExactAction:OnUpdate()
    local layer = self:RandomLayer()
    if layer == -1 then
        return AITaskState.Failure
    else
        if self:IsEffectiveLayer(layer) then
            return AITaskState.Success
        else
            return AITaskState.Running
        end
    end
end

---判断是否是有效层
---@param layer int
---@return boolean
function ChooseBlockExactAction:IsEffectiveLayer(layer)
    local blockDataList = self.gameData:GetPhysicsLayer(layer)
    local safeBlockList = {}
    local needTestList = {}
    if #blockDataList == 1 then
        return false
    elseif #blockDataList == 2 then
        local isSupportBlockA = self.gameController:IsSupportBlock(blockDataList[1])
        local isSupportBlockB = self.gameController:IsSupportBlock(blockDataList[2])
        if isSupportBlockA then
            table.insert(needTestList, #needTestList + 1, blockDataList[2])
        elseif isSupportBlockB then
            table.insert(needTestList, #needTestList + 1, blockDataList[1])
        else
            return false
        end
    else
        needTestList = blockDataList
    end

    for _, blockData in ipairs(needTestList) do
        local blockType = self.gameController:BlockTowerTypeTest(blockData.blockGO, false)
        if blockType ~= Const.BlockType.None then
            blockData.blockType = blockType
            table.insert(safeBlockList, #safeBlockList + 1, blockData)
        end
    end

    if #safeBlockList <= 0 then
        return false
    else
        self.gameData:ChangeAIChoosed(layer, safeBlockList)
        return true
    end
end

return ChooseBlockExactAction
