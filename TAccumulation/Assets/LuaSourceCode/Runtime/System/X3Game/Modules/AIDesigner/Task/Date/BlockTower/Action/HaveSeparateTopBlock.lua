---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2022/9/15 14:39
---
local AIAction = require("Runtime.Plugins.AIDesigner.Base.AITask").AIAction

---@type BlockTowerConst
local Const = require("Runtime.System.X3Game.Modules.BlockTower.BlockTowerConst")

---Category:Date/BlockTower
---快速找到独立的块
---@class HaveSeparateTopBlock:AIAction
local HaveSeparateTopBlock = class("ChooseTargetBlockAction", AIAction)

---
function HaveSeparateTopBlock:OnEnter()
    ---@type BlockTowerGameController
    self.gameController = self.tree:GetVariable("GameController")
    ---@type BlockTowerGameData
    self.gameData = self.gameController:GetGameData()
end

---@return AITaskState
function HaveSeparateTopBlock:OnUpdate()
    for layer = 1, self.gameData.curPhysicsLayer - self.gameData.layerForbidden do
        local curLayer = self.gameData:GetPhysicsLayer(layer)
        for _, blockData in pairs(curLayer) do
            if self.gameController:ColliderCastTest(blockData.blockGO, Vector3.up, 0, false) then
                local blockType = self.gameController:BlockTowerTypeTest(blockData.blockGO, false)
                if blockType ~= Const.BlockType.None then
                    blockData.blockType = blockType
                    self.gameData:ChangeAIChoosed(layer, { blockData })
                    Debug.LogFormat("快速找到独立的块成功:{0}", layer)
                    return AITaskState.Success
                end
            end
        end
    end
    Debug.LogFormat("快速找到独立的块失败")
    return AITaskState.Failure
end

return HaveSeparateTopBlock