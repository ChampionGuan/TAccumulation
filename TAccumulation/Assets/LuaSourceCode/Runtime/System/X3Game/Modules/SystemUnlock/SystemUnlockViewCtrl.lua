---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiaozhu.
--- DateTime: 2021/11/4 17:07
--- 所有系统解锁组件注册和点击逻辑

---@type X3Game.SystemUnlock
local s_SystemUnlock = CS.X3Game.SystemUnlock
---@class SystemUnlockViewCtrl
local SystemUnlockViewCtrl = class("SystemUnlockViewCtrl")

---初始化
function SystemUnlockViewCtrl:Init()
    self:RegisterEvent()
end

---系统解锁id
---@param sysId int
function SystemUnlockViewCtrl:SystemUnLockCheck(sysId)
    local isUnlock,isForceHide = true,false
    if sysId ~=0 then
        isUnlock,isForceHide = SysUnLock.IsUnLock(sysId)
        isForceHide = isForceHide == 0
    end
    s_SystemUnlock.SetSystemIsUnlock(sysId, isUnlock, isForceHide)
end

---系统解锁按钮被点击
---@param sysId int
---@param viewTag string
---@param isUnlock boolean
function SystemUnlockViewCtrl:OnSysClick(sysId, viewTag, isUnlock)
    if isUnlock then
        self:ExeUnlockClick(sysId, viewTag)
    else
        self:ExeLockClick(sysId, viewTag)
    end
end

---系统未解锁点击逻辑
---@param sysId int
---@param viewTag string
function SystemUnlockViewCtrl:ExeUnlockClick(sysId, viewTag)
    if not string.isnilorempty(viewTag) and UIConf[viewTag] then
        UIMgr.Open(viewTag)
    else
        self:SpecialClick(sysId)
    end
end

---系统未解锁逻辑处理
---@param sysId int
---@param viewTag string
function SystemUnlockViewCtrl:ExeLockClick(sysId, viewTag)
    UICommonUtil.ShowMessage(SysUnLock.LockTips(sysId))
end

---点击之后特殊逻辑处理
---@param sysId int
function SystemUnlockViewCtrl:SpecialClick(sysId)
    if sysId == X3_CFG_CONST.SYSTEM_UNLOCK_ARENA then

    elseif sysId == X3_CFG_CONST.SYSTEM_UNLOCK_PROMISE then
        -- 许愿
        BllMgr.Get("GachaBLL"):OpenGacha()
    elseif sysId == X3_CFG_CONST.SYSTEM_UNLOCK_SHOP then
        -- 商店
        local ShopMallConst = require("Runtime.System.X3Game.GameConst.ShopMallConst")
        UIMgr.Open(UIConf.ShopMainWnd, ShopMallConst.TabType.EXCHANGE)
        -- 公众号
    elseif sysId == X3_CFG_CONST.SYSTEM_UNLOCK_BOARD then
        -- 板娘
        ---@type MainHomeStateData
        local stateData = BllMgr.Get("MainHomeBLL"):GetData()
        local curStateData = stateData:GetStateConf()
        --判断当前状态是否可交互 可交互打开换装界面，不可交互弹出提示
        if curStateData and curStateData.IsInteractive == 1 then
            UICommonUtil.WhiteScreenIn(function()
                local roleID = stateData:GetRoleId()
                UIMgr.Open(UIConf.PlayerFashionWnd, roleID, true)
            end)
        else
            UICommonUtil.ShowMessage(UITextConst.UI_TEXT_9257)
        end
    elseif sysId == X3_CFG_CONST.SYSTEM_UNLOCK_LOVEPOINT then
        -- 好感度
        BllMgr.GetLovePointBLL():OpenWnd()
    elseif sysId == X3_CFG_CONST.SYSTEM_UNLOCK_MODULE then
        if SubPackageDownloadMgr.IsEnable() then
            UIMgr.Open(UIConf.DownloadWnd)
        end
    elseif sysId == X3_CFG_CONST.SYSTEM_UNLOCK_PHONE then
        UIMgr.Open(UIConf.MobileMainWnd, nil, nil, true)
    elseif sysId == X3_CFG_CONST.SYSTEM_UNLOCK_GEMCOREINSTANCE then
        if not BllMgr.GetGemCoreInstanceBLL():IsGemCoreLimit_Message() then
            UIMgr.Open(UIConf.GemCoreWnd, {normalOpen = true})
        end
    elseif sysId == X3_CFG_CONST.SYSTEM_UNLOCK_PHOTOGRAPH_HEADSHOT_AR then
        if Application.IsMobile() then
            DevicePermissionUtility.RequestPermissionHaveTips(PlatformConst.PermissionType.CAMERA, function(success)
                if not success then
                    return
                end
                UIMgr.Open(UIConf.PurikuraARWnd)
            end)
        else

            UIMgr.Open(UIConf.PurikuraARWnd)
        end
        RedPointMgr.Save(2, X3_CFG_CONST.RED_PURIKURAAR_ENTER)
        RedPointMgr.UpdateCount(X3_CFG_CONST.RED_PURIKURAAR_ENTER, 0)
    elseif sysId == X3_CFG_CONST.SYSTEM_UNLOCK_PHOTOGRAPH then
        RedPointMgr.Save(2, X3_CFG_CONST.RED_PURIKURA_ENTER)
        RedPointMgr.UpdateCount(X3_CFG_CONST.RED_PURIKURA_ENTER, 0)
    elseif sysId == X3_CFG_CONST.SYSTEM_UNLOCK_ACTIVITY then
        if (BllMgr.GetActivityCenterBLL():CheckEntryAvailable()) then
            UIMgr.Open(UIConf.ActivityMainWnd)
        else
            UICommonUtil.ShowMessage(UITextConst.UI_TEXT_33027)
        end
    elseif sysId == X3_CFG_CONST.SYSTEM_UNLOCK_TRIAL then
        UIMgr.Open(UIConf.TrialFieldWnd, true)
    end
end

---系统解锁事件监听
---@param sysId int
function SystemUnlockViewCtrl:OnEventSysUnlockUpdate(sysId)
    self:SystemUnLockCheck(sysId)
    RedPointMgr.SysUnlockUpdate(sysId)
end

---注册相关事件
function SystemUnlockViewCtrl:RegisterEvent()
    s_SystemUnlock.AddListener(handler(self, self.OnSysClick), handler(self, self.SystemUnLockCheck))
    EventMgr.AddListener("UnLockSystem", self.OnEventSysUnlockUpdate, self)
end

---销毁逻辑
function SystemUnlockViewCtrl:OnDestroy()
    s_SystemUnlock.RemoveListener()
    self:UnRegisterEvent()
end

---反注册事件
function SystemUnlockViewCtrl:UnRegisterEvent()
    GameUtil.ClearTarget(self)
end
SystemUnlockViewCtrl:Init()

return SystemUnlockViewCtrl
