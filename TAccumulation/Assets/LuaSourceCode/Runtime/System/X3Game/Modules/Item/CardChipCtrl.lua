---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by canghai.
--- DateTime: 2022/8/31 10:23
---

---@type ItemSubCtrl
local ItemSubCtrl = require(ItemConst.ITEM_SUB_CTRL_PATH)

---@type CardChipData
local CardChipData = require(ItemConst.ITEM_CARD_CHIP_DATA_PATH)

---@class CardChipCtrl:ItemSubCtrl
local CardChipCtrl = class("CardChipCtrl", ItemSubCtrl)
function CardChipCtrl:Init()
    ---@type CardChipData
    self.cardChipData = nil
end

---@return ItemConst.ItemType
function CardChipCtrl:GetItemType()
    return ItemConst.ItemType.CARD_CHIP
end

--- 修改 CardChipData
---@param dataEnum ItemConst.DataEnum
---@param value any
function CardChipCtrl:SetData(dataEnum, value)
    --保证每次取到的数据都是最新的
    ---@type ItemCtrl
    local owner = self.owner
    self.cardChipData = owner.itemData.itemSubDataDic[ItemConst.ItemType.CARD_CHIP]

    local cardChipData = self.cardChipData
    local setDataFunc = CardChipData.SetDataFuncDic[dataEnum]
    if setDataFunc then
        setDataFunc(cardChipData, value)
    end
    self:UpdateView()
end

function CardChipCtrl:UpdateView()
    --保证每次取到的数据都是最新的
    ---@type ItemCtrl
    local owner = self.owner
    self.cardChipData = owner.itemData.itemSubDataDic[ItemConst.ItemType.CARD_CHIP]

    ---@type CardChipData
    local cardChipData = self.cardChipData
    if not cardChipData.isDirty then
        return
    end

    -- 标准显示流程
    self:_ShowIcon()
    self:_ShowQuality()
    self:_ShowPosInfo()
    self:_ShowNumber()
    self:_ShowBattleTag()

    cardChipData.isDirty = false
end

--region Private Field
function CardChipCtrl:_ShowIcon()
    self:SetActiveStatus(ItemConst.OCX_CARD_CHIP_IMG_ICON, true)
    ---@type CardChipData
    local cardChipData = self.cardChipData
    self:SetImage(ItemConst.OCX_CARD_CHIP_IMG_ICON, cardChipData.connectItemConfig.Icon)
end

function CardChipCtrl:_ShowQuality()
    self:SetActiveStatus(ItemConst.OCX_CARD_CHIP_IMG_QUALITY, true)
    ---@type CardChipData
    local cardChipData = self.cardChipData
    local _, qualityBG = DevelopHelper.GetCardRarityIconInfo(cardChipData.cardBaseInfoConfig.Quality)
    self:SetImage(ItemConst.OCX_CARD_CHIP_IMG_QUALITY, qualityBG)
end

function CardChipCtrl:_ShowPosInfo()
    self:SetActiveStatus(ItemConst.OCX_CARD_CHIP_OBJ_POSITION, true)
    ---@type CardChipData
    local cardChipData = self.cardChipData
    self:SetValue(ItemConst.OCX_CARD_CHIP_OBJ_POSITION, cardChipData.cardBaseInfoConfig.PosType - 1)
end

function CardChipCtrl:_ShowNumber()
    local isShow = (self.cardChipData.cardChip_Num ~= nil)
    self:SetActiveStatus(ItemConst.OCX_CARD_CHIP_TXT_NUM, isShow)
    if isShow then
        self:SetText(ItemConst.OCX_CARD_CHIP_TXT_NUM, tostring(self.cardChipData.cardChip_Num))
    end
end

function CardChipCtrl:_ShowBattleTag()
    self:SetActiveStatus(ItemConst.OCX_CARD_CHIP_ICON_BATTLE_TAG_01, true)
    ---@type CardChipData
    local cardChipData = self.cardChipData
    local tagId = cardChipData.cardBaseInfoConfig.FormationTag
    local formationTag = LuaCfgMgr.Get("FormationTag", tagId)
    self:SetImage(ItemConst.OCX_CARD_CHIP_ICON_BATTLE_TAG_01, formationTag.TagImg)
end

function CardChipCtrl:OnClose()
    self.cardChipData = nil
    X3AssetInsProvider.ReleaseIns(self.gameObject)
end
--endregion

return CardChipCtrl