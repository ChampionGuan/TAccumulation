---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by fusu.
--- DateTime: 2023/4/6 14:07
---

local AccompanyConst = require("Runtime.System.X3Game.Modules.Accompany.Data.AccompanyConst")
local AccompanyBaseAction = require("Runtime.System.X3Game.Modules.Accompany.Action.AccompanyBaseAction")

---@class AccompanyRandomDialogueAction : AccompanyBaseAction
local AccompanyRandomDialogueAction = class("AccompanyRandomDialogueAction" , AccompanyBaseAction)

function AccompanyRandomDialogueAction:Init(actionParam)
    ---最小时间
    ---@type int 
    self._minTime = nil
    ---最大时间
    ---@type int
    self._maxTime = nil
    ---@type int
    self._timer = nil
end

function AccompanyRandomDialogueAction:OnConditionPass()
    self._minTime = self.accMgr.accBll:GetConfigDataByKey("DurationMin")
    self._maxTime = self.accMgr.accBll:GetConfigDataByKey("DurationMax")
    if self._maxTime - self._minTime < 0 then
        return
    end
    self._randomDConversation = self.accMgr.accBll:GetConfigDataByKey("StateConversation")
    if string.isnilorempty(self._randomDConversation) then
        return
    end
    
    self:_PlayRandomDialogue()
end

function AccompanyRandomDialogueAction:_PlayRandomDialogue()
    local randomTime = math.random(self._minTime , self._maxTime)
    if self._timer then
        TimerMgr.Discard(self._timer)
        self._timer = nil
    end
    self._timer = TimerMgr.AddTimer(randomTime , self._Play , self)
end

function AccompanyRandomDialogueAction:_Play()
    ---@type AccompanyDialogueCtrl
    local dialogueCtrl = self.accMgr:GetCtrl(AccompanyConst.CtrlType.DialogueCtrl)
    dialogueCtrl:StartDialogueByQueue(self._randomDConversation, AccompanyConst.AccompanyDialogueIdType.AccompanyDialogueId , nil , "StateConversation",function()
        ---重复播放
        self:_PlayRandomDialogue()
    end)
end

function AccompanyRandomDialogueAction:OnDestroy()
    AccompanyRandomDialogueAction.super.OnDestroy(self)
    if self._timer then
        TimerMgr.Discard(self._timer)
    end
    self._timer = nil
end

return AccompanyRandomDialogueAction