---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by fusu.
--- DateTime: 2023/4/6 14:07
---

local AccompanyConst = require("Runtime.System.X3Game.Modules.Accompany.Data.AccompanyConst")
local AccompanyBaseAction = require("Runtime.System.X3Game.Modules.Accompany.Action.AccompanyBaseAction")

---@class AccompanyStartAction : AccompanyBaseAction
local AccompanyStartAction = class("AccompanyStartAction" , AccompanyBaseAction)

function AccompanyStartAction:Init(actionParam)
    ---陪伴换装剧情key
    ---@type string
    self._dataKey = actionParam[1]

    EventMgr.AddListener(AccompanyConst.Event.ON_START_ACCOMPANY_REPLY, self._OnStartAccompany, self)
end

---条件通过执行
function AccompanyStartAction:OnConditionPass()
    self:_SendStartAccompany()
end

---条件不同过执行
function AccompanyStartAction:OnConditionNoPass()
    self._conversationName = self.accMgr.accBll:GetConfigDataByKey(self._dataKey)
    if not string.isnilorempty(self._conversationName) then
        ---@type AccompanyDialogueCtrl
        local dialogueCtrl = self.accMgr:GetCtrl(AccompanyConst.CtrlType.DialogueCtrl)
        dialogueCtrl:StartDialogueByName(self._conversationName, AccompanyConst.AccompanyDialogueIdType.AccompanyDialogueId , nil , function()
            self:_SendStartAccompany()
        end)
    else
        self:_SendStartAccompany()
    end
end

---发送消息开始陪伴
function AccompanyStartAction:_SendStartAccompany()
    local bll = BllMgr.GetAccompanyBLL()
    local curRoleId = bll:GetCurRoleId()
    local accompanyType = bll:GetCurAccompanyType()
    local curTime = bll:GetAccompanyTime()
    bll:Send_StartAccompanyRequest(curRoleId, accompanyType, curTime)
end

function AccompanyStartAction:_OnStartAccompany()
    self:OnFinish()
    local stateCtrl = self.accMgr:GetCtrl(AccompanyConst.CtrlType.StateCtrl)
    stateCtrl:ChangeState(AccompanyConst.StateType.InteractState)
end

return AccompanyStartAction