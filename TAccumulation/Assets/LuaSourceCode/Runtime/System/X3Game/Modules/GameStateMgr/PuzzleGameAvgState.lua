---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xiaofang.
--- DateTime: 2023/7/27 19:37

---@type BaseGameState
local BaseGameState = require("Runtime.System.X3Game.Modules.GameStateMgr.BaseGameState")
---@class PuzzleGameAvgState
local PuzzleGameAvgState = class("PuzzleGameAvgState", BaseGameState)
---@type ActivityScoreConst
local ActivityScoreConst = require("Runtime.System.X3Game.Modules.Activity.ActivityScore.Data.ActivityScoreConst")

---@param dialogId int
---@param conversationId string
---@param callBack function
function PuzzleGameAvgState:OnEnter(stateName, dialogId, conversationId, callBack)
    Debug.LogFormat("PreStateName= %s,CurStateName===%s", stateName, "PuzzleGameAvg")
    self.callBack = callBack
    self.dialogId = dialogId
    self.conversationId = conversationId
    EventMgr.AddListener(ActivityScoreConst.Event.ON_EXIT_PUZZLE_GAME_AVG_EVENT, self.ExitDialog, self)
    self:InitDialogue()
end

function PuzzleGameAvgState:InitDialogue()
    self.virtualCamera = GlobalCameraMgr.CreateVirtualCamera(CameraModePath.AutoSyncMode)
    self.dialogueController = DialogueManager.InitByName("PuzzleGameAvg")
    self.system = self.dialogueController:InitDialogue(self.dialogId, Mathf.Random(1, 10000), nil, function()
        self.dialogueController:StartDialogueById(self.dialogId, self.conversationId, nil, nil, function()
            self:OnExit()
        end)
    end)
    --self.system:SwitchAuto(true)
    local settingData = self.system:GetSettingData()
    settingData:SetShowReviewButton(true)
    settingData:SetShowPauseButton(true)
    settingData:SetShowClickBg(false)
    UIMgr.Open(UIConf.ActivityCard_AVG)
end

function PuzzleGameAvgState:ExitDialog()
    if self.system then
        self.system:ExitDialogue()
    end
    self:OnExit()
end

function PuzzleGameAvgState:OnExit()
    DialogueManager.ClearByName("PuzzleGameAvg")
    if self.callBack then
        self.callBack()
        self.callBack = nil
    end
    if self.virtualCamera then
        GlobalCameraMgr.DestroyVirtualCamera(self.virtualCamera)
    end
    GameStateMgr.Switch(GameState.MainHome, nil, true)
    self.super.OnExit(self)
end

return PuzzleGameAvgState