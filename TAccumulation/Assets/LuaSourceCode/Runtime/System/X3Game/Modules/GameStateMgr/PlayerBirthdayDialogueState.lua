---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by sms.
--- DateTime: 2023/4/6 15:14
---@type BaseGameState
local BaseGameState = require("Runtime.System.X3Game.Modules.GameStateMgr.BaseGameState")
---@class PlayerBirthdayDialogueState
local PlayerBirthdayDialogueState = class("PlayerBirthdayDialogueState", BaseGameState)

function PlayerBirthdayDialogueState:ctor()

end

---@class PlayerBirthdayDialogueStateOpenParam
---@field roleId number 必传 角色id
---@field anniversary number 可选 不传入时用当前所在周年数

---@param enterParam PlayerBirthdayDialogueStateOpenParam
---@param callBack function
function PlayerBirthdayDialogueState:OnEnter(stateName, enterParam, callBack)
    if not enterParam or not enterParam.roleId then Debug.LogError("PlayerBirthdayDialogueState Open Param Erro -- " .. table.dump(enterParam or {})) return end
    
    local roleId = enterParam.roleId
    local curAnniversary = BllMgr.GetPlayerBirthdayBLL():GetCurAnniversary()
    local anniversary = enterParam.anniversary or curAnniversary
    self.endCallback = enterParam.endCallback
    
    -- 是否为当前周年
    local isCurYear = anniversary == curAnniversary
    
    local curBirthdayStoryCfg = LuaCfgMgr.GetDataByCondition("MyBirthdayStory", {Role = roleId, Anniversary = anniversary})
    if not curBirthdayStoryCfg then Debug.LogError("curBirthdayStoryCfg not found ? " .. table.dump(roleId, anniversary)) return end

    DateManager.DateStart(DateType.PlayerBirthday, {dialogueID = curBirthdayStoryCfg.DialogueID, roleId = roleId, isCurYear = isCurYear}, function()
        -- 设置剧情已读标记
        if isCurYear then BllMgr.GetPlayerBirthdayBLL():SetDialogueRead(roleId) end
    end, GameConst.LoadingType.None)
end

function PlayerBirthdayDialogueState:OnExit()
    self.super.OnExit(self)
    
    DateManager.DateClear()
    
    UIMgr.Open(UIConf.PlayerBirthdayWnd, {
        onMoveInCallback = function()
            if self.endCallback then self.endCallback() self.endCallback = nil end
        end
    })
end

return PlayerBirthdayDialogueState