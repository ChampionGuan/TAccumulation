---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by kan.
--- DateTime: 2021/12/6 11:53
---

---@class JewelShopUtil
local JewelShopUtil = {}

local id = 0
local eventDic = {} --fun()

---初始化
function JewelShopUtil.Init()
    JewelShopUtil.Clear()
end

---购买
---@param itemID int 购买物品ID
---@param num int 购买物品数量
---@param callback fun(result:boolean) 购买回调
---@param followUpHandle fun 兑换成功回调
function JewelShopUtil.Buy(itemID, num, callback, followUpHandle, showResource)
    local canBuy,buyInfo = JewelShopUtil.ItemCanBuy(itemID)
    if not canBuy then
        if callback then callback(false) end
        return
    end

    num = num or 1

    local totalJewel = buyInfo.Costdiamond * num
    local itemCfg = LuaCfgMgr.Get("Item", itemID)

    local consume = {
        ID = 2, -- 粉钻
        Num = totalJewel,
    }

    local curJewel = BllMgr.Get("PlayerBLL"):GetPlayerCoin().Jewel
    local isEnough = curJewel >= totalJewel

    local enterCB = function()
        if isEnough then
            JewelShopUtil.sendBuyMessage(itemID, num, callback)
        else
            --钻石不足，提示兑换
            UICommonUtil.BuyItemWithJewel(totalJewel, followUpHandle)
        end
    end

    if showResource then
        UIMgr.Open(UIConf.Message2Box, nil, showResource, UITextHelper.GetUIText(UITextConst.UI_TEXT_5790, num, UITextHelper.GetUIText(itemCfg.Name), totalJewel), {
            {btn_type = GameConst.MessageBoxBtnType.CONFIRM, btn_call = enterCB},
            {btn_type = GameConst.MessageBoxBtnType.CANCEL}
        })
    else
        UICommonUtil.ShowMessageBox(UITextHelper.GetUIText(UITextConst.UI_TEXT_5790, num, UITextHelper.GetUIText(itemCfg.Name), totalJewel), {
            {btn_type = GameConst.MessageBoxBtnType.CONFIRM, btn_call = enterCB},
            {btn_type = GameConst.MessageBoxBtnType.CANCEL}
        })
    end
end

function JewelShopUtil.showStarJewelExChangeJewelTips(needAmount)
    --local enterCB = function()
        --UIMgr.Open(UIConf.JewelShortcutConverWnd, needAmount)
    --end
    UICommonUtil.BuyItemWithJewel(needAmount)

    --local curJewel = BllMgr.Get("PlayerBLL"):GetPlayerCoin().Jewel
    --UICommonUtil.ShowMessageBox(UITextHelper.GetUIText(5791, needAmount - curJewel) , {
    --    {btn_type = GameConst.MessageBoxBtnType.CONFIRM, btn_call = enterCB},
    --    {btn_type = GameConst.MessageBoxBtnType.CANCEL}
    --}, AutoCloseMode.None)
end

function JewelShopUtil.sendBuyMessage(itemID, num, callback)
    id = id + 1
    eventDic[id] = callback

    local item = {Id = itemID,Num = num}

    local messageBody = {}
    messageBody.BuyList = {item}
    messageBody.Extra = id

    GrpcMgr.SendRequest(RpcDefines.BuyItemByJewelRequest,messageBody)
end

---是否可以购买该物品
---@param itemID int 需购买物品的ID
---@return boolean,ItemCommonBuy
function JewelShopUtil.ItemCanBuy(itemID)
    local buyInfo = LuaCfgMgr.Get("ItemCommonBuy",itemID)
    if buyInfo == nil then
        return false,buyInfo
    end

    return true,buyInfo
end

---购买结果回调
---@param data table
function JewelShopUtil.BuyCallBack(data)
    if not eventDic[id] then return end

    eventDic[id](true)

    eventDic[id] = nil
end

function JewelShopUtil.Clear()
    id = 0
    eventDic = {}
end

return JewelShopUtil
