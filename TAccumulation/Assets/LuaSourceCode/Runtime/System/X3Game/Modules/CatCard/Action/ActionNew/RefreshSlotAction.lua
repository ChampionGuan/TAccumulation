---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by hongyun.
--- DateTime: 2022/6/8 18:27
---

---@type CatCardConst
local CatCardConst = require("Runtime.System.X3Game.Modules.CatCard.Data.CatCardConst")

---@type CatCard.CatCardBaseAction
local BaseAction = require(CatCardConst.BASE_ACTION_PATH_NEW)

---刷新格子的Action（拆迁喵，变小喵）
---@class CatCard.RefreshSlotAction:CatCard.CatCardBaseAction
local RefreshSlotAction = class("RefreshSlotAction",BaseAction)

---@param actionData CatCard.RefreshSlotActionData
function RefreshSlotAction:Begin(actionData)
    self.playerType = actionData:GetPlayerType()
    if self.playerType == CatCardConst.PlayerType.PLAYER then
        ---女主不需要随机选格子
        self:RefreshSlot()
    else
        ---男主模拟随机选格子
        local CatCardConst = require("Runtime.System.X3Game.Modules.CatCard.Data.CatCardConst")
        ---@type CatCard.RandomSelectSlotActionData
        local randomSelectSlotActionData = BllMgr.GetCatCardBLL():GetActionData(CatCardConst.ActionType.RandomSelectSlot,CatCardConst.PlayerType.ENEMY, function()
            self:RefreshSlot()
        end)

        local funcCardType = CatCardConst.FuncCardType.SMALLCARD ---变小喵
        local effectType = actionData:GetEffectType()
        if effectType == CatCardConst.FuncEffectType.Demolish then
            funcCardType = CatCardConst.FuncCardType.REMOVECARD ---拆迁喵
        end
        local finalSlot = actionData:GetSlotIndex()
        randomSelectSlotActionData:Set(funcCardType,finalSlot)
        randomSelectSlotActionData:Begin()
    end



end

---刷新格子
function RefreshSlotAction:RefreshSlot()
    local actionData = self:GetData()
    local slotIndex = actionData:GetSlotIndex()
    EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_REFRESH_MODEL,CatCardConst.CardType.SLOT,slotIndex,actionData:GetPlayerType())

    ---播放音效
    self.bll:CheckSound(CatCardConst.SoundType.DEFAULT,CatCardConst.Sound.SYSTEM_MIAO_SMOKE)

    ---播放UI特效
    ---@type CatCard.EffectActionData
    local effectAction = self.bll:GetActionData(CatCardConst.ActionType.EffectAction)
    effectAction:Set(CatCardConst.EffectState.SHOW,CatCardConst.Effect.MODEL_APPEAR_UI,slotIndex,CatCardConst.CardType.SLOT)
    effectAction:Begin()
    if self.playerType == CatCardConst.PlayerType.ENEMY then
        self.bll:SetChangeSlotEvent(slotIndex)
    end
    local changeSlot = self.bll:GetChangeSlot()
    if changeSlot then
        self.bll:DoChangeSlotEvent(self.playerType == CatCardConst.PlayerType.PLAYER and CatCardConst.PlayerType.ENEMY or CatCardConst.PlayerType.PLAYER)
    end
    self:End()
end

---结束
function RefreshSlotAction:End()
    BaseAction.End(self)
end

return RefreshSlotAction