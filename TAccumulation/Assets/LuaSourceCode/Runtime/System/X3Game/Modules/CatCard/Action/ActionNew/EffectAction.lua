---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiaozhu.
--- DateTime: 2022/6/2 11:09
--- 特效相关，3d/ui
---@type CatCardConst
local CatCardConst = require("Runtime.System.X3Game.Modules.CatCard.Data.CatCardConst")
---@type CatCard.CatCardBaseAction
local BaseAction = require(CatCardConst.BASE_ACTION_PATH_NEW)
---@class CatCard.EffectAction:CatCard.CatCardBaseAction
local EffectAction = class("EffectAction", BaseAction)

---@param action_data CatCard.EffectActionData
function EffectAction:Begin(action_data)
    local card_type = action_data:GetCardType()
    local player_type = action_data:GetPlayerType()
    local effect_name = action_data:GetEffectName()
    local state = action_data:GetState()
    local idx = action_data:GetPosIdx()
    local showType = action_data:GetShowType()
    if action_data:GetShowType() == CatCardConst.EffectShowType.ByIndex then
        local model = self:GetModel(card_type, idx, player_type)
        if action_data:IsUI() then
            self:ShowUIEffect(state, idx, effect_name, model:GetEffectPos())
        else
            self:Show3DEffect(state, effect_name, model:GetEffectParent(action_data:GetEffectParentName()))
        end
    elseif showType == CatCardConst.EffectShowType.ByTarget then
        local obj = action_data:GetTarget()
        if not obj then
            Debug.LogErrorFormat("[喵喵牌] EffectAction target is nil")
        else
            if action_data:IsUI() then
                self:ShowUIEffect(state, idx, effect_name, GameObjectUtil.GetPosition(obj))
            else
                local trans = GameObjectUtil.GetComponent(obj, "", "Transform")
                self:Show3DEffect(state, effect_name, trans.parent)
            end
        end
    else
        local funcCardType = action_data:GetFuncCardType()
        local config = CatCardConst.FuncCardEffectConfig[funcCardType]
        if config then
            self:ShowGlobalEffect(state, config.effect, config.key)
        end
    end

    self:End()
end

---@param effect_state CatCardConst.EffectState
---@param idx int
---@param effect_name CatCardConst.Effect
---@param pos Vector3
function EffectAction:ShowUIEffect(effect_state, idx, effect_name, pos)
    EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_CHECK_UI_EFFECT, effect_state, idx, effect_name, pos)
end

---@param effect_state CatCardConst.EffectState
---@param effect_name CatCardConst.Effect
---@param effect_parent GameObject
function EffectAction:Show3DEffect(effect_state, effect_name, effect_parent)
    self.bll:CheckEffect(CatCardConst.EffectType.DEFAULT, effect_state, effect_name, effect_parent)
end

---@param effectState CatCardConst.EffectState
---@param effectName string
---@param animName string
function EffectAction:ShowGlobalEffect(effectState, effectName, animName)
    EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_SHOW_FUNC_EFFECT_EVENT, effectState, effectName, animName)
end

return EffectAction