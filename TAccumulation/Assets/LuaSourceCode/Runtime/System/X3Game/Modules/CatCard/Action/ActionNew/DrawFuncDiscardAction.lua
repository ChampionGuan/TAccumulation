---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by hongyun.
--- DateTime: 2022/7/18 19:39
---

---@type CatCardConst
local CatCardConst = require("Runtime.System.X3Game.Modules.CatCard.Data.CatCardConst")

---@type CatCard.CatCardBaseAction
local BaseAction = require(CatCardConst.BASE_ACTION_PATH_NEW)

---抽功能牌然后丢弃的Action
---@class CatCard.DrawFuncDiscardAction:CatCard.CatCardBaseAction
local DrawFuncDiscardAction = class("DrawFuncDiscardAction", BaseAction)

---@param actionData CatCard.DrawFuncDiscardActionData
function DrawFuncDiscardAction:Begin(actionData)


    local cards = actionData:GetCards()

    ---创建出要丢弃的牌的模型 放到功能牌堆下
    local data = self.bll:GenData(CatCardConst.CardType.CARD, cards[1])
    self.modelName = data:GetCardModel()
    self.model = self:LoadModel(self.modelName)
    self:AddModelToShow(self.modelName, self.model)
    self.bll:CheckSound(CatCardConst.SoundType.DEFAULT, CatCardConst.Sound.SYSTEM_MIAO_CARDEXPLODE)
    --GameObjectUtil.SetLayer(self.model,Const.LayerMask.RT,true)

    local modelParent = self.logicCtrl:GetStackPosNode(CatCardConst.SubType.FUNCCARD)
    GameObjectUtil.SetParent(GameObjectUtil.GetComponent(self.model, "", "Transform"), GameObjectUtil.GetComponent(modelParent, "", "Transform"))

    ---飞到弃牌堆
    local playerType = actionData:GetPlayerType()
    local discardTarget = self.logicCtrl:GetDiscardStackNode(playerType)

    local aniState = CatCardConst.AnimationState.MOVE
            | CatCardConst.AnimationState.SCALE
            | CatCardConst.AnimationState.ROTATION_X
            | CatCardConst.AnimationState.ROTATION_Y

    self.bll:CheckAnimation(
            CatCardConst.AnimationType.MOVE_MODEL,
            aniState,
            self.model,
            discardTarget,
            actionData:GetSpeed(),
            handler(self, self.MoveEnd),
            actionData:GetMoveEasyType(),
            actionData:GetRotationDt(),
            actionData:GetRotationEasyType(),
            actionData:GetScaleDt(),
            actionData:GetScaleEasyType()
    )

end

---移动结束 翻面
function DrawFuncDiscardAction:MoveEnd()

    ---@type CatCard.DrawFuncDiscardActionData
    local actionData = self:GetData()

    ---翻面
    local playerType = actionData:GetPlayerType()
    local discardTarget = self.logicCtrl:GetDiscardStackNode(playerType)
    local aniState = CatCardConst.AnimationState.ROTATION_Z

    self.bll:CheckAnimation(
            CatCardConst.AnimationType.MOVE_MODEL,
            aniState,
            self.model,
            discardTarget,
            actionData:GetSpeed(),
            handler(self, self.RotationEnd),
            actionData:GetMoveEasyType(),
            actionData:GetRotationDt(),
            actionData:GetRotationEasyType()
    )

end

---翻面结束 播放销毁特效 销毁卡牌
function DrawFuncDiscardAction:RotationEnd()

    ---播放特效
    self:PlayDestroyEffect(CatCardConst.EffectState.SHOW)
    UICommonUtil.ShowMessage(UITextConst.UI_TEXT_35000, CatCardConst.MAX_CARD_COUNT)
    ---一段时间后销毁卡牌
    TimerMgr.AddTimer(CatCardConst.FUNC_CARD_DESTROY.TIME, function()
        self:ReleaseModel(self.modelName, self.model)
    end)

    ---再一段时间后隐藏特效
    TimerMgr.AddTimer(CatCardConst.FUNC_CARD_DESTROY.EFFECT_TIME, function()
        self:PlayDestroyEffect(CatCardConst.EffectState.HIDE)
        self:End()
    end)
end

---播放/隐藏销毁特效
function DrawFuncDiscardAction:PlayDestroyEffect(state)
    ---@type CatCard.EffectActionData
    local effectActionData = BllMgr.GetCatCardBLL():GetActionData(CatCardConst.ActionType.EffectAction, CatCardConst.PlayerType.PLAYER)
    effectActionData:Set(state, CatCardConst.Effect.CARD_DESTROY)
    effectActionData:SetShowType(CatCardConst.EffectShowType.ByTarget)
    effectActionData:SetTarget(self.model)
    effectActionData:Begin()
end

function DrawFuncDiscardAction:End()
    self.model = nil

    BaseAction.End(self)
end

return DrawFuncDiscardAction
