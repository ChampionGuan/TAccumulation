---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xiaofang.
--- DateTime: 2022/6/7 20:06
---@type CatCardConst
local CatCardConst = require("Runtime.System.X3Game.Modules.CatCard.Data.CatCardConst")
-----@type CatCard.CatCardBaseAction
local BaseAction = require(CatCardConst.BASE_ACTION_PATH_NEW)
-----@class CatCard.RemoveBuffAction:CatCard.CatCardBaseAction
local RemoveBuffAction = class("RemoveBuffAction", BaseAction)

---@param action_data CatCard.RemoveBuffData
function RemoveBuffAction:Begin(action_data)
    self.buffId = action_data:GetBuffID()
    self.playerType = action_data:GetPlayerType()
    self:RemoveBuff(self.buffId)
end

function RemoveBuffAction:RemoveBuff(buffId)
    local buffCfg = LuaCfgMgr.Get("MiaoBuff", buffId)
    local delayTime = buffCfg and buffCfg.DeleteBuffTime or 0
    local remindTime = buffCfg and buffCfg.RemindTime or 0
    if delayTime > 0 then
        TimerMgr.AddTimer(buffCfg.DeleteBuffTime, function()
            if buffId == CatCardConst.BuffType.PassCard and self.playerType == CatCardConst.PlayerType.ENEMY then
                --男主有跳过buff，增加假的选牌提示显示，增加需重置标识
                self.isReset = true
                self.bll:GetStateData():ChangePopState(CatCardConst.PopCardState.PopNum)
                EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_REFRESH_TIPS)
                if remindTime > 0 then
                    TimerMgr.AddTimer(remindTime, function()
                        self:ConfirmRemove(buffId)
                    end)
                else
                    self:ConfirmRemove(buffId)
                end
            else
                self:ConfirmRemove(buffId)
            end

        end)
    else
        self:ConfirmRemove(buffId)
    end
end

function RemoveBuffAction:ConfirmRemove(buffId)
    self.bll:GetStateData():RemoveBuffCache(self.playerType, buffId)
    if buffId == CatCardConst.BuffType.ExciteCard then
        --移除时消失
        EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_REFRESH_TOAST, buffId, self.playerType, false)
        self:End()
    else
        --移除时表现
        EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_REFRESH_TOAST, buffId, self.playerType, true, handler(self, self.End))
    end
end

function RemoveBuffAction:End()
    if self.isReset then
        self.bll:GetStateData():ChangePopState(CatCardConst.PopCardState.None)
        EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_REFRESH_TIPS)
    end
    BaseAction.End(self)
end

return RemoveBuffAction