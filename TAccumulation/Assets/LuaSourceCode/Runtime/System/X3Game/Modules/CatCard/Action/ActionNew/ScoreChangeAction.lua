---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xiaofang.
--- DateTime: 2022/7/29 11:05
---@type CatCardConst
local CatCardConst = require("Runtime.System.X3Game.Modules.CatCard.Data.CatCardConst")
-----@type CatCard.CatCardBaseAction
local BaseAction = require(CatCardConst.BASE_ACTION_PATH_NEW)
-----@class CatCard.ScoreChangeAction:CatCard.CatCardBaseAction
local ScoreChangeAction = class("ScoreChangeAction", BaseAction)

---@param actionData CatCard.ScoreChangeActionData
function ScoreChangeAction:Begin(actionData)
    self.playerType = actionData:GetPlayerType()
    self.changeType = actionData:GetChangeType()
    ---存储双方分数，以便做分差展示
    for i, playerType in pairs(CatCardConst.PlayerType) do
        local score = self.bll:GetScore(playerType)
        self.bll:SaveScore(score, playerType)
    end
    self:ShowScoreSwitch()
    EventMgr.AddListener(CatCardConst.Event.CAT_CARD_CHANGE_SCORE_EVENT, self.ShowScoreSwitch, self)
end

function ScoreChangeAction:ShowScoreSwitch()
    --选择的格子索引
    local selectIndex = self.actionData:GetChangeIndex()
    if self.changeType == CatCardConst.CardType.CARD then
        if self.lastCardId and self.lastSelectIndex then
            --恢复上次选中格子的数据
            ---@type SlotData
            local lastSlotData = self.bll:GetData(CatCardConst.CardType.SLOT, self.lastSelectIndex)
            lastSlotData:SetCardId(self.lastCardId)
        end

        --修改的卡片id，即修改槽位上的卡(变小喵，拆迁喵)
        local cardID = self.actionData:GetChangeID()
        --槽位上的数据
        ---@type SlotData
        local slotData = self.bll:GetData(CatCardConst.CardType.SLOT, selectIndex)
        self.lastCardId = slotData:GetCardId()
        self.lastSelectIndex = selectIndex
        if cardID == 0 then
            --代表移除已放置的喵
            local cardData = self.bll:GenData(CatCardConst.CardType.CARD, self.lastCardId)
            self.changeScore = cardData:GetNum() * -1
            self.bll:ReleaseData(cardData)
            slotData:SetCardId(0)
        else
            --代表更改已放置的喵
            slotData:SetCardId(cardID)
            self.changeScore = cardID - self.lastCardId
        end
        if slotData:IsDoubleSlot() then
            self.changeScore = self.changeScore * 2
        end
        self.actionData:SetChangeScore(self.changeScore)
    else
        local slotData = self.bll:GetData(CatCardConst.CardType.SLOT, selectIndex)
        --修改杯子颜色（变色喵）
        --local slotID = self.actionData:GetChangeID()
        --slotData:SetId(slotID)
    end
    if self.actionData:GetShowScoreSwitch() then
        EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_SET_VIEW_ACTIVE, CatCardConst.ViewType.SWITCH, true, true)
    end
end

function ScoreChangeAction:End()
    EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_SET_VIEW_ACTIVE, CatCardConst.ViewType.SWITCH, false)
    BaseAction.End(self)
end

return ScoreChangeAction