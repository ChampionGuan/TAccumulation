---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by hongyun.
--- DateTime: 2022/6/10 15:00
---

---@type CatCardConst
local CatCardConst = require("Runtime.System.X3Game.Modules.CatCard.Data.CatCardConst")

---@type CatCard.CatCardBaseAction
local BaseAction = require(CatCardConst.BASE_ACTION_PATH_NEW)

---丢弃双方所有手牌的Action
---@class CatCard.BankruptAction:CatCard.CatCardBaseAction
local BankruptAction = class("BankruptAction", BaseAction)

---@param actionData CatCard.BankruptActionData
function BankruptAction:Begin(actionData)


    ---获取双方的数字手牌列表
    local playerHandCardList, enemyHandCardList = self:GetHandCardList()

    if #playerHandCardList == 0 and #enemyHandCardList == 0 then
        ---双方都没数字牌需要丢弃 直接结束
        --self.bll:ApplySavedMsg()
        PoolUtil.ReleaseTable(playerHandCardList)
        PoolUtil.ReleaseTable(enemyHandCardList)
        local cardType = actionData:GetCardType()
        EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_REFRESH_MODELS, cardType)
        EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_SET_MODEL_CAN_SELECT, false, CatCardConst.CardType.CARD, nil, CatCardConst.PlayerType.PLAYER)
        self:End()
        return
    end
    self.bll:SetCardMode(CatCardConst.CardMode.Old)
    local isNeedCheckMask = actionData:GetPlayerType() == CatCardConst.PlayerType.ENEMY and #playerHandCardList>0
    ---播放销毁特效
    if isNeedCheckMask then
        EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_SET_CARD_MASK_ACTIVE,false)
    end
    self:PlayDestroyEffect(playerHandCardList, enemyHandCardList, CatCardConst.EffectState.SHOW)
    
    self.bll:CheckSound(CatCardConst.SoundType.DEFAULT, CatCardConst.Sound.SYSTEM_MIAO_CARDBANKRUPT)
    TimerMgr.AddTimer(CatCardConst.BANKRUPT.TIME, function()
        ---删除手牌模型
        for i, v in ipairs(playerHandCardList) do
            self:RemoveModel(CatCardConst.CardType.CARD, v, CatCardConst.PlayerType.PLAYER)
        end

        for i, v in ipairs(enemyHandCardList) do
            self:RemoveModel(CatCardConst.CardType.CARD, v, CatCardConst.PlayerType.ENEMY)
        end
        if isNeedCheckMask then
            EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_SET_CARD_MASK_ACTIVE,true)
        end
    end,self)

    TimerMgr.AddTimer(CatCardConst.BANKRUPT.EFFECT_TIME, function()
        --- 隐藏特效
        self:PlayDestroyEffect(playerHandCardList, enemyHandCardList, CatCardConst.EffectState.HIDE)

        --- 刷新手牌
        --self.bll:ApplySavedMsg()
        local cardType = actionData:GetCardType()
        EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_REFRESH_MODELS, cardType)
        EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_SET_MODEL_CAN_SELECT, false, CatCardConst.CardType.CARD, nil, CatCardConst.PlayerType.PLAYER)
        PoolUtil.ReleaseTable(playerHandCardList)
        PoolUtil.ReleaseTable(enemyHandCardList)
        self:End()
    end,self)

end

---获取玩家和男主的数字手牌列表
function BankruptAction:GetHandCardList()

    ---玩家的所有数字手牌
    local playerHandCardList = self:GetOldCardIndexList(CatCardConst.PlayerType.PLAYER)
    ---男主的所有数字首批
    local enemyHandCardList = self:GetOldCardIndexList(CatCardConst.PlayerType.ENEMY)

    return playerHandCardList, enemyHandCardList
end

---@param playerType CatCardConst.PlayerType
function BankruptAction:GetOldCardIndexList(playerType)
    local res = PoolUtil.GetTable()
    local cardMap = self.bll:GetOldCardList(playerType)
    if cardMap then
        for k,v in pairs(cardMap) do
            local data = self.bll:GenData(CatCardConst.CardType.CARD,v,k)
            if not data:IsFuncCard() then
                table.insert(res,k)
            end
            self.bll:ReleaseData(data)
        end
    end
    return res
end

---播放/隐藏双方手牌销毁特效
function BankruptAction:PlayDestroyEffect(playerCards, enemyCards, state)
    for i, index in ipairs(playerCards) do
        if state == CatCardConst.EffectState.SHOW then
            ---播放销毁特效前 玩家手牌需要进入选中状态
            EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_SET_MODEL_SELECT, true, CatCardConst.CardType.CARD, index, CatCardConst.PlayerType.PLAYER)
        end

        -----@type CatCard.EffectActionData
        local effectActionData = BllMgr.GetCatCardBLL():GetActionData(CatCardConst.ActionType.EffectAction, CatCardConst.PlayerType.PLAYER)
        effectActionData:Set(state, CatCardConst.Effect.CARD_DESTROY, index, CatCardConst.CardType.CARD)
        effectActionData:Begin()
    end

    for i, index in ipairs(enemyCards) do
        ---@type CatCard.EffectActionData
        local effectActionData = BllMgr.GetCatCardBLL():GetActionData(CatCardConst.ActionType.EffectAction, CatCardConst.PlayerType.ENEMY)
        effectActionData:Set(state, CatCardConst.Effect.CARD_DESTROY, index, CatCardConst.CardType.CARD)
        effectActionData:Begin()
    end
end

---结束
function BankruptAction:End()
    self.bll:SetCardMode(CatCardConst.CardMode.Current)
    BaseAction.End(self)
end

return BankruptAction