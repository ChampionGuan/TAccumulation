---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xiaofang.
--- DateTime: 2023/1/7 11:28
---@type CatCardConst
local CatCardConst = require("Runtime.System.X3Game.Modules.CatCard.Data.CatCardConst")
---@type CatCard.CatCardBaseAction
local BaseAction = require(CatCardConst.BASE_ACTION_PATH_NEW)
---@class CatCard.StealPressAction:CatCard.CatCardBaseAction
local StealPressAction = class("StealPressAction", BaseAction)

---@param action_data CatCard.StealPressActionData
function StealPressAction:Begin(action_data)
    self.param = action_data:GetParam()
    self.stateData = self.bll:GetStateData()
    self.state = self.stateData:GetSpState()
    self.startDt = 0
    if self.state > CatCardConst.StealState.CANSTEAL then
        self:End()
        return
    end

    if self.state == CatCardConst.StealState.PREFAIL then
        local preFailTime = self.param[2] / 1000
        if CatCardConst.STEALPRESSTIME < preFailTime then
            self.break_time = math.random(CatCardConst.MIN_STEAL_INTERRUPT_TIME * 1000, CatCardConst.STEALPRESSTIME * 1000) / 1000
        else
            self.break_time = preFailTime
        end
    end
    if self.stateData:GetState() == CatCardConst.State.P2_PRE then
        EventMgr.Dispatch(CatCardConst.Event.STEAL_SHOW_PRESTEAL_EVENT, true, false)
        local waitTime = self.bll:GetWaitingTime(CatCardConst.PlayerType.ENEMY)
        ---@type CatCard.WaitTimeActionData
        self.waitActionData = self.bll:GetActionData(CatCardConst.ActionType.WaitTime, self.actionData:GetPlayerType(), handler(self, self.OnWaitEnd))
        self.waitActionData:Set(waitTime)
        self.waitActionData:Begin()
    else
        self:End()
    end
end

function StealPressAction:OnWaitEnd()
    if self.isInterrupt then
        return
    end
    if self.isPressSuccess then
        self.stateData:SetSpState(CatCardConst.StealState.SEND)
        self:End()
    else
        self.stateData:SetSpState(CatCardConst.StealState.END)
        if self.startDt == 0 then
            --无操作时直接结束，否则等待按压结果
            self:End()
        end
    end
end

function StealPressAction:PressStateChange(state)
    if state == CatCardConst.StealPressState.Start then
        --按压开始
        self:BeginPress()
    elseif state == CatCardConst.StealPressState.Pressing then
        --按压中
        self:OnPress()
    elseif state == CatCardConst.StealPressState.Finish then
        --按压完成
        self:EndPress()
    elseif state == CatCardConst.StealPressState.Cancel then
        --取消按压,不做处理，可以再次按压 但要清除按下时间，否则无法正常结束
        self.startDt = 0
    elseif state == CatCardConst.StealPressState.Full then
        --手牌已满，无法偷牌
        if self.waitActionData:IsRunning() then
            self.waitActionData:End()
        end
    end
end

function StealPressAction:BeginPress()
    self.startDt = TimerMgr.RealtimeSinceStartup()
    EventMgr.Dispatch(CatCardConst.Event.STEAL_SHOW_PRESTEAL_EVENT, true, false)
end

function StealPressAction:OnPress()
    if self.stateData:GetSpState() == CatCardConst.StealState.END then
        self:StealInterrupt()
    else
        if self.stateData:GetSpState() == CatCardConst.StealState.PREFAIL then
            if TimerMgr.RealtimeSinceStartup() - self.startDt >= self.break_time then
                self.bll:CheckSound(CatCardConst.SoundType.DEFAULT, CatCardConst.Sound.SYSTEM_MIAO_CATCHED)
                self:StealInterrupt()
            end
        end
    end
end

function StealPressAction:EndPress()
    self.isPressSuccess = true
end

function StealPressAction:StealInterrupt()
    self.isInterrupt = true
    self.stateData:SetSpState(CatCardConst.StealState.END)
    EventMgr.Dispatch(CatCardConst.Event.STEAL_SHOW_PRESTEAL_EVENT, true, true)
    ---@type CatCard.ChangeDialogueStateActionData
    local changeStateData = self.bll:GetActionData(CatCardConst.ActionType.ChangeDialogueState, CatCardConst.PlayerType.PLAYER, function()
        self:End()
    end)
    changeStateData:SetState(CatCardConst.DialogueState.StealCardInterrupt)
    changeStateData:SetDialogueCtrlState(CatCardConst.DialogueCtrlState.Start)
    changeStateData:Begin()
end

function StealPressAction:OnAddEventListener()
    EventMgr.AddListener(CatCardConst.Event.STEAL_PRESS_STATE_CHANGE, self.PressStateChange, self)
end

function StealPressAction:End()
    EventMgr.Dispatch(CatCardConst.Event.STEAL_SHOW_PRESTEAL_EVENT, false, false)
    BaseAction.End(self)
end

return StealPressAction
