---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xiaofang.
--- DateTime: 2022/12/21 13:45
---@type CatCardConst
local CatCardConst = require("Runtime.System.X3Game.Modules.CatCard.Data.CatCardConst")
---@type CatCard.CatCardBaseAction
local BaseAction = require(CatCardConst.BASE_ACTION_PATH_NEW)
---@class CatCard.WanderEndAction:CatCard.CatCardBaseAction
local WanderEndAction = class("WanderEndAction", BaseAction)

---@param action_data CatCard.WanderEndActionData
function WanderEndAction:Begin(action_data)
    self.actionData = action_data
    self.stateData = self.bll:GetStateData()
    if self.stateData:GetActionRes() == CatCardConst.WanderingType.SWITCHFAILED then
        self.stateData:SetSpState(CatCardConst.WanderingState.ENDED)
    end
    EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_SET_SELECT_ENABLE, false)
    self.stateData = self.bll:GetStateData()
    if self.stateData:GetSpState() ~= CatCardConst.WanderingState.ENDED then
        action_data:SetIsBreak(true)
    else
        local select_list = self.bll:GetSelectIndexs(CatCardConst.CardType.SLOT)
        self:ResetSelectSlots(select_list)
        if self.stateData:GetActionRes() == CatCardConst.WanderingType.SWITCHSUCCESS then
            if select_list then
                for i, v in pairs(select_list) do
                    EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_REFRESH_MODEL, CatCardConst.CardType.SLOT, v, nil, false, true,true)
                end
            end
        end
        self.bll:SetCurSelectIndex(CatCardConst.CardType.SLOT)
        self.stateData:ClearActionRes()
        self.stateData:ClearRecord()
    end
    if self.bll:GetCurSelectCount(CatCardConst.CardType.SLOT) > 0 then
        self:ResetState()
    else
        self:End()
    end
end

function WanderEndAction:ResetSelectSlots(select_list)
    if select_list then
        for i, v in pairs(select_list) do
            EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_SET_MODEL_LAYER, Const.LayerMask.DEFAULT, CatCardConst.CardType.SLOT, v)
        end
    end
end

function WanderEndAction:ResetState()
    local data_list = self.bll:GetDataList(CatCardConst.CardType.SLOT)
    for i, v in pairs(data_list) do
        v:SetIsTouchEnable(false)
    end
    local select_list = self.bll:GetSelectIndexs(CatCardConst.CardType.SLOT)
    for i, v in pairs(select_list) do
        EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_SET_MODEL_CAN_SELECT, false, CatCardConst.CardType.SLOT, v)
    end
    PoolUtil.ReleaseTable(data_list)
    EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_ON_SELECT_MODEL)
    EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_SET_ALL_SELECT_CATS_IS_PICK, false, function()
        EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_SET_TOUCH_EMPTY_ENABLE, true)
        EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_SET_TOUCH_CAN_EXECUTE_ACTION, true)
        EventMgr.Dispatch(CatCardConst.Event.CAT_CARD_CHECK_SPECIAL_STATE)
        self:End()
    end)
end

function WanderEndAction:End()
    BaseAction.End(self)
end

return WanderEndAction