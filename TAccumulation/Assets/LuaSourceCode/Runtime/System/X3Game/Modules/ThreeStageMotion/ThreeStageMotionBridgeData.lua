---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by dengzi.
--- DateTime: 2023/6/21 15:21
---

local BridgeDataBase = require("Runtime.System.X3Game.Modules.GameDataBridge.BridgeDataBase")
---@class ThreeStageMotionBridgeData : BridgeDataBase
local ThreeStageMotionBridgeData = class("ThreeStageMotionBridgeData", BridgeDataBase)

function ThreeStageMotionBridgeData:ctor()
    ---@type table<string, ThreeStageMotionCtrl>
    self.activeMotionMap = {}
    self.allMotionCompleteCb = nil
end

function ThreeStageMotionBridgeData:AddMotionCtrl(key, ctrl)
    if string.isnilorempty(key) or nil == ctrl then
        return
    end
    self.activeMotionMap[key] = ctrl
end

function ThreeStageMotionBridgeData:RemoveMotionCtrl(key)
    if string.isnilorempty(key) then
        return
    end
    if self.activeMotionMap[key] then
        self.activeMotionMap[key]:Destroy()
        self.activeMotionMap[key] = nil
    end
    self:_CheckAllFinish()
end

function ThreeStageMotionBridgeData:RemoveAllMotionCtrl()
    for _, v in pairs(self.activeMotionMap) do
        v:Destroy()
    end
    self.activeMotionMap = {}
    self:_CheckAllFinish()
end

function ThreeStageMotionBridgeData:GetCtrl(key)
    if string.isnilorempty(key) then
        return nil
    end
    return self.activeMotionMap[key]
end

function ThreeStageMotionBridgeData:SetAllCompleteCallback(callback)
    self.allMotionCompleteCb = callback
    self:_CheckAllFinish()
end

function ThreeStageMotionBridgeData:_CheckAllFinish()
    self:_RemoveInvalidCtrl()
    if self.allMotionCompleteCb then
        if table.nums(self.activeMotionMap) <= 0 then
            self.allMotionCompleteCb()
            self.allMotionCompleteCb = nil
        end
    end
end

function ThreeStageMotionBridgeData:_RemoveInvalidCtrl()
    local removeKeys = PoolUtil.GetTable()
    for key, v in pairs(self.activeMotionMap) do
        if v:IsValid() == false then
            table.insert(removeKeys, key)
        end
    end
    if #removeKeys > 0 then
        for i = 1, #removeKeys do
            self.activeMotionMap[removeKeys[i]]:Destroy()
            self.activeMotionMap[removeKeys[i]] = nil
        end
    end
    PoolUtil.ReleaseTable(removeKeys)
end

return ThreeStageMotionBridgeData