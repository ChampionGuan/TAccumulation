---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiaozhu.
--- DateTime: 2022/3/16 20:21
---

---@type MainHome.MainHomeConst
local MainHomeConst = require("Runtime.System.X3Game.Modules.MainHome.Data.MainHomeConst")
---@type MainHome.BaseInteractAction
local BaseAction = require(MainHomeConst.BASE_INTERACT_ACTION)
---@class MainHome.CountAction:MainHome.BaseInteractAction
local CountAction = class("CountAction", BaseAction)
---@class MainHome.CountData
---@field time number
---@field partType int

function CountAction:ctor()
    BaseAction.ctor(self)
    self.maxCount = 0
    ---@type MainHome.CountData[]
    self.countDataList = PoolUtil.GetTable()
    self.lastTriggerTime = 0
end

---设置最大计数
---@param count int
function CountAction:SetMaxCount(count)
    self.maxCount = count
end

---保存数量
---@param partType int
function CountAction:SaveCount(partType)
    self.lastTriggerTime = TimerMgr.GetCurTimeSeconds()
    ---@type MainHome.CountData
    local data = PoolUtil.GetTable()
    data.time = self.lastTriggerTime
    data.partType = partType or 0
    table.insert(self.countDataList, data)
    if #self.countDataList > self.maxCount  then
        PoolUtil.ReleaseTable(table.remove(self.countDataList, 1))
    end
end

---在对应时间段中获取保存的数量
---@param dt number
---@param partType int
function CountAction:GetCount(dt,partType)
    local cur = self.lastTriggerTime
    local count = 0
    local isCheck = partType and partType ~= 0
    for _, v in ipairs(self.countDataList) do
        if not isCheck or (partType == v.partType) then
            if cur - v.time <= dt then
                count = count + 1
            end
        end
    end
    return count
end

---重置数据
function CountAction:Reset()
    for _, v in pairs(self.countDataList) do
        PoolUtil.ReleaseTable(v)
    end
    table.clear(self.countDataList)
    self.lastTriggerTime = TimerMgr.GetCurTimeSeconds()
end

return CountAction