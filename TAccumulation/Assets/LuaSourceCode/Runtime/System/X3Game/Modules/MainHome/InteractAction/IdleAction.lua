---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiaozhu.
--- DateTime: 2022/3/15 18:18
---
---@type MainHome.MainHomeConst
local MainHomeConst = require("Runtime.System.X3Game.Modules.MainHome.Data.MainHomeConst")
---@type MainHome.BaseInteractAction
local BaseAction = require(MainHomeConst.BASE_INTERACT_ACTION)
---@class MainHome.IdleAction:MainHome.BaseInteractAction
local IdleAction = class("IdleAction", BaseAction)
function IdleAction:ctor()
    BaseAction.ctor(self)
    self.lastIdleTime = 0
    self.idleTime = 0
    self.isEnable = true
    self.isFocus = true
end

function IdleAction:Begin()
    BaseAction.Begin(self)
    self:PlayDialogue()
end

function IdleAction:End()
    self.lastIdleTime = TimerMgr.GetCurTimeSeconds()
    BaseAction.End(self)
end

function IdleAction:Enter()
    BaseAction.Enter(self)
    self.isEnable = true
    self.isFocus = self.bll:IsWndFocus()
    self.lastIdleTime = TimerMgr.GetCurTimeSeconds()
    local actionData = self:GetActionData()
    if actionData then
        self.idleTime = actionData.Para1
    else
        self.idleTime = -1
    end
end

function IdleAction:IsCanCheck()
    return self.isEnable and  self.idleTime ~= -1 and (not self:IsRunning()) 
end

function IdleAction:OnUpdate()
    if not self:IsCanCheck()  then
        self.lastIdleTime = TimerMgr.GetCurTimeSeconds()
        return 
    end
    if TimerMgr.GetCurTimeSeconds()-self.lastIdleTime>=self.idleTime then
        self.lastIdleTime = TimerMgr.GetCurTimeSeconds()
        self:Trigger()
    end
end

---@param focus boolean
function IdleAction:OnViewFocusChanged(focus)
    self.isFocus = focus
    self.isEnable = self.isFocus
end

---@param actionId int
---@param isRunning boolean
function IdleAction:OnActionShowRunning(actionId,isRunning)
    self.isEnable = self.isFocus and self.bll:GetActionDataProxy():IsActionIdle()
end

function IdleAction:OnAddListener()
    EventMgr.AddListener(MainHomeConst.Event.MAIN_HOME_SET_ACTION_SHOW_RUNNING,self.OnActionShowRunning,self)
end


return IdleAction