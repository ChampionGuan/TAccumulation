--- Generated by EmmyLua(https:..github.com.EmmyLua)
--- Created by fusu
--- DateTime: 2023.11.02 14:17
---@type MainHome.MainHomeConst
local MainHomeConst = require("Runtime.System.X3Game.Modules.MainHome.Data.MainHomeConst")
---@type MainHome.CountAction
local BaseAction = require("Runtime.System.X3Game.Modules.MainHome.InteractAction.CountAction")
---@class MainHome.TouchCountsEffectAction:MainHome.CountAction
local TouchCountsEffectAction = class("TouchCountsEffectAction", BaseAction)

function TouchCountsEffectAction:Enter()
    BaseAction.Enter(self)
    self._isTrigger = false
    self._effectObj = Res.LoadWithAssetPath(ResPathConst.MainUI_TouchCountsEffect)
    self._effectName = "OCX_MainHomeClickCounts"
    self:SetMaxCount(CS.System.Int32.MaxValue)
    InputEffectMgr.SetEffectTemplate(self._effectObj, self._effectName)
end

function TouchCountsEffectAction:Exit()
    BaseAction.Exit(self)
    self:UnRegisterEvent()
    Res.Unload(self._effectObj)
    InputEffectMgr.RemoveTemplate(self._effectName)
    self._effectName = nil
end

---开始表演
function TouchCountsEffectAction:Begin()
    BaseAction.Begin(self)
    self:ShowEffect()
    self:End(true)
end

---结束表演
function TouchCountsEffectAction:End(notReset)
    BaseAction.End(self)
    self._isTrigger = false
    EventMgr.Dispatch(MainHomeConst.Event.MAIN_HOME_SET_TOUCH_TYPE_ENABLE ,GameObjClickUtil.EffectType.Click , true)
    if not notReset then
        self:Reset()
    end
end

function TouchCountsEffectAction:Trigger()
    if not self:IsActionPlayDialogue() then
        BaseAction.Trigger(self)
        EventMgr.Dispatch(MainHomeConst.Event.MAIN_HOME_SET_TOUCH_TYPE_ENABLE ,GameObjClickUtil.EffectType.Click , false)
    end
end

function TouchCountsEffectAction:ShowEffect()
    InputEffectMgr.ShowEffect(InputEffectMgr.EffectType.Click, self._effectName, 2)
end

---参数定义
---Para1 时间
---Para2 次数
---Para3 部位
---Para4 剧情变量
function TouchCountsEffectAction:OnTouchDownActor()
    self:SaveCount()
    local actionData = self:GetActionData()
    if actionData then
        local count = self:GetCount(actionData.Para1, actionData.Para3)
        if count >= actionData.Para2 then
            self:Trigger()
        end
    end
end

function TouchCountsEffectAction:OnTouchActorTrigger()
    self:Reset()
end

---玩家状态刷新
function TouchCountsEffectAction:OnActorStateChanged()
    BaseAction.OnActorStateChanged(self)
    self:Reset()
end

function TouchCountsEffectAction:OnAddListener()
    EventMgr.AddListener(MainHomeConst.Event.MAIN_HOME_ON_TOUCH_DOWN_ACTOR, self.OnTouchDownActor, self)
end

return TouchCountsEffectAction