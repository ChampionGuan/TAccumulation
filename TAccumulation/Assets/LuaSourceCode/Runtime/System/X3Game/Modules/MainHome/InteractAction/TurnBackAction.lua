--- Generated by EmmyLua(https:..github.com.EmmyLua)
--- Created by fusu
--- DateTime: 2023.7.25 14:17
---@type MainHome.MainHomeConst
local MainHomeConst = require("Runtime.System.X3Game.Modules.MainHome.Data.MainHomeConst")
---@type MainHome.CountAction
local BaseAction = require(MainHomeConst.BASE_INTERACT_ACTION)
---@class MainHome.TurnBackAction:MainHome.BaseInteractAction
local TurnBackAction = class("TurnBackAction", BaseAction)

function TurnBackAction:Enter()
    BaseAction.Enter(self)
    ---@type table<int> 交互次数统计
    self.interactList = {}
    EventMgr.AddListener(MainHomeConst.Event.MAIN_HOME_SET_ACTION_SHOW_RUNNING, self.OnEventActionShowChanged, self)
end

function TurnBackAction:Exit()
    BaseAction.Exit(self)
    self:UnRegisterEvent()
end

---开始表演
function TurnBackAction:Begin()
    BaseAction.Begin(self)
    self:PlayDialogue()
end

---结束表演
function TurnBackAction:End()
    BaseAction.End(self)
end

function TurnBackAction:OnEventActionShowChanged(actionId, isRunning)
    if not isRunning then
        return
    end
    
    local actionData = self.bll:GetActionDataProxy():GetActionTypeCfgById(actionId)
    if actionData and actionData.IgnoreStateCount == 1 then
        self.interactList[#self.interactList + 1] = TimerMgr.GetCurTimeSeconds()
        self:CheckIsTrigger()
    end
end

---Para1 时间
---Para2 次数
function TurnBackAction:CheckIsTrigger()
    local actionData = self:GetActionData()
    if actionData then
        local count = self:GetCount(actionData.Para1)
        if count >= actionData.Para2 then
            table.clear(self.interactList)
            self:Trigger()
        end
    end
end

function TurnBackAction:GetCount(dt)
    local count = 0
    local cur = TimerMgr.GetCurTimeSeconds()
    for _, time in ipairs(self.interactList) do
        if cur - time <= dt then
            count = count + 1
        end
    end
    return count
end

return TurnBackAction