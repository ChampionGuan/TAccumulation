---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by sms.
--- DateTime: 2023/3/20 16:05
--- 存放游戏Icon的本地数据接口, 设备层Icon交互接口, 冷更包强制替换Icon同步接口

---@class SysIconUtil
local SysIconUtil = {}

---@type SysThemeUtil
local SysThemeUtil = require "Runtime.System.X3Game.Modules.Theme.SysThemeUtil"

local logOn = true

local __checkIfValid, __getDefaultIcon, __getSysIcon, __getCurOperationId, __setCurOperationId, __setSysIcon, __checkForceUpdate
---------------------------------------------------------------------------------------------------------------------------------------------------
---Public方法定义

---@public 获得IconId
---@return number iconId
function SysIconUtil.GetSysIcon()
    if __getCurOperationId() > 0 then   -- 操作Id > 0 表示此时活动强更Icon开始, 所有玩家Icon默认替换为活动Icon, 本地设置也同步修改为默认(Icon/Theme)
        return __getDefaultIcon()
    else                                -- 操作Id <= 0 表示此时获取玩家手动设置的Icon
        return __getSysIcon()  
    end
end

---@public 设置IconId (用于本地记录)
---@param iconId number iconId
function SysIconUtil.SetSysIcon(iconId)
    __setSysIcon(iconId)
end

---@public 获取默认IconId (从本地缓存)
function SysIconUtil.GetDefaultIcon()
    return __getDefaultIcon()
end

---@public 检查强更Icon信息同步流程, 如果有则直接同步 (不涉及主动设备层Icon替换，仅本地数据同步)
function SysIconUtil.CheckSyncForceUpdateIcon()
    -- 这里打个log
    if logOn then Debug.LogError(string.format("检查强更Icon信息同步流程开始 : CurSavedIcon : %d, DefaultIcon : %d, CurIconOperationId : %d",
            __getSysIcon(), __getDefaultIcon(), __getCurOperationId())) end
    
    -- 是否同步了
    local isForceUpdated = __checkForceUpdate()

    -- 这里打个log
    if logOn then Debug.LogError(string.format("检查强更Icon信息同步流程结束 : [Flag = %s] CurSavedIcon : %d, DefaultIcon : %d, CurIconOperationId : %d",
            tostring(isForceUpdated), __getSysIcon(), __getDefaultIcon(), __getCurOperationId())) end
end

---@public 从设备层获取当前设置IconId(From Android/IOS)
function SysIconUtil.GetSysIconFromDevice()
    local iconStr = CS.X3Game.Platform.PFChangeAppIconUtility.GetCurrentIconName()
    local curIconId
    if string.isnilorempty(iconStr) or iconStr == "default" then    -- 与布里茨约定设备层默认Icon名称
        curIconId = __getDefaultIcon()
    else
        local iconAllCfg = LuaCfgMgr.GetAll("DeskIconInfo")
        local iconCfg
        for _, v in pairs(iconAllCfg) do
            local comparisonFromCfg = BllMgr.GetSystemSettingBLL():GetIconComparison(v.DeskIconID)
            if string.isnilorempty(comparisonFromCfg) and string.lower(comparisonFromCfg) == string.lower(iconStr) then
                iconCfg = v
                break
            end
        end
        
        if not iconCfg then Debug.LogError("GetSysIconFromDevice : iconCfg not found " .. table.dump({iconStr})) return end
        curIconId = iconCfg.DeskIconID
    end
    return curIconId
end
---------------------------------------------------------------------------------------------------------------------------------------------------
---私有方法定义

---@private 检查Icon是否合法
__checkIfValid = function(iconId)
    if not iconId or iconId == 0 then return false end
    local iconCfg = LuaCfgMgr.Get("DeskIconInfo", iconId)
    if not iconCfg or iconCfg.Cancel == 1 then return false end
    return true
end

---@private 获取默认IconId
__getDefaultIcon = function()
    local defaultIconCfg = LuaCfgMgr.GetDataByCondition("DeskIconInfo", {IconType = ThemeEnum.SysIconCfgType.Default, Cancel = 0})
    if not defaultIconCfg then Debug.LogError("defaultIconCfg not found") return end
    return defaultIconCfg.DeskIconID
end

---@private 获取IconId
---@return number iconId
__getSysIcon = function()
    local iconId = PlayerPrefs.GetInt(ThemeEnum.SysThemeLocalKey.SysIconResId)
    -- 如果本地缓存找不到或Icon不合法, 以配置中当前默认值返回
    if not __checkIfValid(iconId) then
        return __getDefaultIcon()
    end
    return iconId
end

---@private 设置IconId
---@param iconId number iconId
__setSysIcon = function(iconId)
    iconId = iconId or __getDefaultIcon()

    PlayerPrefs.SetInt(ThemeEnum.SysThemeLocalKey.SysIconResId, iconId)

    -- 此时刷新操作Id (赋值为负数 表示已经手动操作过了)
    __setCurOperationId(-__getDefaultIcon())
end

---@private 获取最近一次操作时的Id
__getCurOperationId = function()
    return PlayerPrefs.GetInt(ThemeEnum.SysThemeLocalKey.CurIconOperationId)
end

---@private 写入当前操作Id (opId == defaultIconId代表强更同步, opId == - defaultIconId代表还原同步)
---@param opId number 操作Id 
__setCurOperationId = function(opId)
    PlayerPrefs.SetInt(ThemeEnum.SysThemeLocalKey.CurIconOperationId, opId)
    
    PlayerPrefs.Save()
end

---@private 检查当前需要活动Icon强更信息同步
__checkForceUpdate = function()
    local defaultIconId = __getDefaultIcon()    -- 获取最新默认IconId

    -- 检查当前操作Id已经是最新的了则返回false
    local curIconOperationId = __getCurOperationId()
    if math.abs(curIconOperationId) == defaultIconId then return false end

    -- 检查当前设置是默认设置 则直接返回
    local curIconId = __getSysIcon()
    if curIconId == defaultIconId then return false end

    local defaultIconCfg = LuaCfgMgr.Get("DeskIconInfo", defaultIconId)
    if defaultIconCfg.Force == 1 then   -- Force为1 通常用于活动开始时强更默认图标至活动图标
        -- 强更Icon！ 记录本次操作Id！ 传入记录正数！ 后续调用时见到正数操作Id就会获取默认值而非本地保存的IconId！
        __setCurOperationId(defaultIconId)
        
        -- 强更后还原本地设置至默认
        __setSysIcon(__getDefaultIcon)                              -- Icon还原默认
        SysThemeUtil.SetSysTheme(SysThemeUtil.GetDefaultTheme())    -- 主题也要还原默认
        
        return true
    elseif defaultIconCfg.Force == 0 then   -- Force为0 通常用于活动结束时恢复活动图标至默认图标
        -- 还原Icon！ 记录本次操作Id！ 传入记录负数！ 后续调用时见到负数操作Id就会获取本地记录的IconId而非默认值！
        __setCurOperationId(-defaultIconId)
        return false
    else
        Debug.LogError("DeskIconInfo 默认Icon配置的Force字段错误 ！")
    end
end

---------------------------------------------------------------------------------------------------------------------------------------------------

return SysIconUtil