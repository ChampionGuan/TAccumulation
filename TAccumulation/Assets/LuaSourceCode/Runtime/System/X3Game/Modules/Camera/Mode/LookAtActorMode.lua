---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by doudou.
--- DateTime: 2022/4/24 15:01
---
---主界面男主跟随相机
---@class LookAtActorMode:CameraModeBase
---@field virtualCamera FreeLookCamera
local LookAtActorMode = class("CameraModeBase", require("Runtime.System.X3Game.Modules.Camera.Base.CameraBase"))
LookAtActorMode.CameraClassType = CameraClassType.Virtual
LookAtActorMode.SyncMainCameraOnActivated = false

---@param virtualCamera VirtualCamera
function LookAtActorMode:ctor(virtualCamera)
    self.virtualCamera = virtualCamera
    ---@type Vector2
    self.screenSize = CS.X3Game.CameraUtility.GetScreenSize()
    self.screenWidth = self.screenSize.x / self.screenSize.y * 1920
    self.target = nil
end

function LookAtActorMode:OnEnter(...)
    if self.target ~= nil then
        local composer = self.virtualCamera:EnsureComponent(CameraComponentType.Composer)
        if composer then
            local screenPos = GlobalCameraMgr.WorldToScreenPoint(self.target.position)
            composer.m_ScreenY = 1 - screenPos.y / self.screenSize.y
        end

        self.virtualCamera:SetLookAt(self.target)
    end
end

---@param padding float 边缘空间宽度
function LookAtActorMode:SetDeathWidth(padding)
    local deadZoneX = (1 - 2 * padding) * 886 / self.screenWidth
    local composer = self.virtualCamera:EnsureComponent(CameraComponentType.Composer)
    if composer then
        composer.m_DeadZoneWidth = deadZoneX
    end
end

---@param characterIns GameObject 资产实例
---@param boneName string 骨骼名称
function LookAtActorMode:LookAtActor(characterIns, boneName, setImmediately)
    if characterIns == nil then
        return
    end

    local target = CharacterMgr.GetBoneByName(characterIns, boneName)

    if target == nil then
        target = characterIns.transform
    end

    self.target = target

    if setImmediately then
        self.virtualCamera:SetLookAt(self.target)
    end
end

---从主相机同步
function LookAtActorMode:SyncMainCamera()
    self.virtualCamera:SetFov(GlobalCameraMgr.GetCameraFOV())
    self.virtualCamera:SetPosition(GlobalCameraMgr.GetCameraPosition())
    self.virtualCamera:SetEulerAngles(GlobalCameraMgr.GetCameraEulerAngles())
end

---从VirtualCamera同步
function LookAtActorMode:SyncVirtualCamera()
    ---@type VirtualCameraBase
    local curVirtualCamera = GlobalCameraMgr.GetCurrVirtualCamera()
    if curVirtualCamera then
        self.virtualCamera:SetFov(curVirtualCamera:GetFov())
        self.virtualCamera:SetPosition(curVirtualCamera:GetPosition())
        self.virtualCamera:SetEulerAngles(curVirtualCamera:GetEulerAngles())
    else
        local cinemachineCamera = GlobalCameraMgr.GetCurrCineMachineCamera()
        if cinemachineCamera then
            self.virtualCamera:SetFov(cinemachineCamera.m_Lens.FieldOfView)
            self.virtualCamera:SetPosition(GameObjectUtil.GetPosition(cinemachineCamera.gameObject))
            self.virtualCamera:SetEulerAngles(GameObjectUtil.GetEulerAngles(cinemachineCamera.gameObject))
        else
            self:SyncMainCamera()
        end
    end
end

function LookAtActorMode:OnExit()
    self.virtualCamera:SetLookAt(nil)
end

return LookAtActorMode