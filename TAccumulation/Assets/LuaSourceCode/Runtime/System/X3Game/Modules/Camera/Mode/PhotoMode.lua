---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by admin.
--- DateTime: 2021/5/19 20:04
---

local PhotoMode = class("PhotoMode", require("Runtime.System.X3Game.Modules.Camera.Base.CameraModeBase"))
PhotoMode.CameraClassType = CameraClassType.FreeLook

function PhotoMode:OnAwake(...)
    self.VirtualFreeLook = self.virtualCamera._cineMachineVirtualCamera
    self.xAxis = self.VirtualFreeLook.m_XAxis.m_MaxSpeed
    self.yAxis = self.VirtualFreeLook.m_YAxis.m_MaxSpeed

    self:Reset()

    self.timerID = TimerMgr.AddFinalUpdate(self.OnUpdate,self)
end

function PhotoMode:OnDestroy()
    TimerMgr.Discard(self.timerID)
end

function PhotoMode:OnEnter()

end

function PhotoMode:OnExit()

end

function PhotoMode:OnEnableCamera(isEnable)
    self.virtualCamera._rootG:SetActive(isEnable)
end

function PhotoMode:SetFollowAndLookAt()
    local follow = GameObjectUtil.GetComponent(self._rootT.parent,"FollowPoint")
    local lookAt = GameObjectUtil.GetComponent(self._rootT.parent,"LookPoint")
    self.virtualCamera:SetFollow(follow)
    self.virtualCamera:SetLookAt(lookAt)
end

function PhotoMode:Init(follow,lookAt,orbits,minRadius,maxRadius,defaultX,defaultY)
    self:_SyncPos(follow,lookAt)
    self:SetCameraPos(defaultX,defaultY)
    self:_SetOrbits(orbits)
    self:_SetRadius(minRadius,maxRadius)
end

function PhotoMode:_SyncPos(follow,lookAt)
    self.FollowTarget = follow
    self.LookAtTarget = lookAt

    self.VirtualFreeLook.Follow.position = follow.position
    self.VirtualFreeLook.LookAt.position = lookAt.position
end

function PhotoMode:_SetOrbits(orbits)
    for k,v in pairs(orbits) do
        local orbits = self.VirtualFreeLook.m_Orbits[k]
        orbits.m_Height = v.height
        orbits.m_Radius = v.radius

        self.VirtualFreeLook.m_Orbits[k] = orbits
    end
end

function PhotoMode:_SetRadius(min,max)
    self.MinRadius = min
    self.MaxRadius = max
end

function PhotoMode:SetCameraPos(x,y)
    self.VirtualFreeLook.PreviousStateIsValid = false
    local xAxis= self.VirtualFreeLook.m_XAxis
    xAxis.Value = x
    self.VirtualFreeLook.m_XAxis = xAxis

    local yAxis= self.VirtualFreeLook.m_YAxis
    yAxis.Value = y
    self.VirtualFreeLook.m_YAxis = yAxis
end

function PhotoMode:GetCameraAxisValue()
    local xAxis= self.VirtualFreeLook.m_XAxis
    local yAxis= self.VirtualFreeLook.m_YAxis
    return xAxis.Value,yAxis.Value
end

function PhotoMode:RotateCamera()
    self:SetAxisSpeed(self.xAxis,self.yAxis)

    self.isSyncFollow = true
end

function PhotoMode:SyncFollow()
    if not self.isSyncFollow then return end
    local followDistance = Vector3.Distance(self.VirtualFreeLook.Follow.position, self.FollowTarget.position)
    local lookAtDistance = Vector3.Distance(self.VirtualFreeLook.LookAt.position, self.LookAtTarget.position)

    if lookAtDistance < 0.1 and followDistance < 0.1 then
        self.isSyncFollow = false
        return
    end

    self.VirtualFreeLook.Follow.position = Vector3.Lerp(self.VirtualFreeLook.Follow.position, self.FollowTarget.position, 0.05)
    self.VirtualFreeLook.LookAt.position = Vector3.Lerp(self.VirtualFreeLook.LookAt.position, self.LookAtTarget.position, 0.05)
end

function PhotoMode:OnPinchZoom(FovData)
    GameObjectUtil.SetActive(self.VirtualFreeLookGameObject,true)
    self:SetAxisSpeed(0,0)

    local curValue = self.VirtualFreeLook.m_Orbits[1].m_Radius

    local curRadius = curValue + FovData
    if curRadius > self.MaxRadius then
        curRadius = self.MaxRadius
    end
    if curRadius <= self.MinRadius then
        curRadius = self.MinRadius
    end

    local orbits0 = self.VirtualFreeLook.m_Orbits[0]
    orbits0.m_Radius = curRadius
    self.VirtualFreeLook.m_Orbits[0] = orbits0

    local orbits1 = self.VirtualFreeLook.m_Orbits[1]
    orbits1.m_Radius = curRadius
    self.VirtualFreeLook.m_Orbits[1] = orbits1

    local orbits2 = self.VirtualFreeLook.m_Orbits[2]
    orbits2.m_Radius = curRadius
    self.VirtualFreeLook.m_Orbits[2] = orbits2
end

function PhotoMode:OnUpdate()
    if GameObjectUtil.IsNull(self.VirtualFreeLook.Follow) then return end
    self:SyncFollow()
end

function PhotoMode:Reset()
    self:SetAxisSpeed(0,0)
end

function PhotoMode:SetAxisSpeed(x,y)
    local xAxis= self.VirtualFreeLook.m_XAxis
    xAxis.m_MaxSpeed = x
    self.VirtualFreeLook.m_XAxis = xAxis

    local yAxis= self.VirtualFreeLook.m_YAxis
    yAxis.m_MaxSpeed = y
    self.VirtualFreeLook.m_YAxis = yAxis
end

return PhotoMode