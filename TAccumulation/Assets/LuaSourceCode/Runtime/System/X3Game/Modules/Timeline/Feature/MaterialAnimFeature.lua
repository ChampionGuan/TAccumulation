---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by changkong.
--- DateTime: 2021/9/1 11:11
--- 人物释放技能时，动作由playableAnimator释放，材质动画会被提取出来单独处理，放置到人物Graph层。这个类用于做上述事情
local MaterialPlayableInstance = CS.MaterialPlayableInstance

local BaseFeature = require("Runtime.System.X3Game.Modules.Timeline.Feature.BaseFeature")
-- 已知对象池配套的onDiscard方法，此处已经通过别的方式清理过了，没有添加这个方法
---@class TimelineMaretialAnimFeature:TimelineBaseFeature
local MaretialAnimFeature = XECS.class("MaretialAnimFeature", BaseFeature, true, 6)

function MaretialAnimFeature:_OnCreate()
    ---@type CS.MaterialPlayableInstance
    self.playableIns = nil
end

function MaretialAnimFeature:_OnAfterBuild()
    local creator = self.timeline:GetForceBindObj()
    if not creator then
        return true
    end

    local hasCreatureMaterialAnim = self.timeline:HasCreatureMaterialAnim()
    if not hasCreatureMaterialAnim then
        return true
    end

    local director = self.timeline:GetPlayableDirector()
    local timelineObj = self.timeline:GetResObj()
    if director and  timelineObj then
        self.playableIns = MaterialPlayableInstance()
        self.playableIns:SetAnimatorByGameObject(creator)
        local groupType = self.context:GetEStaticSlot()
        self.playableIns:SetAnimationGroupType(groupType)
        self.playableIns:BuildTimelineMaterialPlayable(director)
        self.timeline:AddPlayableIns(self.playableIns)
    end
    return true
end

-- timeline某些轨道被打断时直接去掉材质动画
function MaretialAnimFeature:_OnInterrupt()
    self:_Reset()
end

function MaretialAnimFeature:_Reset()
    if self.playableIns then
        self.playableIns:Destroy()
        self.playableIns = nil
    end
end

function MaretialAnimFeature:_OnDestroy()
    self:_Reset()
    self:discard()
end

return MaretialAnimFeature