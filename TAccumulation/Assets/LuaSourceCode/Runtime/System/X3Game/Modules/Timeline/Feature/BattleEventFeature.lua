---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by changkong.
--- DateTime: 2021/8/16 11:00
---
--  处理battle EventTimeline相关内容, 目前只有怪物出生表现用到
require("Runtime.Battle.Common.XECS")
local BaseFeature = require("Runtime.System.X3Game.Modules.Timeline.Feature.BaseFeature")
-- 已知对象池配套的onDiscard方法，此处已经通过别的方式清理过了，没有添加这个方法
---@class TimelineBattleEventFeature:TimelineBaseFeature
local BattleEventFeature = XECS.class("BattleEventFeature", BaseFeature, true, 6)
local EventLineUtility = require("Runtime.Battle.View.Event.ViewEventLineUtility")

local GenaralEvalEvents = {
    [FSMEventName.CameraCloseup] = true,
    [FSMEventName.SkillAnim] = true,
    [FSMEventName.SkillDialogue] = true,
    [FSMEventName.CameraBlendType] = true,
    [FSMEventName.SkillRoleModelVisible] = true,
    [FSMEventName.SkillShowPlacardUI] = true,
    [FSMEventName.SkillFx] = true,
    [FSMEventName.SkillSetSceneActive] = true,
    [FSMEventName.SkillRunFx] = true,
    [FSMEventName.SkillBulletTime] = true,
}

function BattleEventFeature:_OnBeforePlay()
    self.eventLine = self.timeline:GetBattleEventTimeline()
    if self.eventLine then
        self.eventLine:SetEventHandler(self, self.FrameEvent)
        self.eventLine:Start()
        self.eventLine:Update(0)
    end
end

function BattleEventFeature:_OnTick()
    if self.eventLine then
        local time = self.timeline:GetScaleDeltaTime()
        self.eventLine:Update(FInt(time))
    end
end

function BattleEventFeature:FrameEvent(eventName, eventArgs)
    self:_OnFrameEvent(eventName, eventArgs)
end

-- 模板方法：处理eventFrame
function BattleEventFeature:_OnFrameEvent(eventName, eventArgs)
    local viewActor = self.timeline:GetBattleOwner()
    if GenaralEvalEvents[eventName] then
        EventLineUtility.GeneralEventProcess(viewActor, eventName, eventArgs)
    end
end

function BattleEventFeature:TryLeaveBulletTime()
    local timelineScale = self.timeline:GetTimeScale()
    if timelineScale == 1 then
        local ownerActor = self.timeline:GetBattleOwner()
        if ownerActor then
            ownerActor:SetAnimSpeed(timelineScale)
        end
    end
end

function BattleEventFeature:_OnDestroy()
    if self.eventLine then
        self.eventLine:Stop()
        self.eventLine = nil
    end
    self:discard()
end

return BattleEventFeature