---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiantao.
--- DateTime: 2023/4/3 15:39
---
---@class EnterGameMgr
local EnterGameMgr = class("EnterGameMgr")

---@type bool
local m_IsInit = false
---@type BaseEnterGameAction[]
local m_EnterGameActionList = {}
local m_DefaultAction
function EnterGameMgr.Init()
    ---创建数据
    table.clear(m_EnterGameActionList)
    ---捏脸和序章
    table.insert(m_EnterGameActionList, require("Runtime.System.X3Game.Modules.EnterGame.Action.EnterProStageAction"))
    table.insert(m_EnterGameActionList, require("Runtime.System.X3Game.Modules.EnterGame.Action.EnterReturnActivityAction"))
    ---主界面，默认
    m_DefaultAction = require("Runtime.System.X3Game.Modules.EnterGame.Action.EnterMainHomeAction")
end

function EnterGameMgr.EnterGame(callBack)
    for i = 1, #m_EnterGameActionList do
        if m_EnterGameActionList[i]:CheckCondition() then
            m_EnterGameActionList[i]:DoEnterAction(callBack)
            return
        end
    end
    m_DefaultAction:DoEnterAction(callBack)
end

---正式进入游戏前调用，与进入游戏状态相关的数据在这里进行初始化
---@param data pbcmessage.SyncUserTotalDataReply
---@param isReconnect boolean
function EnterGameMgr.InitDataBeforeEnterGame(data, isReconnect)
    if not data then
        Debug.LogError("===服务器异常===")
        return
    end

    ---- X3Data的初始化必须在任何"直接或间接"依赖X3Data数据的业务之前!!! ----
    if not isReconnect then
        --未触发断线重连才会初始化X3Data
        X3DataMgr.InitPersistence(CS.X3Game.X3GameSettings.Instance.X3DataSettings)
    end

    ---设置文件服务器域名前缀
    Uri:SetHost(data.FileDownloadPreUrl)
    UrlImgMgr.SetBizDownloadUrl(UrlImgMgr.BizType.PhotoAlbum, data.FileDownloadPreUrl)
    UrlImgMgr.SetBizDownloadUrl(UrlImgMgr.BizType.PlayerShowPhoto, data.FileDownloadPreUrl)
    ---同步一次服务器时间
    TimerMgr.EnterGame(true)
    TimerMgr.SetServerOpenTime(data.OpenTime)
    RedPointMgr.Init(data.RedPoint, data.RedPoints)
    BllMgr.GetUnLockBLL():Init(data.Unlock)
    ---主线流程
    BllMgr.GetChapterAndStageBLL():Init(data.Stage)
    ---捏脸系统数据
    BllMgr.GetFaceBLL():InitServerData(data.KneadFace)

    BllMgr.GetShareBLL():Init(data.Share)
    ---回流活动
    BllMgr.GetReturnActivityBll():Init(data.PlayerReturn)
    ---新手引导
    BllMgr.GetNoviceGuideBLL():Init(data.Guide)
end

---@param data pbcmessage.SyncUserTotalDataReply
function EnterGameMgr.InitEnterGameData(data)
    if not data then
        Debug.LogError("===服务器异常===")
        return
    end

    --依赖Unlock的数据，需要重新规划下，先初始化数据，再统一调用逻辑
    SelfProxyFactory.GetCoinProxy():OnEnterGame(data.Coin)
    BllMgr.GetPlayerBLL():OnEnterGame()
    BllMgr.GetRoleBLL():Init(data.Role)
    BllMgr.GetPlayerServerPrefsBLL():Sync(data.Custom)
    BllMgr.Get("ItemBLL"):Init(data.Item)
    BllMgr.Get("BagBLL"):Init()
    ---芯核
    SelfProxyFactory.GetGemCoreProxy():OnEnterGameReply(data.GemCore)
    --思念
    SelfProxyFactory.GetCardDataProxy():OnEnterGameReply(data.Card)
    SelfProxyFactory.GetSystemSettingProxy():OnEnterGameReply(data.GameSetting)
    BllMgr.GetFashionBLL():InitData(data.Fashion)
    SelfProxyFactory.GetScoreProxy():OnEnterGameReply(data.SCore)
    SelfProxyFactory.GetUserRecordProxy():InitData(data.Record.RecordGroups)
    ---这里要把ChapterAndStageBLL的初始化放到CustomRecordBLL前面信息，否则可能会启动时报错，详见XTBUG-13017
    BllMgr.GetCustomRecordBLL():InitData(data.Record.CustomGroups)
    SelfProxyFactory.GetPhoneContactProxy():Init(data.Contact)
    BllMgr.GetPhoneMsgBLL():OnEnterGame(data.Message)
    BllMgr.GetMobileMomentBLL():Init(data.Moment)
    BllMgr.GetMailBLL():Init(data.MailList)
    BllMgr.GetMobileCallBLL():Init(data.Call)
    BllMgr.GetDailyConfideBll():Init(data.DailyConfide)
    BllMgr.Get("MobileOfficialBLL"):Init(data.Article)
    ---编队数据相关
    SelfProxyFactory.GetFormationProxy():OnEnterGameReply(data.Formation)
    ---大螺旋相关
    SelfProxyFactory.GetHunterContestDataProxy():OnEnterGameReply(data.HunterContest)
    ---大螺旋进入游戏后需要检查是否有倒计时
    BllMgr.GetHunterContestBLL():EnterGame()

    BllMgr.GetTrialFieldBLL():Init(data.Trial)
    SelfProxyFactory.GetGamePlayProxy():Parse(data.GamePlays)
    ---初始化日常约会数据
    SelfProxyFactory.GetDailyDateProxy():InitDailyDateData()
    ---执行日常约会逻辑
    BllMgr.GetDailyDateBLL():LogicEntry()
    BllMgr.GetSpecialDateBLL():ParseSpecialDateBrief(data.SpecialDateBrief)

    SelfProxyFactory.GetWorldIntelligenceProxy():UpdateIntelligenceData(data.Intelligences)
    SelfProxyFactory.GetChargeProxy():Init(data.Charge)

    BllMgr.Get("ActiveBLL"):Init(data.Active)

    ---陪伴信息初始化(陪伴状态主界面需要读取, 这里放在主界面初始化数据之前)
    SelfProxyFactory.GetAccompanyProxy():Init(data.Accompany)

    SelfProxyFactory.GetMainInteractProxy():RefreshScene(data.Scene)
    BllMgr.Get("MainHomeBLL"):InitData(data.MainUI)
    SelfProxyFactory.GetMainInteractProxy():SetCDTime(data.InterActive and data.InterActive.CDTime)

    SelfProxyFactory.GetSoulTrialProxy():EnterGameReply(data.SoulTrial, data.SoulPass)

    SelfProxyFactory.GetGachaProxy():Init(data.GachaData)
    BllMgr.GetHangUpBLL():SetNetData(data.HangUpData)

    ---跑马灯请求协议
    BllMgr.GetCommonMarqueeBLL():SendRequest()

    ---todo:请将本值写在他处
    ---CS.PapeGames.DebugBLL.Instance.XlsxVersion = data.XlsxVersion

    BllMgr.GetAchievementBLL():InitQuest(data.Achievement)
    --签到数据
    BllMgr.GetWelfareBLL():UpdateSignInData(data.SignIn)
    BllMgr.GetWelfareBLL():SetServerOpenTime(data.OpenTime)
    -- 玩家生日数据
    BllMgr.GetPlayerBirthdayBLL():SetServerOpenTime(data.OpenTime)
    -- 玩家生日
    BllMgr.GetPlayerBirthdayBLL():OnEnterGame()
    -- 战斗记录
    BllMgr.GetDungeonRecordBLL():OnLogin(data.DungeonRecords)
    --月卡数据
    BllMgr.GetMonthCardBLLReplace():Init()
    BllMgr.GetMonthCardBLLReplace():SetMonthCardData(data.MonthCard)

    SelfProxyFactory.GetPhotoProxy():Init(data.Photos)

    ---女主武器
    BllMgr.GetWeaponBLL():Init(data.Weapon)

    ---广播剧初始数据
    BllMgr.GetRadioNewBLL():RecvMsg_InitRadio(data.BroadcastingPlay)

    -----首次刷新红点统一放在这里
    RedPointUtil.Init()

    BllMgr.GetPlayerBLL():UpdateRPs()

    BllMgr.GetBGMBLL():EnterGameReply(data.BGM)

    SelfProxyFactory.GetPlayerFavoriteProxy():UpdateFullMap(data.PlayerTag)

    BllMgr.GetSystemSettingBLL():OnLogin()

    BllMgr.GetLovePointBLL():Init(data.Role, data.Information and data.Information.InformationMap)
    BllMgr.GetCollectionRoomBLL():Init(data.Collection, data.Decoration)
    BllMgr.GetDailyDateBLL():InitDollItemData()
    BllMgr.GetInformationBLL():Init()
    --喵喵牌集卡数据
    BllMgr.GetMiaoGachaBLL():Init(data.MiaoGacha)

    BllMgr.GetGalleryNewBLL():Init(data.Collection, data.MiaoGacha)

    --约会计划数据
    if (data.DatePlanData) then
        BllMgr.GetDatePlanBLL():UpdateDatePlanData(data.DatePlanData)
    end
    ---新手成长
    BllMgr.GetActivityGrowUpBLL():Init(data.NewbieData)

    ---BattlePass
    BllMgr.GetBattlePassBLL():InitData(data.BattlePass)
    ---Url图片路径参数
    UrlImgMgr.SetBizDownloadUrl(UrlImgMgr.BizType.MHTips, "")

    -- 男主作息数据
    SelfProxyFactory.GetDailyRoutineProxy():OnLogin(data.DailyRoutine)

    -- 获取DIY部件Item
    SelfProxyFactory.GetActivityHangUpProxy():SyncAllDIYModelItem(data and data.DiyModel and data.DiyModel.ModelsMap)

    --小传数据
    SelfProxyFactory.GetAnecdoteProxy():UpdateServerData(data.Story.StoryTypeMap[X3DataConst.StoryType.Anecdote])
    SelfProxyFactory.GetLegendProxy():UpdateServerData(data.Story.StoryTypeMap[X3DataConst.StoryType.Legend])
    --ASMR基础数据-
    BllMgr.GetASMRBLL():UpdateASMRData(data.AsmrData)
    BllMgr.GetASMRBLL():CheckListRoleASMRUnlock()
    BllMgr.GetASMRBLL():SendReportAsmrPlayRequest(nil, true, true)
    ---商店
    SelfProxyFactory.GetShopProxy():Init(data.Shop)

    ---更新自定义屏蔽功能数据
    AppInfoMgr.SetCustomDisableData(data.SystemDisable)

    BllMgr.GetPhotoSystemBLL():HandleUnlockRedP()

    --更新训练营红点数据
    SelfProxyFactory.GetTrainingRoomProxy():UpdateRedPointData()

    --活动相关数据--因为活动红点有可能在CMS上配置关联其他业务红点，因此需要放到最后执行
    BllMgr.GetActivityCenterBLL():Init(data.Activity,
            { TypeConfigs = data.ActTypeConfigs, Configs = data.ActConfigs })
    BllMgr.GetQuestionBll():Init(data.Questionnaire)
    BllMgr.GetDropMultipleBLL()

    -- 彩蛋系统
    BllMgr.GetEasterEggBLL():OnLogin(data.EasterEgg and data.EasterEgg.Eggs, data.EasterEgg and data.EasterEgg.RewardEggs)

    if data.Quest ~= nil then
        SelfProxyFactory.GetTaskProxy():OnEnterGame(data.Quest.Quests, data.Quest.RwdQuests)
    end
    ---QOS埋点
    EventTraceMgr:Trace(EventTraceEnum.EventType.Enterlobby, { IZoneAreaID = BllMgr.GetLoginBLL():GetServerId() })

    ---预加载蓝图用到的类型
    CS.PapeAnimation.PapeAnimatorReflectionUtility.PreloadAsync()

    --------------------业务数据代码不要放到红点业务的后面（除非完全不涉及红点），请放到此分割线之前-------------------23.1.12 by dl
    RedPointMgr.CheckAllRed()

    if RedPointMgr.IsInit() then
        RedPointMgr.SetIsInit(false)
    end
    GrpcMgr.SetSyncUserTotalDataIsEnd(true)
end

return EnterGameMgr