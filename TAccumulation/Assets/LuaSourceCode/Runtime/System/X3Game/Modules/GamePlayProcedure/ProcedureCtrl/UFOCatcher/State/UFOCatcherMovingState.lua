---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2022/7/27 18:07
---

local Base = require("Runtime.System.X3Game.Modules.GamePlayProcedure.ProcedureCtrl.GamePlayState")
---@class UFOCatcherMovingState:GamePlayState
local UFOCatcherMovingState = class("UFOCatcherMovingState", Base)

---@type UFOCatcherBLL
local BLL = BllMgr.GetUFOCatcherBLL()

---状态进入
function UFOCatcherMovingState:OnEnter()
    self.countReduced = false
    self.owner:GamePlayPause()
    EventMgr.Dispatch("UFOCatcherPanel_Show")
    EventMgr.Dispatch("UFOCatcherPanel_ShowFunctionPanel")
    BLL.durationTime = 0
    if self.owner.gameMode == GamePlayConst.GameMode.AI then
        EventMgr.Dispatch("UFOCATCHEREVENT_UFOCATCHERSTATE_MANENTERMOVING", nil)
    else
        EventMgr.Dispatch("UFOCATCHEREVENT_UFOCATCHERSTATE_PLENTERMOVING", nil)
    end

    if self.owner.gameMode == GamePlayConst.GameMode.AI then
        ---男主抓才需要侦听引导完成
        EventMgr.AddListenerOnce(Const.Event.GUIDE_TO_CLIENT, self.OnGuideEvent, self)
    else
        self:OnGuideEvent()
    end
    if BLL:IsTwoClaw(BLL.static_UFOCatcherDifficulty.CatchType) and
            self.owner.gameMode == GamePlayConst.GameMode.Player then
        EventMgr.Dispatch(Const.Event.CLIENT_TO_GUIDE, X3_CFG_CONST.UFOCATCHER_GUIDE,
                2, -1, 0, "Moving")
    end
    EventMgr.Dispatch(Const.Event.CLIENT_TO_GUIDE, X3_CFG_CONST.UFOCATCHER_GUIDE,
            1, -1, -1, "Moving")
end

---新手引导完成
function UFOCatcherMovingState:OnGuideEvent()
    if self.owner.gameMode == GamePlayConst.GameMode.AI and GameObjectUtil.IsNull(BLL.ufoCatcherController.clawController.joystick) == false then
        local x3Animator = self.owner.maleGameObject:GetComponent(typeof(CS.X3Game.X3Animator))
        x3Animator.controlRigTarget = BLL.ufoCatcherController.clawController.joystick.transform:Find("attachment")
    end
    BLL.ufoCatcherController:ShowAimEffect()
    self.owner:OpenControlRig()
    self.owner:InitDollGameObject()
    self.owner:CheckUFOCatcherDialogue(handler(self, self.CheckDialogueCallback))
end

---剧情校验结束
function UFOCatcherMovingState:CheckDialogueCallback()
    self.countReduced = true
    self.owner:ReduceCount()
end

---状态进入
function UFOCatcherMovingState:GotoNextState()
    if self.owner.gameMode == GamePlayConst.GameMode.Player then
        self.owner:ChangeState(UFOCatcherGameState.Catching)
    else
        self.owner:ChangeState(UFOCatcherGameState.PlayerCommand)
    end
end

---
function UFOCatcherMovingState:OnExit()
    if self.countReduced == false then
        Debug.LogWarningFormat("娃娃机发现没有扣次数，保底扣除")
        self.owner:ReduceCount()
    end
    BLL.ufoCatcherController:HideAimEffect()
    if self.owner.gameMode == GamePlayConst.GameMode.Player then
        EventMgr.Dispatch("UFOCATCHEREVENT_UFOCATCHERSTATE_PLQUITEMOVING", nil)
    else
        EventMgr.Dispatch("UFOCATCHEREVENT_UFOCATCHERSTATE_MANQUITEMOVING", nil)
    end
    EventMgr.RemoveListenerByTarget(self)
end

return UFOCatcherMovingState