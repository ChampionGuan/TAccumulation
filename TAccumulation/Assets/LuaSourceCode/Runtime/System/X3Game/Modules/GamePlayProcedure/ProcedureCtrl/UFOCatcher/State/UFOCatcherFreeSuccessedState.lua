---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by junjun003.
--- DateTime: 2022/7/27 18:07
---

local Base = require("Runtime.System.X3Game.Modules.GamePlayProcedure.ProcedureCtrl.GamePlayState")
---@class UFOCatcherFreeSuccessedState : GamePlayState
local UFOCatcherFreeSuccessedState = class("UFOCatcherFreeSuccessedState", Base)

---@type UFOCatcherBLL
local BLL = BllMgr.GetUFOCatcherBLL()

---状态进入
function UFOCatcherFreeSuccessedState:OnEnter()
    EventMgr.Dispatch("UFOCATCHEREVENT_CLOSECHANGEPLAYER", nil)
    EventMgr.Dispatch("HideJoystickEffect", nil)
    EventMgr.Dispatch("RefreshCatchTimeLimit", 0)
    self.owner:ResumeAnimator()
    self.owner:DisableGameControl()

    BLL.ufoCatcherController:HideEffect()
    self.owner:ClearBetweenState()
    self.owner:CloseControlRig()
    self.owner.touchCtrl.canControl = false

    self.owner:CheckUFOCatcherDialogue(function()
        ---首轮的Prepare需要特殊处理，要先发个ReduceCount才能进FreeSuccessed
        if SelfProxyFactory.GetGamePlayProxy():GetCurrentRoundIndex() == 0 and self.owner.isFromMoving == false then
            self.owner:ReduceCount()
        end
        self.owner:SendResultToServer(handler(self, self.OnSendResultCallback))
    end)
end

---发送抓取娃娃结果给后端
function UFOCatcherFreeSuccessedState:OnSendResultCallback()
    self.owner:CatchDollCallback()
end

---状态进入
function UFOCatcherFreeSuccessedState:GotoNextState()
    self.owner:RemoveCutSceneDoll()
    if self.owner.isFromMoving then
        self.owner.isFromMoving = false
        self.owner:NextGame()
    else
        self.owner:ChangeState(self.owner:GetStateAfterPrepare())
    end
end

---状态退出
---@param nextState string
function UFOCatcherFreeSuccessedState:OnExit(nextState)
    if nextState ~= UFOCatcherGameState.Ending then
        self.owner:PrepareGameBeforeMoving()
    end
end

return UFOCatcherFreeSuccessedState