---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by baozhatou.
--- DateTime: 2023/05/24 11:58
---

---@type PureLogic.IComponent
local IComponent = require("PureLogic.Common.Component.IComponent")
---@class PureLogic.PlayerCardComp:PureLogic.IComponent
---@field entity PureLogic.ClientEntity
local PlayerCardComp = class("PlayerCardComp", IComponent)

---初始化
function PlayerCardComp:OnInit()
end

---注销
function PlayerCardComp:OnDispose()
end

---暂停
function PlayerCardComp:OnPause()
end

---继续
function PlayerCardComp:OnResume()
end

---是否能使用buff卡
---@param player pbcmessage.MiaoPlayerClient
function PlayerCardComp:CheckFuncAddBuff(player,targetType, buffId)
    -- 默认是女主
    local seat = Miao.MiaoPlayerPos.MiaoPlayerPosP1
    if targetType == Miao.MiaoFuncEffectTarget.OPPONENT then
        seat = Miao.MiaoPlayerPos.MiaoPlayerPosP2
    end

    local bbComp = self.entity:GetComponent(Miao.Component.Debug.BlackboardComp)
    
    if bbComp:HasBuff(seat,buffId) then
        return false
    end
    if buffId == Miao.MiaoBuffType.MiaoBuffTypeNumPlus then
        --当前处于【跳过】状态下，无法添加兴奋buff
        if bbComp:HasBuff(seat,Miao.MiaoBuffType.MiaoBuffTypePassNum) then
            return false
        end
    end

    return true
end

---@param effectTD cfg.MiaoCardFuncEffect
function PlayerCardComp:CheckFuncDrawCard(effectTD)

    local bbComp = self.entity:GetComponent(Miao.Component.Debug.BlackboardComp)
    local chessBoard = bbComp:GetChessBoard()

    if effectTD.Para0 == Miao.MiaoHandSubClass.MiaoHandSubClassNum then
        if chessBoard.NumPileCount == 0 then
            return false
        end
    end

    if effectTD.Para0 == Miao.MiaoHandSubClass.MiaoHandSubClassFunc then
        if chessBoard.FuncPileCount == 0 then
            return false
        end
    end

    return true
end

---查找可回收的功能牌
function PlayerCardComp:CheckFuncRecycle(count)

    local bbComp = self.entity:GetComponent(Miao.Component.Debug.BlackboardComp)
    local chessBoard = bbComp:GetChessBoard()
    
    local discardSize = #chessBoard.FuncDiscard
    if discardSize == 0 then
        return false
    end

    local recCount = math.min(count,discardSize)
    for i = 0 , recCount - 1 do
        local index = discardSize - i
        local cardId = chessBoard.FuncDiscard[index]
        local cardTD = bbComp:GetMiaoCardInfoCfg(cardId)
        local effectTD = bbComp:GetMiaoCardFuncEffectCfg(cardTD.Num)
        if effectTD.EffectType ~= Miao.MiaoFuncEffectType.RECYCLE then
            return true
        end
    end
    return false
end

---查找满足使用条件的格子
---@private
---@param effectTD cfg.MiaoCardFuncEffect
function PlayerCardComp:FindReserveFuncSlot(effectTD)
    local bbComp = self.entity:GetComponent(Miao.Component.Debug.BlackboardComp)
    local slotList = bbComp:GetSlotList()
    
    local targets = {}
    for index, slot in ipairs(slotList) do
        if bbComp:IsEffUsableInSlot(slot,effectTD) then
            table.insert(targets,index)
        end
    end
    return targets;
end


return PlayerCardComp