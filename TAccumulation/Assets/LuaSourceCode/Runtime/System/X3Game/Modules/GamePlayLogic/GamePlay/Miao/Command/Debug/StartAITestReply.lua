---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by baozhatou.
--- DateTime: 2023/5/23 16:33
---

---@type PureLogic.ICommand
local ICommand = require("PureLogic.Common.Command.ICommand")
---@class AT_StartAITestReply:PureLogic.ICommand
local AT_StartAITestReply = class('GetMiaoDataReply',ICommand)

function AT_StartAITestReply:ctor()
    ---@type PureLogic.ClientEntity
    self.entity = nil
    ICommand.ctor(self)
end

---执行命令
---@param reply pbcmessage.GetMiaoDataReply
function AT_StartAITestReply:OnCommand(reply)
    print("ReceiveCommand - cmdType : AT_StartAITestReply,state : " .. reply.State)
    local bbComp = self.entity:GetComponent(Miao.Component.Debug.BlackboardComp)
    bbComp:OnDatePrepared()
    bbComp:ParseData(reply)

    self:TryStartNewRoundGame()
end

--- 开启新的一局游戏
function AT_StartAITestReply:TryStartNewRoundGame()
    local bbComp = self.entity:GetComponent(Miao.Component.Debug.BlackboardComp)

    local data = bbComp:GetBlackboardData()
    local isFirst = data.roundCount == 0
    if isFirst then
        -- 初始化数据
        LogicUtil.Log("Start NEW GAME , T: "..PURELOGIC_MIAO_TOTAL_PLAY_NUM.. " W:" .. PURELOGIC_MIAO_WIN_NUM)
        local param = {TotalPlayNums=PURELOGIC_MIAO_TOTAL_PLAY_NUM,RecentWinNums = PURELOGIC_MIAO_WIN_NUM}
        bbComp:SendToServer(Miao.Command.GetMiaoDataRequest,param)
    end
    -- 进入新的一回合
    bbComp:SendToServer(Miao.Command.ReduceMiaoCountRequest)

    if isFirst then
        -- 决定先后手
        local rollResult = PURELOGIC_MIAO_FIRST_TYPE
        -- 随机
        if rollResult == 0 then
            rollResult = self.entity:Random(1,3)
        end
        LogicUtil.Log("Miao - Player[1] - resultType : " .. PURELOGIC_MIAO_FIRST_TYPE .. " finalResult : ".. rollResult)
        bbComp:SendToServer(Miao.Command.RollMiaoRequest, { RollResult = rollResult })
    end

    -- 初始化手牌
    bbComp:SendToServer(Miao.Command.InitMiaoHandRequest)
    -- 切换玩家
    bbComp:SendToServer(Miao.Command.AddMiaoTurnRequest)
end

return AT_StartAITestReply