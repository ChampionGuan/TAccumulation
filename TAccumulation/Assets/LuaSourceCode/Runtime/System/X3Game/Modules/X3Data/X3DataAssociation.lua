---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by canghai.
--- DateTime: 2023/8/19 14:15
---

---维护X3Data的数据关联
---@class X3DataAssociation
local X3DataAssociation = {}

---@type X3DataAssociationGraph
local Graph = require('Runtime.System.X3Game.Modules.X3Data.X3DataAssociationGraph')

---@param parent X3Data.X3DataBase
---@param child X3Data.X3DataBase
---@param field number
function X3DataAssociation.MakeAssociation(parent, child, field)
    Graph:MakeAssociation(parent, child, field)
end

---解除关联
---@param parent X3Data.X3DataBase
---@param child X3Data.X3DataBase
---@param field number
function X3DataAssociation.BreakAssociation(parent, child, field)
    Graph:BreakAssociation(parent, child, field)
end

---@param data X3Data.X3DataBase
function X3DataAssociation.ReleaseNode(data)
    Graph:ReleaseNode(data)
end

---查询给定X3Data所有的最终父节点
---1. 只要数据在数据库内，就是最终节点
---@param data X3Data.X3DataBase
---@param result X3DataAssociationGraph.Edge[]
function X3DataAssociation.GetUniqueParentNodeEdges(data, result)
    if result == nil then
        return
    end

    ---@type X3DataAssociationGraph.Edge[]
    local tempResult = PoolUtil.GetTable()
    Graph:GetParentNodeEdges(data, tempResult)
    while not table.isnilorempty(tempResult) do
        local edge = table.remove(tempResult)
        local node = edge.parentNode
        --需要通知的数据对象
        if node.data.__isInX3DataSet then
            table.insert(result, edge)
        else
            --继续将父节点加入到tempResult中
            Graph:GetParentNodeEdges(node.data, tempResult)
        end
    end
    PoolUtil.ReleaseTable(tempResult)
end

function X3DataAssociation.Clear()
    Graph:Clear()
end

return X3DataAssociation