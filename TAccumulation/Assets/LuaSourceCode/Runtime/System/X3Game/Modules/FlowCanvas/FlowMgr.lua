---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiaozhu.
--- DateTime: 2023/2/11 17:50

---@type X3Game.FlowNodeHelper
local FlowNodeHelper = CS.X3Game.FlowNodeHelper
---@type Flow.FlowGraphMgr
local GraphMgr = require("Runtime.Plugins.FlowCanvas.Base.FlowGraphMgr").new()
---@class FlowMgr
local FlowMgr = {}
local LoadGraph, GetPath
---@param flowType FlowConst.FlowType 示例：local flowGraph = FlowMgr.Create(FlowConst.FlowType.TestFlow)
---@param entity PureLogic.ClientEntity
---@param flowContext FlowContext
---@return FlowGraph
function FlowMgr.Create(flowType,entity,flowContext)
    ---@type NodeCanvas.Framework.GraphOwner
    local graphOwner = LoadGraph(flowType)
    if not graphOwner then
        Debug.LogErrorFormat("graph加载错误，FlowTypeConf中是否定义该类型[%s]", flowType)
        return
    end
    local graph = FlowMgr.GetOrAdd(graphOwner)
    if flowContext then
        graph:SetFlowContext(flowContext)
    end
    flowContext = graph:GetFlowContext()
    if entity then
        flowContext:SetEntity(entity)
    end
    return graph
end

---@param flowGraph FlowGraph
function FlowMgr.Destroy(flowGraph)
    if flowGraph then
        local graphOwner = flowGraph:GetGraphOwner()
        GraphMgr:Destroy(flowGraph)
        FlowNodeHelper.Destroy(graphOwner)
    end
end

---@param graphOwner NodeCanvas.Framework.GraphOwner
---@return FlowGraph
function FlowMgr.GetOrAdd(graphOwner)
    if not graphOwner then
        Debug.LogErrorFormat("FlowMgr.GetOrAdd failed graphOwner is nil")
        return nil
    end
    return GraphMgr:GetOrAddByGraphOwner(graphOwner)
end

---初始化
function FlowMgr.Init()
    local IFlowDelegate = require("Runtime.Plugins.FlowCanvas.Base.IFlowDelegate")
    IFlowDelegate:Set(GraphMgr)
    FlowNodeHelper.FlowDelegate = IFlowDelegate
end

---初始化
function FlowMgr.Check()
    FlowNodeHelper.CheckOwnerBehaviourStateChangeValid()
end

---清理
function FlowMgr.Clear()
    FlowNodeHelper.FlowDelegate = nil
    FlowNodeHelper.ClearOwnerBehaviourStateChange()
end

---@return Flow.FlowGraphMgr
function FlowMgr.GetGraphMgr()
    return GraphMgr
end

---@param graphName string
---@return NodeCanvas.Framework.GraphOwner
LoadGraph = function(graphName)
    local path = GetPath(graphName)
    return FlowNodeHelper.LoadGraphOwner(path)
end

---@param graphName string
---@return string
GetPath = function(graphName)
    return graphName
end

return FlowMgr