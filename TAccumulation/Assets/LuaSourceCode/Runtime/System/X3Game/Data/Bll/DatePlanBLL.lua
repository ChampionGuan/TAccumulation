---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by deling.
--- DateTime: 2023/9/12 15:12
---

---@class DatePlanBLL
local DatePlanBLL = class("DatePlanBLL", BaseBll)

---@type DatePlanCtrl
local _DatePlanCtrl = require("Runtime.System.X3Game.Modules.DatePlan.DatePlanCtrl")

---@type DatePlanConst
local DatePlanConst = require("Runtime.System.X3Game.Modules.DatePlan.DatePlanConst")

local _Send_Data = {}

function DatePlanBLL:OnInit()

    _DatePlanCtrl:Init()
    _DatePlanCtrl:OnAddListener()
end

function DatePlanBLL:OnClear()

end

--region 通信相关
--临时登录时请求下，正式流程应在登录时下发
function DatePlanBLL:GetDatePlanDataRequest()
    GrpcMgr.SendRequest(RpcDefines.GetDatePlanDataRequest, {})
end

---打开邀请函
function DatePlanBLL:SendOpenInvitationRequest(_roleId, _letterId)
    table.clear(_Send_Data)
    _Send_Data.RoleID = _roleId
    _Send_Data.LetterID = _letterId
    GrpcMgr.SendRequest(RpcDefines.OpenInvitationRequest, _Send_Data, true)
end

---接收邀请函
function DatePlanBLL:SendAcceptInvitationRequest(_roleId, _letterId)
    table.clear(_Send_Data)
    _Send_Data.RoleID = _roleId
    _Send_Data.LetterID = _letterId
    GrpcMgr.SendRequest(RpcDefines.AcceptInvitationRequest, _Send_Data, true)
end

---收起邀请函
function DatePlanBLL:SendPutAwayInvitationRequest(_roleId, _letterId)
    table.clear(_Send_Data)
    _Send_Data.RoleID = _roleId
    _Send_Data.LetterID = _letterId
    GrpcMgr.SendRequest(RpcDefines.PutAwayInvitationRequest, _Send_Data)
end

---更新日程
function DatePlanBLL:SendProgressDateRequest(_roleId, _letterId, _contentID, _stageID, _checkList, _version)
    table.clear(_Send_Data)
    _Send_Data.RoleID = _roleId
    _Send_Data.LetterID = _letterId
    _Send_Data.ContentID = _contentID
    _Send_Data.StageID = _stageID
    _Send_Data.CheckList = _checkList
    _Send_Data.Version = _version

    --Debug.LogError("SendProgressDateRequest")
    --Debug.LogErrorTable(_Send_Data)
    GrpcMgr.SendRequest(RpcDefines.ProgressDateRequest, _Send_Data, true)

end

function DatePlanBLL:SendFinishDateRequest(_roleId, _letterId)
    --Debug.LogError("SendFinishDateRequest 准备结算", _roleId, _letterId)
    table.clear(_Send_Data)
    _Send_Data.RoleID = _roleId
    _Send_Data.LetterID = _letterId
    GrpcMgr.SendRequest(RpcDefines.FinishDateRequest, _Send_Data, true)
end

---开始约会
function DatePlanBLL:SendKeepDateRequest(_roleId, _letterId)
    table.clear(_Send_Data)
    _Send_Data.RoleID = _roleId
    _Send_Data.LetterID = _letterId
    GrpcMgr.SendRequest(RpcDefines.KeepDateRequest, _Send_Data, true)
end

function DatePlanBLL:OnProgressDateReply(reply, sendData)
    _DatePlanCtrl:OnProgressDateUpdate(sendData.ContentID)
end

---约会结束时下发奖励
function DatePlanBLL:UpdateCompleteDateReply(contentList)
    _DatePlanCtrl:OnServerDateEnd(contentList)
end

--endregion
function DatePlanBLL:UpdateDatePlanData(data)
    SelfProxyFactory.GetDatePlanProxy():UpdateDatePlanData(data)

end

--region 玩法逻辑相关

---获取当前日程的男主服装(roleClothSuit的key
function DatePlanBLL:GetCurContentCloth()
    return _DatePlanCtrl:GetCurContentCloth()
end

---外部玩法结束时，按需调用，看各玩法实现
function DatePlanBLL:OnGamePlayComplete(resultData, isHangUp)
    _DatePlanCtrl:OnGamePlayComplete(resultData, isHangUp)
end

---启动玩法逻辑
function DatePlanBLL:StartDatePlanPlayLogic(letterId, curContentID)
    _DatePlanCtrl:Start(letterId, curContentID)
end

--endregion

---获取可展示的邀请函，这里需要处理排序，优先级等 --todo
---@return table<X3Data.DatePlanInvitationData>
function DatePlanBLL:GetAvailableLetter()
    return SelfProxyFactory.GetDatePlanProxy():GetAvailableLetterData()
end

function DatePlanBLL:GetGamePlayData(letterID)
    return SelfProxyFactory.GetDatePlanProxy():GetGamePlayData(letterID)
end


return DatePlanBLL