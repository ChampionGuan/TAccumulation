---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xingzi003.
--- DateTime: 2022/9/5 15:39
---
---@class HeadIconBLL : BaseBll @证件照BLL
local HeadIconBLL = class("HeadIconBLL", BaseBll)
local FaceEditConst = require("Runtime.System.X3Game.GameConst.FaceEditConst")
local FaceEditUtil = require("Runtime.System.X3Game.Modules.FaceEdit.FaceEditUtil")

function HeadIconBLL:OnInit()
    ---@type boolean 是否强制生成证件照
    self._isForceEnter = nil
    ---@type boolean 是否正显示证件照Loading
    self._isShowLoading = nil

    ---@type boolean 是否Debugging
    self._isDebugging = nil
    ---@type GameObject Debug临时对象
    self._goDebug = nil
end

function HeadIconBLL:OnClear()
    self._isForceEnter = nil
    self._isShowLoading = nil

    self:SetDebug(false)
end

---@param isForce boolean @是否强制
---@param isFirst boolean @是否首次捏脸
---@return boolean @是否成功进入HeadIcon
function HeadIconBLL:CheckHeadIcon(isForce, isFirst)
    if not BllMgr.GetFaceBLL():IsFuncEnabled() then
        return false
    end

    local uid = PlayerUtil.GetUid()
    if not uid then
        Debug.LogErrorWithTag(GameConst.LogTag.FaceEdit, "CheckHeadIcon player uid = nil")
        return false
    end

    if isForce or self:CheckLocalHeadVersion(uid) or self:CheckImgExist(uid) then
        self:EnterMode(isForce, isFirst)
        return true
    elseif self:CheckSeverHeadVersion(uid) then
        self:EnterMode(isForce, isFirst, { DefaultHeadIcon = 1 })
        return true
    end

    return false
end

function HeadIconBLL:CheckSeverHeadVersion(uid)
    local value = BllMgr.GetFaceBLL():GetFaceVersion()
    return value ~= SelfProxyFactory.GetPlayerInfoProxy():GetFaceUrlVersion()
end
function HeadIconBLL:CheckLocalHeadVersion(uid)
    local key = string.concat(FaceEditConst.HeadIconVersionPrefix, uid)
    local value = BllMgr.GetFaceBLL():GetFaceVersion()
    return PlayerPrefs.GetInt(key, -1) ~= value
end

function HeadIconBLL:CheckImgExist(uid)
    local faceCfgDict = LuaCfgMgr.GetAll("FaceCreateImg")
    for _, faceCfg in pairs(faceCfgDict) do
        if not faceCfg or not faceCfg.Key then
            Debug.LogErrorWithTag(GameConst.LogTag.FaceEdit, "CheckHeadIcon [FaceCreateImg] found no cfg")
            return false
        end

        local fileName =  faceCfg.Key .. uid
        if not UrlImgMgr.CheckFile(fileName, UrlImgMgr.BizType.HeadIcon) then
            Debug.LogFormatWithTag(GameConst.LogTag.FaceEdit, "CheckHeadIcon: %s, Exists: %s", fileName, false)
            return true
        else
            Debug.LogFormatWithTag(GameConst.LogTag.FaceEdit, "CheckHeadIcon: %s, Exists: %s", fileName, true)
        end
    end
    return false
end

---@param isForce boolean @是否强制生成
function HeadIconBLL:EnterMode(isForce, isFirst, filter)
    Debug.LogWithTag(GameConst.LogTag.FaceEdit, "[HeadIconBLL:EnterMode] isForce: ", isForce)

    self._isForceEnter = isForce
    self._isFirst = isFirst

    if not self._isForceEnter or self._isFirst then
        UICommonUtil.SetLoadingEnableWithOpenParam({
            IsFullScreen = false,
            MoveInCallBack = function()
                UICommonUtil.SetLoadingEnable(GameConst.LoadingType.Common, false)
                if not BllMgr.GetFaceBLL():NeedCloseLoading() then
                    self._isShowLoading = true
                end
                BllMgr.GetFaceBLL():CheckMergedMakeUp(function()
                    BllMgr.GetFaceBLL():OnEnterGenHeadIcon()
                    self:DoGenHeadIcon(filter)
                end)
            end,
        }, GameConst.LoadingType.FaceEditHeadIcon, true)
        UICommonUtil.SetLoadingProgress(0)
    else
        BllMgr.GetFaceBLL():OnEnterGenHeadIcon()
        self:DoGenHeadIcon(filter)
    end
end

function HeadIconBLL:DoGenHeadIcon(filter)
    if UIMgr.IsOpened(UIConf.ScenePlayerWnd) then
        EventMgr.Dispatch(FaceEditConst.Event.GenHeadIcon, filter)
    else
        UIMgr.Open(UIConf.ScenePlayerWnd, true, filter)
    end
end

---@param isLoading boolean 已打开Loading
function HeadIconBLL:ExitMode()
    Debug.LogWithTag(GameConst.LogTag.FaceEdit, "[HeadIconBLL:ExitMode] ")

    UIMgr.Close(UIConf.ScenePlayerWnd)

    BllMgr.GetFaceBLL():OnExitGenHeadIcon()
    BllMgr.GetFaceEditBLL():OnFinishCheck(self._isForceEnter, self._isFirst)

    EventMgr.Dispatch(FaceEditConst.Event.HeadIconFinish)
    self._isForceEnter = nil
    self._isFirst = nil
end

function HeadIconBLL:IsForceEnter()
    return self._isForceEnter or false
end

function HeadIconBLL:IsFirst()
    return self._isFirst or false
end

------------------------------------------------------------

---@return boolean 是否正证件照Loading
function HeadIconBLL:IsShowLoading()
    return self._isShowLoading
end

---标记证件照显示Loading
function HeadIconBLL:ShowLoading()
    self._isShowLoading = true
end

---结束证件照Loading
function HeadIconBLL:EndLoading()
    self._isShowLoading = false
end

function HeadIconBLL:CloseLoading()
    UICommonUtil.SetLoadingProgress(1, true)
    self._isShowLoading = false
end

---@return number,number Loading比重，起始比例
function HeadIconBLL:GetLoadingWeightAndProgress()
    if self._isShowLoading then
        return 1 - FaceEditConst.MaxLoadingProgress, FaceEditConst.MaxLoadingProgress
    else
        return 1, 0
    end
end

------------------------------------------------------------

--region Debug
---@return boolean
function HeadIconBLL:IsDebugging()
    return self._isDebugging and true or false
end

---@param isOn boolean
function HeadIconBLL:SetDebug(isOn)
    self._isDebugging = isOn and true or false

    if self._isDebugging then
    else
        GameObjectUtil.Destroy(self._goDebug)
        self._goDebug = nil
    end
end

---@param cameraName string 使用相机名
function HeadIconBLL:GetDebugGo(cameraName)
    if not self._goDebug or GameObjectUtil.IsNull(self._goDebug) then
        self._goDebug = GameObjectUtil.CreateGameObject("RT_DebugHeadIcon_" .. (cameraName or ""))
    end
    self._goDebug:GetOrAddComponent(typeof(CS.UnityEngine.UI.RawImage))
    GameObjectUtil.SetPosition(self._goDebug, -1000, 0)
    GameObjectUtil.SetSizeDeltaXY(self._goDebug, 100, 200)
    return self._goDebug
end
--endregion

return HeadIconBLL