--- 
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by sms.
--- DateTime: 2023/6/12 12:46
--- 战斗记录

---@class DungeonRecordBLL
local DungeonRecordBLL = class("DungeonRecordBLL", BaseBll)


function DungeonRecordBLL:OnInit()
    ---@type number timer UID -- 用于合并request
    self.recordMap = {}
    
end

function DungeonRecordBLL:OnClear()
    EventMgr.RemoveListenerByTarget(self)
end


---@public 登陆时全量数据同步
---@param dungeonRecordMap table<number, pbcmessage.DungeonRecord> 战斗记录数据  key:男主Id
function DungeonRecordBLL:OnLogin(dungeonRecordMap)
    if table.isnilorempty(dungeonRecordMap) then return end
    for roleId, dungeonRecordData in pairs(dungeonRecordMap) do
        SelfProxyFactory.GetDungeonRecordProxy():UpdateDungeonRecord(roleId, dungeonRecordData)
    end
    
    --Debug.LogError("OnLogin : " .. table.dump(SelfProxyFactory.GetDungeonRecordProxy():GetAllDungeonRecord()))
end

---@public 条件判断
function DungeonRecordBLL:CheckCondition(id, params)
    if id == X3_CFG_CONST.CONDITION_BATTLE_LAST_RESULT_TODAY then
        -- 玩家今日与指定男主（Para1）最近一次战斗是否（Para2）为指定结果（Para3）
        local roleId = tonumber(params[1])
        local flag = tonumber(params[2])
        local cfgResult = tonumber(params[3])
        
        -- 获取当日的最近一次战斗结果数据 如果没有 则直接返回false
        local dungeonRecord = self:GetLatestDungeonRecordCurDay(roleId)
        if table.isnilorempty(dungeonRecord) then return false end
        
        local battleResult = dungeonRecord.Result.Result
        if flag then return cfgResult == battleResult else return cfgResult ~= battleResult end
    elseif id == X3_CFG_CONST.CONDITION_BATTLE_REMAINING_HP_TODAY then
        -- 玩家今日与指定男主（Para1）最后一次战斗为指定结果（Para2）时，指定角色（Para3）的剩余血量百分比在[Para4,Para5]的闭区间内
        local roleId = tonumber(params[1])
        local cfgResult = tonumber(params[2])
        local targetRole = tonumber(params[3])
        local rateMin = tonumber(params[4])
        local rateMax = tonumber(params[5])
        
        -- 获取当日的最近一次战斗结果数据 如果没有 则直接返回false
        local dungeonRecord = self:GetLatestDungeonRecordCurDay(roleId)
        if table.isnilorempty(dungeonRecord) then return false end

        -- 比对战斗结果
        local battleResult = dungeonRecord.Result and dungeonRecord.Result.Result
        if not battleResult or battleResult ~= cfgResult then return false end

        -- 获取剩余血量百分比
        local remainHPRate = self:GetRemainHPRateByRecordData(dungeonRecord, targetRole)
        if not remainHPRate then return false end
        
        return ConditionCheckUtil.IsInRange(remainHPRate, rateMin, rateMax)
    elseif id == X3_CFG_CONST.CONDITION_BATTLE_DIRTFASHION_TODAY then
        -- 今日最近一次与指定男主（Para1）的战斗中，选男主穿着指定score（Para2）的指定战斗套装（Para3）并且触发了爆衫
        local roleId = tonumber(params[1])
        local scoreId = tonumber(params[2])
        local suitId = tonumber(params[3])

        -- 获取当日的最近一次战斗结果数据 如果没有 则直接返回false
        local dungeonRecord = self:GetLatestDungeonRecordCurDay(roleId)
        if table.isnilorempty(dungeonRecord) then return false end
        
        local recordScoreId = dungeonRecord.Formation and dungeonRecord.Formation.SCoreID
        local recordScoreSuitId = dungeonRecord.ScoreSuitID
        
        if recordScoreId and recordScoreSuitId and (recordScoreId == scoreId or scoreId == -1) and (recordScoreSuitId == suitId or suitId == -1) then
            if dungeonRecord.Result.IsBurst then return true end
        end
        return false
    end
end

-- 获取指定男主的最近一次当日战斗数据
---@param roleId number 角色Id
---@return pbcmessage.DungeonRecord
function DungeonRecordBLL:GetLatestDungeonRecordCurDay(roleId)
    local dungeonRecord = SelfProxyFactory.GetDungeonRecordProxy():GetDungeonRecord(roleId)
    if table.isnilorempty(dungeonRecord) then return end
    
    local battleTime = dungeonRecord.EndTime
    local isSameDay = TimeUtil.IsSameDay(TimerMgr.GetCurTimeSeconds(), battleTime)
    
    if isSameDay then return dungeonRecord end
end

-- 根据战斗结果数据和数据类型 返回数据值
---@param resultList pbcmessage.S2Int[] @ 战斗结果 key来自StageCheckData配置(CommonStageEntry.xlsx)
---@param resultType number StageCheckData表的Key
function DungeonRecordBLL:GetTargetResultValByType(resultList, resultType)
    if table.isnilorempty(resultList) then return end
    for idx, result in pairs(resultList) do
        if result.Id == resultType then
            return result.Num
        end
    end
end

-- 根据一场战斗数据返回其指定角色的剩余血量百分比
---@param dungeonRecord pbcmessage.DungeonRecord
---@param targetRole number 指定角色 0: 女主 1: 男主
function DungeonRecordBLL:GetRemainHPRateByRecordData(dungeonRecord, targetRole)
    if table.isnilorempty(dungeonRecord) or not targetRole then return end
    
    local resultList = dungeonRecord.Result and dungeonRecord.Result.ResultList
    if table.isnilorempty(resultList) then return end
    
    local maxHPType = targetRole == 0 and X3_CFG_CONST.ATTR_GIRL_MAX_HP or X3_CFG_CONST.ATTR_BOY_MAX_HP
    local remainHPType = targetRole == 0 and X3_CFG_CONST.ATTR_GIRL_HP or X3_CFG_CONST.ATTR_BOY_HP
    
    local maxHP = self:GetTargetResultValByType(resultList, maxHPType)
    local remainHP = self:GetTargetResultValByType(resultList, remainHPType)
    
    if not maxHP or not remainHP then return end
    
    local remainHPRate = remainHP / maxHP * 100
    return remainHPRate
end

return DungeonRecordBLL