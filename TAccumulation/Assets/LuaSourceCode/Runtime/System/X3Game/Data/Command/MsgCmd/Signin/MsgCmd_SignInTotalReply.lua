--- Generated by AutoGen
---
---@class MsgCmd_SignInTotalReply
local MsgCmd_SignInTotalReply = class("MsgCmd_SignInTotalReply", require("Runtime.System.Framework.GameBase.Misc.SimpleCommand"))

---Command执行
---@param data pbcmessage.SignInTotalReply
function MsgCmd_SignInTotalReply:Execute(data, clientData)
    SelfProxyFactory.GetSignProxy():UpdateSignFlag()
    ---月卡数据现在统一处理
    UICommonUtil.ShowRewardPopTips(data.SignInTotalReward)
    if (clientData.SignMark >> 2 & 1) == 1 then
        self:UpdateSignRewardTag()
    end
    if (clientData.SignMark >> 1 & 1) == 1 then
        self:UpdateMonthCardData()
    end
    BllMgr.GetWelfareBLL():UpdateSignRed()
    EventMgr.Dispatch("WelfareEvent_SignIn_SignInTotalReply")
end

function MsgCmd_SignInTotalReply:UpdateSignRewardTag()
    local signNum = BllMgr.GetWelfareBLL():GetSignInCount()
    local nowTime = TimerMgr.GetCurTimeSeconds()
    local time = BllMgr.Get("WelfareBLL"):GetNowTimeWithYearMonthDay(nowTime)
    self.year = time.year
    self.month = time.month
    self.day = time.day
    self.CurMonthDayCount = tonumber(os.date("%d", os.time({ year = self.year, month = self.month + 1, day = 0 })))
    self.yearMonthKey = self.year * 100 + self.month
    self.signRewardData = LuaCfgMgr.Get("SignTask", self.yearMonthKey)
    for k, v in pairs(self.signRewardData) do
        if v.NeedSignTimes <= signNum then
            SelfProxyFactory.GetSignProxy():UpdateSignTaskReward(v.ID)
        end
    end
end

function MsgCmd_SignInTotalReply:UpdateMonthCardData()
    ---更新月卡数据
    local cardIDTabs = BllMgr.GetMonthCardBLLReplace():GetHaveCardID()
    for i, v in ipairs(cardIDTabs) do
        SelfProxyFactory.GetMonthlyCardReplaceProxy():UpdateCardDailyRewardFlag(v)
    end
end

return MsgCmd_SignInTotalReply
