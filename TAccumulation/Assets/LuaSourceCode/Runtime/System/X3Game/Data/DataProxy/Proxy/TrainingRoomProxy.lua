---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by canghai.
--- DateTime: 2023/7/5 15:49
---

---@class TrainingRoomProxy:BaseProxy 训练营数据
local TrainingRoomProxy = class("TrainingRoomProxy", BaseProxy)
---@type TrainingRoomConst
local TrainingRoomConst = require("Runtime.System.X3Game.UI.UIView.TrainingRoomWnd.TrainingRoomConst")

function TrainingRoomProxy:OnInit()
    ---@type TrainingRoomConst.StageType
    self.stageType = TrainingRoomConst.StageType.None
    X3DataMgr.Subscribe(X3DataConst.X3Data.TrainingRoomRedPointData, self.OnIsOldChanged, self, 
            X3DataConst.X3DataField.TrainingRoomRedPointData.isOld)
end

function TrainingRoomProxy:OnClear()
    self.stageType = TrainingRoomConst.StageType.None
    X3DataMgr.UnsubscribeWithTarget(self)
end

---更新红点数据用于触发界面的红点显示
function TrainingRoomProxy:UpdateRedPointData()
    if not SysUnLock.IsUnLock(X3_CFG_CONST.SYSTEM_UNLOCK_TRAINING) then
        return
    end
    
    local trainingCampArray = LuaCfgMgr.GetAll("TrainingCamp")
    for _, trainingCamp in pairs(trainingCampArray)do
        if trainingCamp.TrainingType == TrainingRoomConst.StageType.Basic or trainingCamp.TrainingType == TrainingRoomConst.StageType.Free then
            local count = 0
            for _, id in ipairs(trainingCamp.StageID) do
                local data = X3DataMgr.Get(X3DataConst.X3Data.TrainingRoomRedPointData, id)
                if data == nil then
                    data = X3DataMgr.AddByPrimary(X3DataConst.X3Data.TrainingRoomRedPointData, nil, id)
                end
                data:SetIsUnlock(true)
                --1 表示已经查看 0 是默认状态
                if BllMgr.GetChapterAndStageBLL():StageIsUnLockById(id) then
                    --已经通关
                    data:SetIsOld(true)
                else
                    --尚未通关
                    --已经选中过页签
                    local isOldValue = RedPointMgr.GetValue(X3_CFG_CONST.RED_TRAININGROOM_ITEMCHECK, id)
                    if isOldValue == TrainingRoomConst.RedPointType.Old then
                        data:SetIsOld(true)
                    else
                        RedPointMgr.UpdateCount(X3_CFG_CONST.RED_TRAININGROOM_ITEMCHECK, 1, id)
                        count = count + 1
                    end
                end
            end
            
            RedPointMgr.UpdateCount(X3_CFG_CONST.RED_TRAININGROOM_ITEMCHECK, count, trainingCamp.TrainingType)
        elseif trainingCamp.TrainingType == TrainingRoomConst.StageType.Weapon then
            local count = 0
            for _, id in ipairs(trainingCamp.StageID) do
                local data = X3DataMgr.Get(X3DataConst.X3Data.TrainingRoomRedPointData, id)
                if data == nil then
                    data = X3DataMgr.AddByPrimary(X3DataConst.X3Data.TrainingRoomRedPointData, nil, id)
                end
                local stageEntry = LuaCfgMgr.Get("CommonStageEntry", id)
                if stageEntry ~= nil then
                    if ConditionCheckUtil.CheckConditionByCommonConditionGroupId(stageEntry.ExOpenCondition) then
                        --武器解锁就解锁
                        data:SetIsUnlock(true)
                        --1 表示已经查看 0 是默认状态
                        if BllMgr.GetChapterAndStageBLL():StageIsUnLockById(id) then
                            --已经通关
                            data:SetIsOld(true)
                        else
                            --尚未通关
                            --已经进过编队
                            --已经选中过页签
                            local isOldValue = RedPointMgr.GetValue(X3_CFG_CONST.RED_TRAININGROOM_ITEMCHECK, id)
                            if isOldValue == TrainingRoomConst.RedPointType.Old then
                                data:SetIsOld(true)
                            else
                                RedPointMgr.UpdateCount(X3_CFG_CONST.RED_TRAININGROOM_ITEMCHECK, 1, id)
                                count = count + 1
                            end
                        end
                    end
                end
            end

            RedPointMgr.UpdateCount(X3_CFG_CONST.RED_TRAININGROOM_ITEMCHECK, count, TrainingRoomConst.StageType.Weapon)
        end
        
    end
end

---返回选中页签
---@return TrainingRoomConst.StageType
function TrainingRoomProxy:GetStageType()
    local lastSelected = self.stageType
    if lastSelected == TrainingRoomConst.StageType.None then
        --如果没有上次选中的记录，选中带有红点的
        if RedPointMgr.GetCount(X3_CFG_CONST.RED_TRAININGROOM_ITEMCHECK, lastSelected) == 0 then
            for i = 1, TrainingRoomConst.StageType.__End - 1 do
                if i ~= lastSelected and RedPointMgr.GetCount(X3_CFG_CONST.RED_TRAININGROOM_ITEMCHECK, i) > 0 then
                    lastSelected = i
                    break
                end
            end
        end
    end

    --默认选中Basic
    if lastSelected == TrainingRoomConst.StageType.None then
        lastSelected = TrainingRoomConst.StageType.Basic
    end

    self.stageType = lastSelected
    return lastSelected
end

---@param value TrainingRoomConst.StageType
function TrainingRoomProxy:SetStageType(value)
    self.stageType = value
end

--region X3DataCallback
---@param data X3Data.TrainingRoomRedPointData
function TrainingRoomProxy:OnIsOldChanged(data)
    if data:GetIsOld() then
        RedPointMgr.Save(TrainingRoomConst.RedPointType.Old, X3_CFG_CONST.RED_TRAININGROOM_ITEMCHECK, data:GetPrimaryValue())
        RedPointMgr.UpdateCount(X3_CFG_CONST.RED_TRAININGROOM_ITEMCHECK, 0, data:GetPrimaryValue())
    end
end
--endregion

return TrainingRoomProxy