---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by sms.
--- DateTime: 2023/6/12 17:36

---@class EasterEggProxy
local EasterEggProxy = class("EasterEggProxy", BaseProxy)

function EasterEggProxy:OnInit()
    ---@type table<number, EasterEggData> 所有彩蛋数据Map,   key: 彩蛋id
    self.easterEggMap = {}
    
    ---@type table<number, bool> 所有已发放奖励的彩蛋Map,   key: 彩蛋id, value: bool(true)
    self.rewardedEggMap = {}
    
    ---@type table<number, pbcmessage.S3Int[]> <idx, rewardList> 保存服务器下发的彩蛋奖励
    self.allRewardList = {}
end

function EasterEggProxy:OnClear()
    self.easterEggMap = {}
end

-- 获取彩蛋数据
function EasterEggProxy:GetDataById(id)
    return self.easterEggMap[id]
end

-- 获取所有彩蛋数据
function EasterEggProxy:GetAllData()
    return self.easterEggMap
end

-- 全量数据更新
---@param rewardedEasterEggMap table<number,boolean> 已获取奖励的彩蛋map
function EasterEggProxy:UpdateAllRewardedEggMap(rewardedEasterEggMap)
    self.rewardedEggMap = rewardedEasterEggMap or {}
end

-- 这里的规则是如果彩蛋是生效状态 且配置有奖励 则进入这个map
function EasterEggProxy:CheckUpdateEggIdInRewardedEggMap(easterEggId)
    if BllMgr.GetEasterEggBLL():CheckIfEasterEggWithReward(easterEggId) then
        self.rewardedEggMap[easterEggId] = true
    end
end

-- 彩蛋数据更新
---@param easterEggData EasterEggData 彩蛋数据
---@param eventName EasterEggEnum.DebugEventMap 事件名 用于DebugMgr.TraceData 可不传~
function EasterEggProxy:UpdateData(easterEggData, eventName)
    if table.isnilorempty(easterEggData) then return end
    
    -- update data
    self.easterEggMap[easterEggData.ID] = easterEggData
    
    -- update rewardedEggMap 
    self:CheckUpdateEggIdInRewardedEggMap(easterEggData.ID)
    
    -- 数据同步后的BLL层回调
    BllMgr.GetEasterEggBLL():OnSyncEasterEgg(easterEggData.ID)
    
    -- debug mgr trace data
    EEDebugMgr:TraceEEByList({easterEggData.ID}, eventName)

    -- event fire
    EventMgr.Dispatch(EasterEggEnum.EventMap.DataUpdate)
end

-- 彩蛋数据更新 通过Map形式
---@param easterEggDataMap table<number, EasterEggData> 彩蛋Map
---@param eventName EasterEggEnum.DebugEventMap 事件名 用于DebugMgr.TraceData 可不传~
function EasterEggProxy:UpdateDataByMap(easterEggDataMap, eventName)
    --Debug.LogError("EasterEggDataMap : " .. table.dump(easterEggDataMap or {}))
    if table.isnilorempty(easterEggDataMap) then return end
    
    -- update data
    for _, v in pairs(easterEggDataMap) do
        self.easterEggMap[v.ID] = v

        -- update rewardedEggMap 
        self:CheckUpdateEggIdInRewardedEggMap(v.ID)

        -- 数据同步后的BLL层回调
        BllMgr.GetEasterEggBLL():OnSyncEasterEgg(v.ID)
    end
    
    -- debug mgr trace data
    local idList = {} for _, v in pairs(easterEggDataMap) do table.insert(idList, v.ID) end
    EEDebugMgr:TraceEEByList(idList, eventName)
    
    -- event fire
    EventMgr.Dispatch(EasterEggEnum.EventMap.DataUpdate)
end

-- 彩蛋奖励数据
function EasterEggProxy:PoolRewardList(rewardList)
    if table.isnilorempty(rewardList) then return end

    -- 通用接口
    UICommonUtil.ShowRewardPopTips(rewardList, 2)

    -- 这个就先不要了
    --table.insert(self.allRewardList, rewardList)
end

---@public 检查彩蛋是否已经领过奖了(带奖励的彩蛋领奖意味着失效)
function EasterEggProxy:CheckIfEasterEggRewarded(easterEggId)
    -- 检查配置是否带奖励
    local isRewardInCfg = BllMgr.GetEasterEggBLL():CheckIfEasterEggWithReward(easterEggId)
    if not isRewardInCfg then return false end
    
    if table.isnilorempty(self.rewardedEggMap) then return false end
    
    if self.rewardedEggMap[easterEggId] then return true end
    
    return false
end

return EasterEggProxy