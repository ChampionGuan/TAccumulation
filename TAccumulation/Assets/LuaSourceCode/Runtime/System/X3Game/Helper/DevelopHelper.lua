---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by muchen.
--- DateTime: 2022/1/7 14:27
---
---@class DevelopHelper
local DevelopHelper = {}

--- 培养中设置属性Icon
---@param targetImage Object
---@param id propertyId 属性id
function DevelopHelper.SetAttrIcon(targetImage, id)
    if targetImage == nil then
        return
    end
    local propertyInfo = LuaCfgMgr.Get("Property", id)
    UIUtil.SetImage(targetImage, propertyInfo.BgIcon)
end

---获取羁绊卡 品质
---@param id 品质id
---@return string,string 稀有度icon 稀有度背景
function DevelopHelper.GetCardRarityIconInfo(id)
    local rareInfo = LuaCfgMgr.Get("CardRare", id)
    if rareInfo ~= nil then
        return rareInfo.RarityIcon, rareInfo.RarityBg
    end
    return nil
end

---获取培养消耗相关
---@param curAmount int 当前数量
---@param needAmount int 需要数量
---@return string Text
function DevelopHelper.DevelopCostStr(curAmount, needAmount)
    local tips = ""
    if curAmount < needAmount then
        tips = UITextHelper.GetUIText(UITextConst.UI_TEXT_8230, tostring(curAmount))
    else
        tips = tostring(curAmount)
    end
    return string.concat(tips, "/", needAmount)
end

---打开分解界面
---@param tipsType int
---@param rewards cfg.s3int[] 真实获得的奖励
function DevelopHelper.OpenDeComposeTips(tipsTitle, rewards)
    if table.isnilorempty(rewards) then
        return
    end
    local showReward, decomposeReward = BllMgr.GetItemBLL():GetShowRewardAndTransReward(rewards)
    if (not table.isnilorempty(showReward)) and (not table.isnilorempty(decomposeReward)) then
        ErrandMgr.Add(X3_CFG_CONST.POPUP_SCORECARD_FRAGMENT, { tipsTitle, showReward, decomposeReward })
    end
end

---获取增加经验道具 card 和芯核
---@param exp int  需要的经验
---@param itemIdList table<int> 升级道具的itemId
---@param curConst table<S3Int> 当前已经放入的item
---@return realSurplusExp, totalPrice, costItem  剩余经验 当前消耗金币 结果Item
function DevelopHelper.GetCostListByExp(exp, itemIdList, curConst)
    local realSurplusExp = exp
    local totalPrice = 0
    local price = 0
    local costItem = {}
    for i = 1, #itemIdList do
        realSurplusExp, price = DevelopHelper.GetCostListByItem(LuaCfgMgr.Get("Item", itemIdList[i]), realSurplusExp, costItem, curConst)
        totalPrice = totalPrice + price
        if realSurplusExp == 0 then
            break
        end
    end
    return realSurplusExp, totalPrice, costItem
end

function DevelopHelper.GetCostListByItem(item, exp, costList, curConst)
    local mItem = BllMgr.Get("ItemBLL"):GetItem(item.ID);
    local num = 0
    if mItem ~= nil then
        if curConst == nil then
            num = mItem.Num
        else
            num = mItem.Num - DevelopHelper.GetCurConsumeNumById(curConst, item.ID)
        end
    end
    if num == 0 then
        return exp, 0
    end
    local mItemNum = math.ceil(exp / item.IntExtra1) --这里的数量须向上取整
    if mItemNum > num then
        --超出已有数量，按已有数量
        table.insert(costList, #costList + 1, { Id = item.ID, Type = item.Type, Num = num })
        return exp - num * item.IntExtra1, item.IntExtra2 * num
    else
        table.insert(costList, #costList + 1, { Id = item.ID, Type = item.Type, Num = mItemNum })
        return 0, item.IntExtra2 * mItemNum
    end
end

function DevelopHelper.GetCurConsumeNumById(curConst, itemId)
    local retNum = 0
    for i = 1, #curConst do
        local item = curConst[i]
        if item.Id == itemId then
            retNum = retNum + item.Num
        end
    end
    return retNum
end


---@param enterType int
---@param scoreList cfg.SCoreBaseInfo[]
---@param tabIndex int
---@param scoreId int
---@param detailTabType int
function DevelopHelper.OpenScoreMainWnd(enterType, scoreList, tabIndex, scoreId, detailTabType)
    --UIMgr.Open(UIConf.ScoreMainWnd, enterType, scoreList, tabIndex, scoreId, detailTabType)
end

---打开思念详情界面
---@param cardId number 思念ID
---@param viewMode Define.CardMainWndViewMode 界面显示模式
---@param cardList number 思念列表，用于思念主界面滑动查看
---@param viewModeExtraData any 不同ViewMode的额外数据
function DevelopHelper.OpenCardMainWnd(cardId, viewMode, cardList, viewModeExtraData)
    UIMgr.Open(UIConf.DevelopCardMainWnd, cardId, viewMode, cardList, viewModeExtraData)
end

---获取战斗标签名字
---@param tag int
---@return string|nil
function DevelopHelper.GetBattleTagName(tag)
    if tag then
        ---@type cfg.FormationTag
        local cfg_FormationTag = LuaCfgMgr.Get("FormationTag", tag)
        if cfg_FormationTag then
            return UITextHelper.GetUIText(cfg_FormationTag.TagName), cfg_FormationTag.TagImg
        end
    end
    return nil
end

---@return string
function DevelopHelper.GetPropertyName(propertyType)
    ---@type cfg.Property
    local cfg_Property = LuaCfgMgr.Get("Property", propertyType)
    if cfg_Property then
        return UITextHelper.GetUIText(cfg_Property.ShowName)
    end
    return nil
end

---@return string 获取属性显示文本
function DevelopHelper.GetPropertyValueShowText(propertyType, propertyValue, isIncrement)
    ---@type cfg.Property
    local cfg_Property = LuaCfgMgr.Get("Property", propertyType)
    if not cfg_Property then
        Debug.LogErrorFormat("获取属性配置失败：%s", tostring(propertyType))
    end
    if cfg_Property.ShowPercent == 0 then
        if isIncrement then
            ---8270    +{0}
            return UITextHelper.GetUIText(UITextConst.UI_TEXT_8270, math.floor(propertyValue))
        else
            return tostring(math.floor(propertyValue))
        end
    end
    ---百分比显示
    local mValue = (propertyValue / 1000) * 100
    if isIncrement then
        ---8217 +{0}%
        return UITextHelper.GetUIText(UITextConst.UI_TEXT_8217, string.format("%.1f", tostring(mValue)))
    else
        ---8246 {0}%
        return UITextHelper.GetUIText(UITextConst.UI_TEXT_8246, string.format("%.1f", tostring(mValue)))
    end
end

---获取属性icon 名字
---@param propertyType int 属性id
---@return string
function DevelopHelper.GetPropertyIcon(propertyType)
    ---@type cfg.Property
    local cfg_Property = LuaCfgMgr.Get("Property", propertyType)
    if cfg_Property then
        return cfg_Property.BgIcon
    end
    return nil
end

return DevelopHelper
