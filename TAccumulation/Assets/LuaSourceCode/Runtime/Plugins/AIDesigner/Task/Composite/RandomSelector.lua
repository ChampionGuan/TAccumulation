---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by chaoguan.
--- DateTime: 2021/3/19 17:44
---

local AIComposite = require("Runtime.Plugins.AIDesigner.Base.AITask").AIComposite

---随机执行子节点，当遇到子节点返回成功时，则中断后续子节点执行；
---全部节点返回失败，该节点就返回失败
---IconName:RandomSelectorIcon.png
---@class AI.RandomSelector:AIComposite
local RandomSelector = AIUtil.class("RandomSelector", AIComposite)

function RandomSelector:OnEnter()
    ---@type AITask[]
    local children = self.context:GetTable()
    for i = #self.children, 1, -1 do
        table.insert(children, table.remove(self.children, self.context:Random(1, i)))
    end
    self.context:ReleaseTable(self.children)
    self.children = children
end

function RandomSelector:OnUpdate()
    for _, child in ipairs(self.children) do
        if not child.disabled then
            if child.state == AITaskState.Running or child.state == AITaskState.BlockingUp then
                return AITaskState.BlockingUp
            elseif child.state == AITaskState.Success then
                return AITaskState.Success
            end
        end
    end
    return AITaskState.Failure
end

function RandomSelector:CanRunChild(index)
    for i = 1, index - 1 do
        local child = self.children[i]
        if not child.disabled and (child.state == AITaskState.Success or child.state == AITaskState.Running or child.state == AITaskState.BlockingUp) then
            return false
        end
    end
    return true
end

return RandomSelector