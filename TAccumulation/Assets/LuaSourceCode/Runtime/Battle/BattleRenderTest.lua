---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by canglan.
--- DateTime: 2023/10/9 19:41
---

---@class BattleRenderTest
local BattleRenderTest = {}

local csBattle = CS.X3Battle.Battle
local csUtils = CS.X3Battle.Debugger.Utils

function BattleRenderTest:Enter()
    self.cameraBrain = CS.Cinemachine.CinemachineBrain
    self.actors = csBattle.Instance.actorMgr.actors
    self.girl = csBattle.Instance.player
    self.boy = csBattle.Instance.actorMgr.boy
    self.playerInput = csBattle.Instance.input
    self._updateId = TimerMgr.AddTimer(10, self._TryCastSkill, self, true)
    self._monsterPosList = {}
    self._monsterSkillIds = { 4003109, 4011004, 3111004, 3361003, 3362002 }
    self._girlPos = self.girl.transform.position
    self._girlRot = self.girl.transform.eulerAngles

    ---无敌
    csUtils.AddBuff(self.girl, 1, 1)
    csUtils.AddBuff(self.boy, 1, 1)
    csUtils.SetUnlimitedHp(self.girl.insID, true)
    csUtils.SetUnlimitedHp(self.boy.insID, true)
    ---禁用AI
    self.girl.aiOwner:DisableAll(true)
    self.boy.aiOwner:DisableAll(true)

    g_BattleClient:AddListener(EventType.Actor, self, self._OnActorBorn, "BattleRenderTest.OnActorBorn")
end

---@param data X3Battle.EventActor
function BattleRenderTest:_OnActorBorn(_, data)
    local curActor = data.actor
    if not curActor:IsMonster() or curActor:IsSummoner() then
        return
    end
    ---无敌
    csUtils.AddBuff(curActor, 1, 1)
    csUtils.SetUnlimitedHp(curActor.insID, true)
    ---禁用AI
    if curActor.aiOwner then
        curActor.aiOwner:DisableAll(true)
    end
    ---记录初始位置
    table.insert(self._monsterPosList, curActor.transform.position)
end

function BattleRenderTest:_TryCastSkill()
    if not self.cameraBrain.SoloCamera then
        self.cameraBrain.SoloCamera = csBattle.Instance.cameraTrace:GetCameraBrain().ActiveVirtualCamera
    end

    self.girl.model:SetPosition(self._girlPos)
    self.girl.model:SetEulerAngles(self._girlRot)
    local index = 0
    for i = 0, self.actors.Count - 1 do
        ---@type X3Battle.Actor
        local actor = self.actors[i]
        if actor:IsMonster() and not actor:IsSummoner() and actor.model then
            index = index + 1
            if index > #self._monsterPosList then
                index = 1
            end
            actor.model:SetPosition(self._monsterPosList[index], true)
        end
    end

    self.playerInput:TryCastSkill(CS.X3Battle.PlayerBtnType.Coop, self.boy.insID)
    local index = 0
    for i = 0, self.actors.Count - 1 do
        ---@type X3Battle.Actor
        local actor = self.actors[i]
        if actor:IsMonster() and not actor:IsSummoner() and actor.skillOwner then
            index = index + 1
            local skillId = self._monsterSkillIds[index]
            csUtils.CastSkillByEditor(actor.insID, skillId)
        end
    end
end

function BattleRenderTest:Exit()
    g_BattleClient:RemoveListener(EventType.Actor, self, self._OnActorBorn)
    TimerMgr.Discard(self._updateId)
    self.cameraBrain = nil
    self.actors = nil
    self.girl = nil
    self.boy = nil
    self.playerInput = nil
    self._monsterPosList = nil
    self._girlPos = nil
    self._girlRot = nil
    self._monsterSkillIds = nil
end

return BattleRenderTest