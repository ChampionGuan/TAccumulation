---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by chaoguan.
--- DateTime: 2022/6/6 19:01
---

require("Runtime.Battle.Common.BattleEnum")

local Behavior = require("Runtime.Battle.Common.Behavior")
local SafeHandlerMgr = require("Runtime.System.X3Game.Modules.SafeHandlerMgr")
local BattleUI = require("Runtime.Battle.Behavior.BattleUI")

---@class Lua.BattleClient:Behavior
local BattleClient = XECS.class("BattleClient", Behavior)

function BattleClient:ctor()
    BattleClient.super.ctor(self)

    g_BattleClient = self
    self.csBattleClient = CS.X3Battle.BattleClient.Instance
    self.csBattle = CS.X3Battle.Battle.Instance
    g_csBattle = self.csBattle
    self.eventMgr = XECS.EventMgr.new()
    self.handlerMgr = SafeHandlerMgr.new()

    ---@type BattleUI
    self.ui = self:AddBehavior(BattleUI.new())
end

function BattleClient:OnBattleBegin()

end

function BattleClient:OnBattleEnd()
    -- 隐藏退出按钮.
    self.ui:HideQuitBtn()

    -- 游戏结束时强制关闭真机调试窗口
    UIMgr.Close("Debug_BattleWnd",false)
end

--- 生成一个安全的闭包
---@return SafeHandler
function BattleClient:SafeHandler(param1, param2)
    return self.handlerMgr:Handler(param1, param2)
end

function BattleClient:IsPrologueChapter()
    if self.csBattle.arg.startupType ~= BattleStartupType.Online then
        return false
    else
        return BllMgr.Get("ChapterAndStageBLL"):IsPrologueChapter()
    end
end

---添加监听
---@param eventType EventType
---@param listener table 目标对象
---@param callback function 目标对象的回调函数
function BattleClient:AddListener(eventType, listener, callback, debugTag)
    self.eventMgr:AddListener(eventType, listener, callback, debugTag)
end

---移除监听
---@param eventType EventType
---@param listener table 目标对象
function BattleClient:RemoveListener(eventType, listener)
    self.eventMgr:RemoveListener(eventType, listener)
end

function BattleClient:OnDestroy()
    BattleClient.super.OnDestroy(self)
    ---UIMgr.Close("BattleWnd",false)
    self.handlerMgr:Clear()
    self.eventMgr:OnDestroy()
    self.csBattleClient = nil
    self.csBattle = nil
    self.eventMgr = nil
    self.handlerMgr = nil
    g_BattleClient = nil
    g_csBattle = nil
end

return BattleClient