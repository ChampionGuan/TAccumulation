---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by canglan.
--- DateTime: 2021/11/18 11:04
---

local SlotBase = require("Runtime.Battle.Behavior.UI.Slot.SlotBase")

---@class PowerSlot:SlotBase
local PowerSlot = XECS.class("PowerSlot", SlotBase)
PowerSlot.Type = BattleSlotBehaviorType.PowerSlot

local PlayerBtnType = CS.X3Battle.PlayerBtnType
local csParticleSystemStopBehavior = CS.UnityEngine.ParticleSystemStopBehavior
local AttrType = CS.X3Battle.AttrType
local csBattleUtil = CS.X3Battle.BattleUtil

function PowerSlot:ctor()
    SlotBase.ctor(self)
    self._curFrame = 6

    self._showNormalMessage = false

    self._finalConditionMessage = 20015

    --爆发技的显示规则不一样
    self._powerSkillStyle = nil

    self._cdIndex = 0
    self._egIndex = 0
    self._disableIndex = 1
    self._activeIndex = 2
end

function PowerSlot:Awake()
    SlotBase.Awake(self)
    self._transform = self:GetComponent("OCX_PowerSkill", "Transform")
    self._headImgTrans = self:GetComponent("OCX_Power_img_head", "Transform")
    self._cdImgTrans = self:GetComponent("OCX_Power_img_cd", "Transform")
    self._emergeEffect = self:GetComponent("OCX_Power_fx_ui_battle_emerge", "ParticleSystem")
    self._activeLoopEffect = self:GetComponent("OCX_Power_fx_ui_battle_loop", "ParticleSystem")
    self._styleEnum = self._transform:GetComponent("StyleEnum")
    self._energyFullSound = self:GetComponent("OCX_Power_fx_ui_battle_emerge", "Transform")

    self._hasCastEnergy = true
    self._btnType = PlayerBtnType.Ultra
    self:Register()
end

function PowerSlot:SetLeftDeadBtnState()
    SlotBase.SetLeftDeadBtnState(self)
    self._activeLoopEffect:Stop(true, csParticleSystemStopBehavior.StopEmittingAndCleanup)
end

function PowerSlot:UpdateProgress()
    if not self._slot then
        return
    end
    local haveCastEnergy = self._slot:HaveCastEnergy()
    if haveCastEnergy then
        self._hasCastEnergy = true
        local energyValue = self:GetSlotUltraEnergyValue()
        self:SetBarProgress(self._cdImgTrans, energyValue)
    else
        if self._hasCastEnergy then
            self._hasCastEnergy = false
            self:SetBarProgress(self._cdImgTrans, 0)
        end
    end
end

-- TODO 伟龙 临时写法，待UI模块优化
function PowerSlot:GetActor1101Energy()
    return self._battleUI.playerAttrOwner:GetAttrValue(AttrType.SkillEnergy)
end

function PowerSlot:GetSlotUltraEnergyValue()
    return csBattleUtil.GetSlotUltraEnergyValue(self._slot)
end

---@param state Int
function PowerSlot:TryPlaySkill(state)
    if not self._slot then
        return
    end
    SlotBase.TryPlaySkill(self, state, self:IsBoyDead(), not self._slot:IsEnergyFull())
    --爆发技会有一段暂停时间。处理暂停结束之后才刷新能量表现的问题
    self:UpdateBtnState()
end


function PowerSlot:OnDestroy()
    SlotBase.OnDestroy(self)
end

return PowerSlot