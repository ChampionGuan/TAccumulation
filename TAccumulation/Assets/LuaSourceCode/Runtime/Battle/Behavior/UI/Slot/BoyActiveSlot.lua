---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by weilong.
--- DateTime: 2023/5/17 14:31
---

local SlotBase = require("Runtime.Battle.Behavior.UI.Slot.SlotBase")

---@class BoyActiveSlot:SlotBase
local BoyActiveSlot = XECS.class("BoyActiveSlot", SlotBase)
BoyActiveSlot.Type = BattleSlotBehaviorType.BoyActiveSlot

local PlayerBtnType = CS.X3Battle.PlayerBtnType
local csBattleUtil = CS.X3Battle.BattleUtil

function BoyActiveSlot:ctor()
    SlotBase.ctor(self)
    self._curFrame = 3

    self._cdIndex = 0
    self._disableIndex = 1
    self._egIndex = 2
    self._activeIndex = 3

    ---@type UnityEngine.Transform
    self._qteTransform = nil
    ---@type PapeGames.X3UI.StyleEnum
    self._qteStyleEnum = nil
    ---@type UnityEngine.Transform
    self._cd_anchor = nil
    ---@type UnityEngine.ParticleSystem
    self._ringEffect = nil
    ---@type UnityEngine.Transform
    self._ringTransform = nil

    self._isQTEOn = false
    self._qteEnum = nil

    self._indexNormal = 1
    self._indexQteCD = 0
    self._indexQteOn = 2

    self._currentQteIndex = self._indexNormal
end

function BoyActiveSlot:Awake()
    SlotBase.Awake(self)
    self._transform = self:GetComponent("OCX_BoyActiveSkill", "Transform")
    self._headImgTrans = self:GetComponent("OCX_BoyActive_img_head", "Transform")
    self._cdImgTrans = self:GetComponent("OCX_BoyActive_img_cd", "Transform")
    self._cdText = self:GetComponent("OCX_BoyActive_text_cd", "TextMeshProUGUI")
    self._effect = self:GetComponent("OCX_BoyActive_fx_ui_battle_click", "ParticleSystem")
    self._longPressOutEffect = self:GetComponent("OCX_BoyActive_fx_ui_battle_click_out", "ParticleSystem")
    self._emergeEffect = self:GetComponent("OCX_BoyActive_fx_ui_battle_click_loop", "ParticleSystem")
    self._styleEnum = self._transform:GetComponent("StyleEnum")
    self:SetActive("OCX_BoyActive_fx_ui_battle_click_loop", false)

    self._qteTransform = self:GetComponent("OCX_BoyActive_QTE","Transform")
    self._qteStyleEnum = self._qteTransform:GetComponent("StyleEnum")
    self._cd_anchor = self:GetComponent("OCX_Boy_cd_anchor","Transform")
    self._cdImgHeight = self._cdImgTrans.rect.height

    --用于处理Unvisible下Active无法播放粒子特效的问题
    self._ringEffect = self:GetComponent("OCX_fx_ui_battle_cd_done", "ParticleSystem")
    self._ringTransform = self:GetComponent("OCX_fx_ui_battle_cd_done","ParticleSystem")
    self._battleUI:SetActive(self._ringTransform,true)
    self._ringEffect:Play()

    self._btnType = PlayerBtnType.Active
    self:Register()

end

function BoyActiveSlot:SetSlot()
    if not self._battleUI.boy then
        return
    end
    self._actor = self._battleUI.boy
    SlotBase.SetSlot(self)
    if not self._slot then
        return
    end
    self._currentSlotID = self._slot.ID
    self._qteStyleEnum:SetIdx(self._currentQteIndex)
end

function BoyActiveSlot:UpdateBtnState()
    SlotBase.UpdateBtnState(self)
    if self:UpdateSkillDisable() then
        return
    end
    self:_UpdateQTE()
end

--技能发生变化了，切换图标
function BoyActiveSlot:_OnQteStateChange()
    --切换图标
    local curSlotID = csBattleUtil.GetCurSlotIdByBtnType(self._battleUI.boySkillOwner, self._btnType)
    if curSlotID ~= self._currentSlotID then
        self._currentSlotID = curSlotID
        self._slot = self._battleUI.boySkillOwner:GetSkillSlot(curSlotID)
        local skillIcon = self._slot.skill.skillIcon
        if skillIcon and skillIcon ~= "" then
            self:SetImage(self._headImgTrans, skillIcon)
        end
    end
end

function BoyActiveSlot:_UpdateQTE()
    if self._battleUI.qteController == nil then
        return
    end

    if self._battleUI.qteController.isActive then
        if self._currentQteIndex ~= self._indexQteOn then
            self:_OnQteStateChange()
            self._currentQteIndex = self._indexQteOn
            self._qteStyleEnum:SetIdx(self._currentQteIndex)
        end
        return
    end

    if self._battleUI.qteController.cdRemainTime>0 then
        if self._currentQteIndex ~= self._indexQteCD then
            self:_OnQteStateChange()
            self._currentQteIndex = self._indexQteCD
            self._qteStyleEnum:SetIdx(self._currentQteIndex)
        end
        return
    end

    if self._currentQteIndex ~= self._indexNormal then
        self:_OnQteStateChange()
        self._currentQteIndex = self._indexNormal
        self._qteStyleEnum:SetIdx(self._currentQteIndex)
    end

end

--男主死亡或不存在也和女主死亡一样处理
function BoyActiveSlot:IsGirlDead()
    if not self._battleUI.player or not self._battleUI.boy then
        return false
    end
    return self._battleUI.player.isDead or self._battleUI.boy.isDead
end

---@param state Int
function BoyActiveSlot:TryPlaySkill(state)
    if not self._slot then
        return
    end
    if self._battleUI.boy == nil then
        return
    end
    SlotBase.TryPlaySkill(self, state, false, self._slot:IsCD() or not self._slot:IsEnergyFull(),self._battleUI.boy.insID)
end

function BoyActiveSlot:PlayerBtnStateChange(btnType, isDown, casterID)
    if self._battleUI.playerInput then
        self._battleUI.playerInput:PlayerBtnStateChange(btnType, isDown, casterID)
    end
end

function BoyActiveSlot:UpdateSkillDisable()
    --使用男主进行判断
    if self._battleUI.boySkillOwner == nil then
        return false
    end
    --兼容调试器跳过结算流程，男主死后继续游戏
    if self._slot == nil then
        return false
    end
    if self._battleUI.boySkillOwner.disableController:IsDisableSkill(self._slot.skill) then
        self:_TransSlotState(self._disableIndex)
        return true
    end
    return false
end

function BoyActiveSlot:UpdateProgress()
    if not self._slot then
        return
    end
    local cdNum = self._slot.remainCD
    if cdNum <= 0 then
        return
    end
    if self._lastMaxCD > 0 then
        local progress = 1 - cdNum / self._lastMaxCD
        --- 男主技能的CD进度条是反的
        self:SetBarProgress(self._cdImgTrans, progress)
        --- 能量特效跟着动
        csBattleUtil.SetAnchoredPosition(self._cd_anchor, 0, self._cdImgHeight * progress)
    else
        Debug.LogError("self._lastMaxCD <= 0 ")
    end

end


function BoyActiveSlot:OnDestroy()
    self._qteTransform = nil
    self._qteStyleEnum = nil
    self._cd_anchor = nil
    self._ringEffect = nil
    self._ringTransform = nil
    SlotBase.OnDestroy(self)
end

return BoyActiveSlot