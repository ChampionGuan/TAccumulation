---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by canglan.
--- DateTime: 2023/10/30 17:32
---

local UIBehaviorBase = require("Runtime.Battle.Behavior.UI.UIBehaviorBase")
---@class BigSpiral:UIBehaviorBase
local BigSpiral = XECS.class("BigSpiral", UIBehaviorBase)
BigSpiral.Type = BattleUIBehaviorType.BigSpiral
local ConditionTargetHp = 301006
local csBattleUtil = CS.X3Battle.BattleUtil

---@type BattleConditionCheck
local BattleConditionCheck = require("Runtime.System.X3Game.UI.UIView.BattleSettingWnd.BattleConditionCheck")

function BigSpiral:ctor()
    UIBehaviorBase.ctor(self)
    self._condition0 = nil
    self._condition1 = nil
    self._condition2 = nil
    self._cfg_CommonStageEntry = nil
    self._titleTxt = nil
    self._condition1StyleEnum = nil
    self._condition2StyleEnum = nil
    self._condition3StyleEnum = nil
    self._condition1Des = nil
    self._condition2Des = nil
    self._condition3Des = nil
end

function BigSpiral:Awake()
    UIBehaviorBase.Awake(self)
    self.csBattle = CS.X3Battle.Battle.Instance
    self._transform = self:GetComponent("OCX_HunterContest","Transform")
    self:SetActive(self._transform, true)
    self._titleTxt = self:GetComponent("OCX_HunterContest_Title","Transform")
    self._condition1StyleEnum = self:GetComponent("OCX_HunterContest_Star1","StyleEnum")
    self._condition2StyleEnum = self:GetComponent("OCX_HunterContest_Star2","StyleEnum")
    self._condition3StyleEnum = self:GetComponent("OCX_HunterContest_Star3","StyleEnum")
    self._condition1Des = self:GetComponent("OCX_HunterContest_Text1","Transform")
    self._condition2Des = self:GetComponent("OCX_HunterContest_Text2","Transform")
    self._condition3Des = self:GetComponent("OCX_HunterContest_Text3","Transform")
end

function BigSpiral:Start()
    UIBehaviorBase.Start(self)
    self._battleConditionCheck = BattleConditionCheck.new()
    self._battleConditionCheck:Init()
    local commonStageId = self._battleUI.csBattle.arg.commonStageId
    self._cfg_CommonStageEntry = LuaCfgMgr.Get("CommonStageEntry", commonStageId)

    if self._cfg_CommonStageEntry == nil or self._cfg_CommonStageEntry.Type ~= 13 then
        self:SetNodeVisible(self._transform, false)
        self._battleUI:SetIsBigSpiral(false)
        return
    else
        local textId = self._cfg_CommonStageEntry.IntExtra1 == 1 and 21590 or 21591

        ---@type cfg.CommonCondition[]
        self._condition1 = ConditionCheckUtil.GetCommonConditionListByGroupId(self._cfg_CommonStageEntry.ThreeStarCondition1)[1]
        self._condition2 = ConditionCheckUtil.GetCommonConditionListByGroupId(self._cfg_CommonStageEntry.ThreeStarCondition2)[1]
        local des1
        if self._cfg_CommonStageEntry.ThreeStarCondition0 > 0 then
            self._condition0 = ConditionCheckUtil.GetCommonConditionListByGroupId(self._cfg_CommonStageEntry.ThreeStarCondition0)[1]
            des1 = UITextHelper.GetUIText(self._condition0.ShortDescription)
        else
            des1 = UITextHelper.GetUIText(self._cfg_CommonStageEntry.ThreeStarConditionShortDesc0)
        end
        local des2 = UITextHelper.GetUIText(self._condition1.ShortDescription)
        local des3 = UITextHelper.GetUIText(self._condition2.ShortDescription)
        --condition类型是301006时，title显示的内容会改变
        if self._condition1.ConditionType == ConditionTargetHp then
            local condition2UItextID = csBattleUtil.GetStageCondition2UItextID(self._condition1.ConditionPara0)
            if condition2UItextID ~= 0 then
                textId = condition2UItextID
            end
        end

        local title = UITextHelper.GetUIText(textId)
        self:SetText(self._titleTxt, title)
        self:SetText(self._condition1Des, des1)
        self:SetText(self._condition2Des, des2)
        self:SetText(self._condition3Des, des3)

        if self.csBattle.actorMgr.girl then
            self:_UpdateConditions()
        end

        self:SetNodeVisible(self._transform, true)
        self._battleUI:SetIsBigSpiral(true)
    end
end

function BigSpiral:_UpdateConditions()
    if self._condition0 then
        self._condition1StyleEnum.IsOn = self._battleConditionCheck:CheckCondition(self._condition0)
    end
    self._condition2StyleEnum.IsOn = self._battleConditionCheck:CheckCondition(self._condition1)
    self._condition3StyleEnum.IsOn = self._battleConditionCheck:CheckCondition(self._condition2)
end

function BigSpiral:_OnUpdate()
    if not self.csBattle.actorMgr.girl then
        return
    end
    if self._cfg_CommonStageEntry == nil or self._cfg_CommonStageEntry.Type ~= 13 then
        return
    end
    self:_UpdateConditions()
end

function BigSpiral:OnDestroy()
    self._condition0 = nil
    self._condition1 = nil
    self._condition2 = nil
    self._cfg_CommonStageEntry = nil
    self._titleTxt = nil
    self._condition1StyleEnum = nil
    self._condition2StyleEnum = nil
    self._condition3StyleEnum = nil
    self._condition1Des = nil
    self._condition2Des = nil
    self._condition3Des = nil
    UIBehaviorBase.OnDestroy(self)
end

return BigSpiral