---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by sanxi.
--- DateTime: 2023/1/13 11:07
---

local UIBehaviorBase = require("Runtime.Battle.Behavior.UI.UIBehaviorBase")

---@class MissionTips:UIBehaviorBase
local MissionTips = XECS.class("MissionTips", UIBehaviorBase)
local csBattleUtil = CS.X3Battle.BattleUtil
MissionTips.Type = BattleUIBehaviorType.MissionTips

function MissionTips:ctor()
    UIBehaviorBase.ctor(self)
    self._requiredUpdate = false
end

function MissionTips:Awake()
    UIBehaviorBase.Awake(self)
    self.isShow = nil
    self.battleGuideType = 11
    --字符串解析槽位的新类型
    self.battleGuideTypeNew = 3
    self._transform = self:GetComponent("OCX_MissionTips", "Transform")
    self.missionTitle = self:GetComponent("OCX_MissionTips_Title", "Transform")
    self.missionText = self:GetComponent("OCX_MissionTips_Text", "Transform")
    self.isShow = false
    self.numberList = {}
    self.tipsID = 0

    self:SetActive(self._transform, true)
    self:SetNodeVisible(self._transform, false)
    
end

function MissionTips:Start()
    g_BattleClient:AddListener(EventType.ShowMissionTips, self, self.OnMissionTipsChange, "MissionTips.ShowTip")
    self:PlayCustomMotion(self._transform, 1)
end

function MissionTips:OnDestroy()
    g_BattleClient:RemoveListener(EventType.ShowMissionTips, self, self.OnMissionTipsChange)
end

function MissionTips:OnMissionTipsChange(_, data)
    if self._battleUI:GetIsBigSpiral() then
        return
    end
    local battleGuide = BattleUtil.GetBattleGuide(data.tipsID)
    if not battleGuide  then
        return
    end
    --排除掉type1的情况
    if battleGuide.Type ~= 3 then
        return
    end

    if data.type == ShowMissionTipsType.Show or self.tipsID ~= battleGuide.ID then
        self:ShowTip(battleGuide)
    elseif data.type == ShowMissionTipsType.Change then
        self:ChangeTip(battleGuide,data)
    else
        self:PlayCustomMotion(self._transform, 1, g_BattleClient:SafeHandler(self, self.Close))
    end
end

function MissionTips:GetTipContent(ID)
    Profiler.BeginSample("GetTipContent")
    local text = UITextHelper.GetUIText(ID)
    Profiler.EndSample("GetTipContent")
    return text
end

function MissionTips:ShowTip(battleGuideData)
    self:StopAllCustomMotions(self._transform)
    if not self.isShow then
        self:SetNodeVisible(self._transform, true)
        self.isShow = true
    end
    --入场动画
    self:PlayCustomMotion(self._transform, 0)

    self.tipsID = battleGuideData.ID
    self:SetText(self.missionTitle, self:GetTipContent(battleGuideData.Headline))
    if battleGuideData.Type == 3 then
        local tempContent = self:GetTipContent(battleGuideData.Content)
        Profiler.BeginSample("ui.MissionTips string.gmatch")
        self.numberList = {}
        for text in string.gmatch(tempContent,'@%d+%.*%d*@') do
            local temp = string.gsub(text,'@','')
            local num = tonumber(temp)
            if num == nil then
                --放空的值默认是0
                num = 0
            end
            table.insert(self.numberList,num)
        end
        Profiler.EndSample("ui.MissionTips string.gmatch")
        Profiler.BeginSample("ui.MissionTips.ShowUITipsContent")
        csBattleUtil.ShowUITipsContent(self.missionText,battleGuideData.Content)
        Profiler.EndSample("ui.MissionTips.ShowUITipsContent")
    else
        self:SetText(self.missionText, self:GetTipContent(battleGuideData.Content) .. "<color=#fff497>" .. self:GetTipContent(battleGuideData.ProgressBar) .. "</color>")
    end
end

function MissionTips: ChangeTip(battleGuideData,eventData)
    self:SetText(self.missionTitle, self:GetTipContent(battleGuideData.Headline))
    if battleGuideData.Type == 3 then
        local context =  self:TipTextAnalysis(self:GetTipContent(battleGuideData.Content),eventData)
        self:SetText(self.missionText,context)
    else
        self:SetText(self.missionText, self:GetTipContent(battleGuideData.Content).. "<color=#fff497>" .. self:GetTipContent(battleGuideData.ProgressBar) .. "</color>")
    end
end

function MissionTips:TipTextAnalysis(context,eventData)
    if self.numberList == nil or #self.numberList ==0 then
        Debug.LogWarning("MissionTips 没有显示的时候就修改值！")
        return ""
    end
    if eventData.operation == 1 then
        self.numberList[eventData.slot] = self.numberList[eventData.slot] + eventData.value
    elseif eventData.operation == 2 then
        self.numberList[eventData.slot] = self.numberList[eventData.slot] - eventData.value
    elseif eventData.operation == 3 then
        self.numberList[eventData.slot] = self.numberList[eventData.slot] * eventData.value
    elseif eventData.operation == 4 then
        if eventData.value > 0 then
            self.numberList[eventData.slot] = self.numberList[eventData.slot] / eventData.value
        else
            Debug.LogError("eventData.value <= 0")
        end

    elseif eventData.operation == 5 then
        self.numberList[eventData.slot] = eventData.value
    end
    return string.format(string.gsub(context,'@%d+%.*%d*@','%%d'),table.unpack(self.numberList))
end

function MissionTips:Close()
    if self.isShow then
        self:SetNodeVisible(self._transform, false)
        self.isShow = false
        self.numberList = {}
    end
end

return MissionTips





