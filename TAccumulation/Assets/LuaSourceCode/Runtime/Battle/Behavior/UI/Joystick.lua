---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by canglan.
--- DateTime: 2021/11/18 11:04
---
local CSPointerEventData = CS.UnityEngine.EventSystems.PointerEventData

local UIBehaviorBase = require("Runtime.Battle.Behavior.UI.UIBehaviorBase")

---@class Joystick:UIBehaviorBase
local Joystick = XECS.class("Joystick", UIBehaviorBase)
Joystick.Type = BattleUIBehaviorType.Joystick

function Joystick:ctor()
    UIBehaviorBase.ctor(self)
    self._requiredUpdate = false
end

function Joystick:Awake()
    UIBehaviorBase.Awake(self)
    self._groupTrans = self:GetComponent("OCX_Group", "Transform")
    ---@type UnityEngine.Transform
    self._joystickTrans = self:GetComponent("OCX_Joystick", "Transform")
    self._joystickObj = self._joystickTrans.gameObject
    self:Register()
end

function Joystick:SetGroupActive(active)
    self:SetNodeVisible(self._joystickTrans, active)
end

function Joystick:Register()
    self:AddJoystickDownUpListener("OCX_Joystick", g_BattleClient:SafeHandler(self, self._OnJoystickDown), g_BattleClient:SafeHandler(self, self._OnJoystickUp))
    self:AddJoystickXYUpdateListener("OCX_Joystick", g_BattleClient:SafeHandler(self, self._OnJoystickDragUpdate))
end

---@param eventData UnityEngine.EventSystems.PointerEventData
function Joystick:_OnJoystickDown(eventData)
    if not self._battleUI.playerInput then
        return
    end
    self._battleUI.playerInput:BeginAxisDrag()
end

---@param eventData UnityEngine.EventSystems.PointerEventData
function Joystick:_OnJoystickUp(eventData)
    if not self._battleUI.playerInput then
        return
    end
    self._battleUI.playerInput:EndAxisDrag()
end

---@param x number
---@param y number
function Joystick:_OnJoystickDragUpdate(x, y)
    if not self._joystickObj.visibleInHierarchy then
        self._battleUI.playerInput:EndAxisDrag()
        return
    end
    if self._battleUI.playerInput then
        self._battleUI.playerInput:SetAxis(x, 0, y)
    end
    self:LogicAutoBattle(false)
end

function Joystick:Unregister()
    self:RemoveJoystickListener("OCX_Joystick")
end

function Joystick:OnDestroy()
    self:Unregister()
    self._groupTrans = nil
    self._joystickTrans = nil
    self._joystickObj = nil
    UIBehaviorBase.OnDestroy(self)
end

return Joystick